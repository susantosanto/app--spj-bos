<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si-BOS | Sistem Administrasi</title>
    <!-- Google Fonts: Outfit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --sidebar-bg: #1e3a8a;
            --bg-main: #f8fafc;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --white: #ffffff;
            --sidebar-hover: rgba(255, 255, 255, 0.1);
            --sidebar-active: rgba(255, 255, 255, 0.2);
            --border: #e2e8f0;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar Styles --- */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--sidebar-bg) 0%, #172554 100%);
            color: var(--white);
            display: flex;
            flex-direction: column;
            padding: 24px 16px;
            flex-shrink: 0;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 12px 32px 12px;
        }

        .logo-icon {
            background: var(--white);
            color: var(--sidebar-bg);
            padding: 8px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-text h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .logo-text p {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: var(--white);
            opacity: 0.8;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-item:hover {
            background: var(--sidebar-hover);
            opacity: 1;
        }

        .nav-item.active {
            background: var(--primary);
            opacity: 1;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        /* --- Custom Notification Styles --- */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 320px;
            pointer-events: auto;
            border-left: 4px solid var(--primary);
            animation: toastIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
            overflow: hidden;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.success {
            border-left-color: #10b981;
        }

        .toast-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .toast.success .toast-icon {
            background: #ecfdf5;
            color: #10b981;
        }

        .toast.error .toast-icon {
            background: #fef2f2;
            color: #ef4444;
        }

        .toast-content {
            flex-grow: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
        }

        @keyframes toastIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-out {
            animation: toastOut 0.3s ease-in forwards !important;
        }

        @keyframes toastOut {
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* --- Custom Confirm Modal --- */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 11000;
            animation: fadeIn 0.2s ease-out;
        }

        .confirm-modal {
            background: white;
            border-radius: 24px;
            padding: 32px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            animation: modalScaleUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes modalScaleUp {
            to {
                transform: scale(1);
            }
        }

        .confirm-icon {
            width: 64px;
            height: 64px;
            background: #fef2f2;
            color: #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .confirm-modal h3 {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
        }

        .confirm-modal p {
            font-size: 15px;
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .confirm-actions {
            display: flex;
            gap: 12px;
        }

        .confirm-actions button {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .confirm-btn-cancel {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .confirm-btn-cancel:hover {
            background: #e2e8f0;
        }

        .confirm-btn-ok {
            background: #ef4444;
            color: white;
            border: none;
        }

        .confirm-btn-ok:hover {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .sidebar-footer {
            padding: 12px;
            font-size: 11px;
            opacity: 0.5;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- Main Content Styles --- */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
            padding: 40px;
        }

        .view-section {
            display: none;
            animation: fadeIn 0.4s ease-out;
            max-width: 1200px;
            margin: 0 auto;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Upload View Styles --- */
        .header-center {
            text-align: center;
            margin-bottom: 48px;
        }

        .header-center h2 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1e293b;
        }

        .header-center p {
            color: var(--text-muted);
            font-size: 16px;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .upload-card {
            background: var(--white);
            border: 2px dashed #cbd5e1;
            border-radius: 20px;
            padding: 80px 40px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 60px;
            position: relative;
            overflow: hidden;
        }

        .upload-card:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.02);
            transform: scale(1.01);
        }

        .upload-icon-wrapper {
            width: 80px;
            height: 80px;
            background: #eff6ff;
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            transition: var(--transition);
        }

        .upload-card:hover .upload-icon-wrapper {
            background: var(--primary);
            color: var(--white);
        }

        .upload-card h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-card p {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #fileInput {
            display: none;
        }

        /* --- Info Cards --- */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .info-card {
            background: var(--white);
            padding: 32px 24px;
            border-radius: 16px;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }

        .info-card:hover {
            transform: translateY(-5px);
        }

        .info-card .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .info-card h4 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #1e293b;
        }

        .info-card p {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* --- Transaction View Styles --- */
        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .view-header-text h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .view-header-text p {
            color: var(--text-muted);
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .btn-danger {
            background: #ef4444;
            color: var(--white);
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        tr.hover-row:hover {
            background-color: #f8fafc;
        }

        .empty-state {
            background: var(--white);
            border: 2px dashed #e2e8f0;
            border-radius: 16px;
            padding: 100px 40px;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 48px;
            opacity: 0.2;
            margin-bottom: 16px;
        }

        /* --- Data Sekolah (Settings) Styles --- */
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }

        .settings-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
        }

        .settings-icon {
            background: #eff6ff;
            color: var(--primary);
            padding: 12px;
            border-radius: 12px;
        }

        .settings-title h3 {
            font-size: 20px;
            font-weight: 700;
        }

        .settings-title p {
            font-size: 14px;
            color: var(--text-muted);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: var(--transition);
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--white);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .btn-submit {
            grid-column: span 2;
            margin-top: 20px;
            width: 100%;
            justify-content: center;
            padding: 14px;
            font-size: 16px;
        }

        /* --- Preview Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-container {
            background: #e2e8f0;
            width: 95%;
            height: 90vh;
            border-radius: 20px;
            display: flex;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .preview-sidebar {
            width: 350px;
            background: var(--white);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            overflow-y: auto;
        }

        .preview-main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: #cbd5e1;
            position: relative;
        }

        .preview-toolbar {
            background: var(--white);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        /* --- Paper Simulation --- */
        .paper-viewport {
            flex-grow: 1;
            overflow: auto;
            padding: 40px;
            display: flex;
            justify-content: center;
        }

        .paper {
            background: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 40px;
            /* Standar Margin */
            box-sizing: border-box;
            transition: var(--transition);
            position: relative;
            transform-origin: top center;
        }

        .paper.a4 {
            width: 210mm;
            min-height: 297mm;
        }

        .paper.a5-landscape {
            width: 210mm;
            min-height: 148mm;
        }

        .paper.a5-portrait {
            width: 148mm;
            min-height: 210mm;
        }

        /* --- Print Styles --- */
        @media print {
            body * {
                visibility: hidden;
            }

            .paper,
            .paper * {
                visibility: visible;
            }

            .paper {
                position: absolute;
                left: 0;
                top: 0;
                width: 100% !important;
                box-shadow: none;
                padding: 0;
                margin: 0;
            }

            .modal-overlay {
                display: block !important;
                background: white;
            }

            .preview-sidebar,
            .preview-toolbar,
            .sidebar {
                display: none !important;
            }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .info-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-group.full-width {
                grid-column: span 1;
            }

            .btn-submit {
                grid-column: span 1;
            }
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-container">
            <div class="logo-icon">
                <i data-lucide="file-text" size="24"></i>
            </div>
            <div class="logo-text">
                <h1>Si-BOS</h1>
                <p>Sistem Administrasi</p>
            </div>
        </div>

        <div class="nav-menu">
            <a href="#" class="nav-item active" onclick="showView('upload-view', this)">
                <i data-lucide="upload-cloud" size="18"></i>
                Unggah BKU
            </a>
            <a href="#" class="nav-item" onclick="showView('manage-view', this)">
                <i data-lucide="layout-grid" size="18"></i>
                Kelola Transaksi
            </a>
            <a href="#" class="nav-item" onclick="showView('settings-view', this)">
                <i data-lucide="school" size="18"></i>
                Data Sekolah
            </a>
        </div>

        <div class="sidebar-footer">
            &copy; 2026 - Developed By <b>Santo X/Code</b>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">

        <!-- View 1: Unggah BKU -->
        <section id="upload-view" class="view-section active">
            <div class="header-center">
                <h2>Mulai Dokumentasi SPJ</h2>
                <p>Unggah file Buku Kas Umum (BKU) Anda. AI kami akan mengekstrak setiap transaksi belanja untuk
                    dibuatkan kwitansi dan kelengkapan nya otomatis.</p>
            </div>

            <div style="max-width: 600px; margin: 0 auto 60px;">
                <div class="upload-card" onclick="openDrivePicker()"
                    style="margin-bottom:0; border-style: solid; border-color: #22c55e; background: #f0fdf4; padding: 60px 40px;">
                    <div class="upload-icon-wrapper"
                        style="background: #22c55e; color: white; width: 80px; height: 80px;">
                        <i data-lucide="hard-drive" size="40"></i>
                    </div>
                    <h3 style="color: #166534; font-size: 24px;">Unggah File dari Google Drive</h3>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <div class="icon-box" style="background: rgba(249, 115, 22, 0.1); color: #f97316;">
                        <i data-lucide="file-search" size="24"></i>
                    </div>
                    <h4>Ekstraksi Pintar</h4>
                    <p>Secara otomatis mengenali toko, jumlah, dan jenis belanja sekolah.</p>
                </div>
                <div class="info-card">
                    <div class="icon-box" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
                        <i data-lucide="printer" size="24"></i>
                    </div>
                    <h4>Siap Cetak</h4>
                    <p>Kwitansi dan Nota diformat sesuai standar pelaporan Dana BOS.</p>
                </div>
                <div class="info-card">
                    <div class="icon-box" style="background: rgba(168, 85, 247, 0.1); color: #a855f7;">
                        <i data-lucide="check-circle" size="24"></i>
                    </div>
                    <h4>Akurat & Cepat</h4>
                    <p>Mengurangi kesalahan penulisan angka dan terbilang secara manual.</p>
                </div>
            </div>
        </section>

        <!-- View 2: Kelola Transaksi -->
        <section id="manage-view" class="view-section">
            <div class="view-header">
                <div class="view-header-text">
                    <h2>Kelola Transaksi BKU</h2>
                    <p id="extractionInfo">Daftar pengeluaran yang terdeteksi. Silakan periksa dan cetak dokumen.</p>
                </div>
                <button class="btn-primary" onclick="openAddModal()">
                    <i data-lucide="plus" size="18"></i>
                    Tambah Manual
                </button>
            </div>

            <div id="emptyState" class="empty-state">
                <div class="empty-icon">
                    <i data-lucide="alert-circle" size="64"></i>
                </div>
                <p>Belum ada data. Silakan unggah file BKU atau tambah manual.</p>
                <div style="margin-top: 20px;">
                    <button class="btn-primary" style="margin: 0 auto;" onclick="openPreview()">Demo Preview</button>
                </div>
            </div>

            <div id="transactionTableContainer" style="display: none;">
                <table
                    style="width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--card-shadow);">
                    <thead>
                        <tr style="background: #f1f5f9; text-align: left;">
                            <th style="padding: 16px; font-size: 13px;">Tanggal</th>
                            <th style="padding: 16px; font-size: 13px;">No Bukti</th>
                            <th style="padding: 16px; font-size: 13px;">Uraian</th>
                            <th style="padding: 16px; font-size: 13px;">Jumlah</th>
                            <th style="padding: 16px; font-size: 13px;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTbody">
                        <!-- Items injected via JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- View 3: Data Sekolah -->
        <section id="settings-view" class="view-section">
            <div class="settings-container">
                <div class="settings-header">
                    <div class="settings-icon">
                        <i data-lucide="school" size="32"></i>
                    </div>
                    <div class="settings-title">
                        <h3>Konfigurasi Sekolah</h3>
                        <p>Sesuaikan informasi sekolah untuk kop surat & tanda tangan.</p>
                    </div>
                </div>

                <form id="schoolForm">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Nama Sekolah</label>
                            <input type="text" id="schoolName" name="schoolName"
                                placeholder="Contoh: SD NEGERI 01 CONTOH">
                        </div>
                        <div class="form-group full-width">
                            <label>Alamat Lengkap</label>
                            <input type="text" id="schoolAddress" name="schoolAddress"
                                placeholder="Jl. Pendidikan No. 123">
                        </div>
                        <div class="form-group">
                            <label>NPSN</label>
                            <input type="text" id="npsn" name="npsn" placeholder="12345678">
                        </div>
                        <div class="form-group">
                            <label>Kecamatan</label>
                            <input type="text" id="kecamatan" name="kecamatan" placeholder="Contoh: Kec. Ilmu">
                        </div>
                        <div class="form-group">
                            <label>Nama Kepala Sekolah</label>
                            <input type="text" id="principalName" name="principalName"
                                placeholder="Nama Lengkap & Gelar">
                        </div>
                        <div class="form-group">
                            <label>NIP Kepala Sekolah</label>
                            <input type="text" id="principalNip" name="principalNip"
                                placeholder="19XXXXXXXX XXXXXX X XXX">
                        </div>
                        <div class="form-group">
                            <label>Nama Bendahara</label>
                            <input type="text" id="treasurerName" name="treasurerName"
                                placeholder="Nama Lengkap & Gelar">
                        </div>
                        <div class="form-group">
                            <label>NIP Bendahara</label>
                            <input type="text" id="treasurerNip" name="treasurerNip"
                                placeholder="19XXXXXXXX XXXXXX X XXX">
                        </div>

                        <button type="button" class="btn-primary btn-submit" onclick="saveData()">
                            <i data-lucide="save" size="18"></i>
                            Simpan Perubahan
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Preview Modal -->
        <div id="previewModal" class="modal-overlay">
            <div class="modal-container">
                <div class="preview-sidebar">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h3 style="font-size: 18px; font-weight: 700;">Customizer</h3>
                        <button onclick="closePreview()"
                            style="background:none; border:none; cursor:pointer; color: var(--text-muted);">
                            <i data-lucide="x" size="20"></i>
                        </button>
                    </div>




                    <div class="form-group">
                        <label>Jenis Dokumen</label>
                        <select id="docType" onchange="handleDocTypeChange()"
                            style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                            <option value="kwitansi">Kwitansi SPJ</option>
                            <option value="nota">Nota Toko / Invoice</option>
                            <option value="pesanan">Surat Pesanan (Formal)</option>
                            <option value="berita_acara">Berita Acara Serah Terima</option>
                            <option value="undangan">Surat Undangan</option>
                            <option value="notulen">Notulen Kegiatan</option>
                            <option value="daftar_hadir">Daftar Hadir</option>
                            <option value="dokumentasi">Lembar Dokumentasi</option>
                            <option value="rencana">Dokumen Perencanaan</option>
                            <option value="spk">Surat Perintah Kerja (SPK)</option>
                        </select>
                    </div>

                    <div class="form-group" id="fg-nomor">
                        <label>Nomor Surat / Berita Acara / SPK</label>
                        <input type="text" id="custNomorSurat" oninput="updatePreview()"
                            placeholder="Contoh: 001/SD/2025">
                    </div>

                    <div class="form-group" id="fg-perihal">
                        <label>Perihal / Subject</label>
                        <input type="text" id="custPerihal" oninput="updatePreview()"
                            placeholder="Contoh: Undangan Lomba">
                    </div>

                    <div class="form-group" id="fg-vendor-style">
                        <label>Template Vendor</label>
                        <select id="vendorStyle" onchange="updatePreview()"
                            style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                            <option value="standard">Standard / Modern</option>
                            <option value="rm-family">RM Family (Landscape)</option>
                            <option value="cahya-cellular">Cahya Cellular (Blue)</option>
                            <option value="media-komputer">Media Komputer (Media)</option>
                            <option value="mitra-photocopy">Mitra Photocopy (Service)</option>
                            <option value="sinar-abadi">Sinar Abadi (Classic Red)</option>
                        </select>
                    </div>

                    <div class="form-group" id="fg-vendor-name">
                        <label>Nama Vendor / Toko / Penerima</label>
                        <input type="text" id="custVendorName" oninput="updatePreview()" placeholder="NAMA TOKO">
                    </div>

                    <div class="form-group" id="fg-uraian">
                        <label>Uraian Belanja / Kegiatan</label>
                        <textarea id="custUraian" oninput="updatePreview()" rows="3"
                            style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></textarea>
                    </div>

                    <div class="form-group" id="fg-jumlah">
                        <label>Nominal / Anggaran / Total (Rp)</label>
                        <input type="number" id="custJumlah" oninput="updatePreview()">
                    </div>

                    <!-- Extra Fields for Rencana -->
                    <div id="rencanaExtraSection"
                        style="display: none; border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
                        <label style="font-weight: bold; font-size: 14px; margin-bottom: 10px; display: block;">Detail
                            Perencanaan</label>
                        <div class="form-group">
                            <label>Kategori Barang/Jasa</label>
                            <input type="text" id="custKategori" oninput="updatePreview()"
                                placeholder="Contoh: Pemeliharaan Laptop Sekolah">
                        </div>
                        <div class="form-group">
                            <label>Jumlah Barang/Jasa (Teks)</label>
                            <input type="text" id="custJumlahBarang" oninput="updatePreview()"
                                placeholder="Contoh: 1 (Satu) Paket">
                        </div>
                        <div class="form-group">
                            <label>Spesifikasi / Ruang Lingkup</label>
                            <textarea id="custSpesifikasi" oninput="updatePreview()" rows="2"
                                style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;"
                                placeholder="Contoh: Belanja Jasa Service Laptop"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Persyaratan Penyedia</label>
                            <textarea id="custPersyaratan" oninput="updatePreview()" rows="3"
                                style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;">Perorangan/Badan Usaha Memenuhi syarat sebagai berikut:\na. Identitas Penyedia;</textarea>
                        </div>
                    </div>

                    <!-- Extra Fields for SPK -->
                    <div id="spkExtraSection"
                        style="display: none; border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
                        <label style="font-weight: bold; font-size: 14px; margin-bottom: 10px; display: block;">Detail
                            SPK</label>
                        <div class="form-group">
                            <label>Tanggal Negosiasi</label>
                            <input type="text" id="custTglNegosiasi" oninput="updatePreview()" placeholder="dd/mm/yyyy">
                        </div>
                        <div class="form-group">
                            <label>Waktu Pelaksanaan</label>
                            <input type="text" id="custWaktuPelaksanaan" oninput="updatePreview()"
                                placeholder="dd/mm/yyyy (Default: Tanggal Transaksi)">
                        </div>
                        <div class="form-group">
                            <label>Waktu Penyelesaian</label>
                            <input type="text" id="custWaktuPenyelesaian" oninput="updatePreview()"
                                placeholder="Contoh: 06 Juni 2025">
                        </div>
                        <div class="form-group">
                            <label>Instruksi ke Penyedia</label>
                            <textarea id="custInstruksi" oninput="updatePreview()" rows="3"
                                style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;">Penagihan hanya dapat dilakukan setelah penyelesaian pekerjaan yang diperintahkan dalam SPK ini dan dibuktikan dengan Berita Acara Serah Terima.</textarea>
                        </div>
                    </div>

                    <!-- Dynamic Items for Nota -->
                    <div id="notaItemsSection"
                        style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; display: none;">
                        <label style="font-weight: bold; font-size: 14px; margin-bottom: 10px; display: block;">Rincian
                            Barang (Khusus Nota)</label>
                        <div id="notaItemsList" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Items will be added here -->
                        </div>
                        <button onclick="addNotaItem()" class="btn-primary"
                            style="margin-top: 10px; padding: 5px 10px; font-size: 12px; background: #22c55e;">
                            <i data-lucide="plus" size="14"></i> Tambah Item
                        </button>
                    </div>

                    <!-- Documentation Section -->
                    <div id="documentationSection"
                        style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; display: none;">
                        <label style="font-weight: bold; font-size: 14px; margin-bottom: 10px; display: block;">Foto
                            Kegiatan</label>
                        <input type="file" onchange="handleDocPhotoUpload(this)" accept="image/*"
                            style="font-size: 12px;">
                        <div style="margin-top: 10px; font-size: 11px; color: #666;">Silakan upload foto dokumentasi
                            kegiatan.</div>
                    </div>

                    <!-- Notulen Section -->
                    <div id="notulenSection"
                        style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; display: none;">
                        <div class="form-group">
                            <label>Waktu Kegiatan</label>
                            <input type="text" id="custWaktu" oninput="updatePreview()"
                                placeholder="Contoh: 08.00 - 10.00 WIB">
                        </div>
                        <div class="form-group">
                            <label>Hasil Pembahasan (Pisahkan dengan Enter)</label>
                            <textarea id="custHasil" oninput="updatePreview()" rows="5"
                                placeholder="1. Poin satu&#10;2. Poin dua"
                                style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Kesimpulan</label>
                            <textarea id="custKesimpulan" oninput="updatePreview()" rows="3"
                                placeholder="Kesimpulan rapat..."
                                style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></textarea>
                        </div>
                    </div>

                    <!-- Attendance Section -->
                    <div id="attendanceSection"
                        style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; display: none;">
                        <label style="font-weight: bold; font-size: 14px; margin-bottom: 5px; display: block;">Daftar
                            Hadir</label>
                        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                            <button onclick="addAttendanceRow()" class="btn-primary"
                                style="flex:1; padding: 5px; font-size: 11px; background: #22c55e;">
                                <i data-lucide="plus" size="12"></i> Baris
                            </button>
                            <button onclick="loadDefaultAttendance()" class="btn-primary"
                                style="flex:1; padding: 5px; font-size: 11px; background: #3b82f6;">
                                <i data-lucide="users" size="12"></i> Load Guru
                            </button>
                        </div>
                        <div id="attendanceList" style="display: flex; flex-direction: column; gap: 5px;"></div>
                    </div>



                    <div class="form-group" id="fg-tanggal">
                        <label>Tanggal Transaksi / BAST / SPK / Serah Terima</label>
                        <input type="text" id="custTanggal" oninput="updatePreview()" placeholder="dd/mm/yyyy">
                    </div>

                    <div class="form-group" id="fg-tanggal-pesan">
                        <label>Tanggal Surat / Pesan</label>
                        <input type="text" id="custTanggalPesan" oninput="updatePreview()" placeholder="dd/mm/yyyy">
                    </div>

                    <div class="form-group" id="fg-tanggal-kegiatan">
                        <label>Tanggal Kegiatan</label>
                        <input type="text" id="custTanggalKegiatan" oninput="updatePreview()" placeholder="dd/mm/yyyy">
                    </div>

                    <div class="form-group" id="fg-tempat">
                        <label>Tempat Kegiatan / Lokasi</label>
                        <input type="text" id="custTempatKegiatan" oninput="updatePreview()"
                            placeholder="Contoh: SD Negeri 1 ...">
                    </div>

                    <div class="form-group" id="fg-waktu-kegiatan">
                        <label>Waktu Kegiatan</label>
                        <input type="text" id="custWaktuKegiatan" oninput="updatePreview()"
                            placeholder="Contoh: 08.00 sd Selesai">
                    </div>

                    <div class="form-group" id="fg-vendor-address">
                        <label>Alamat Vendor / Toko</label>
                        <input type="text" id="custVendorAddress" oninput="updatePreview()" placeholder="Alamat Toko">
                    </div>

                    <div class="form-group" id="fg-tembusan">
                        <label>Tembusan (Opsional)</label>
                        <textarea id="custTembusan" oninput="updatePreview()" rows="2"
                            style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;"
                            placeholder="1. Pengawas...&#10;2. K3S..."></textarea>
                    </div>

                    <div class="form-group" id="fg-uploads">
                        <label>Logo & Stempel Toko (Nota Only)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="file" accept="image/*" onchange="handleLogoUpload(this)"
                                style="font-size: 11px;">
                            <input type="file" accept="image/*" onchange="handleStampUpload(this)"
                                style="font-size: 11px;">
                        </div>
                    </div>

                    <div style="margin-top: auto;">
                        <label>Layout</label>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="changeLayout('portrait')" style="flex:1; padding:8px; font-size:12px;"
                                class="btn-primary">Portrait</button>
                            <button onclick="changeLayout('landscape')" style="flex:1; padding:8px; font-size:12px;"
                                class="btn-primary">Landscape</button>
                        </div>
                    </div>
                </div>

                <div class="preview-main">
                    <div class="preview-toolbar">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="range" min="30" max="150" value="80" oninput="zoomPreview(this.value)">
                            <span id="zoomLevel" style="font-size: 13px; font-weight: 500;">Scale: 80%</span>
                        </div>
                        <button class="btn-primary" onclick="window.print()">
                            <i data-lucide="printer" size="18"></i>
                            Cetak Dokumen
                        </button>
                    </div>

                    <div class="paper-viewport">
                        <div id="paper" class="paper a4">
                            <div id="paperContent">
                                <!-- Konten Dokumen Dinamis -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Manual Transaction Modal -->
        <div id="addModal" class="modal-overlay">
            <div class="modal-container" style="max-width: 500px; height: auto; flex-direction: column; padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 20px; font-weight: 700;">Tambah Transaksi Manual</h3>
                    <button onclick="closeAddModal()" style="background:none; border:none; cursor:pointer;">
                        <i data-lucide="x" size="20"></i>
                    </button>
                </div>

                <div class="form-group">
                    <label>Tanggal</label>
                    <input type="date" id="addDate">
                </div>
                <div class="form-group">
                    <label>No Bukti</label>
                    <input type="text" id="addNoBukti" placeholder="Contoh: BKU-001">
                </div>
                <div class="form-group">
                    <label>Uraian Belanja</label>
                    <input type="text" id="addUraian" placeholder="Contoh: Belanja ATK Kegiatan...">
                </div>
                <div class="form-group">
                    <label>Penerima / Toko</label>
                    <input type="text" id="addPenerima" placeholder="Contoh: Toko Abadi">
                </div>
                <div class="form-group">
                    <label>Jumlah (Rp)</label>
                    <input type="number" id="addJumlah" placeholder="0">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-primary" style="background: #64748b; flex: 1;" onclick="closeAddModal()">
                        Batal
                    </button>
                    <button class="btn-primary" style="flex: 1;" onclick="saveManualTransaction()">
                        <i data-lucide="save" size="18"></i>
                        Simpan
                    </button>
                </div>
            </div>
        </div>

        <!-- Drive Picker Modal -->
        <div id="driveModal" class="modal-overlay">
            <div class="modal-container"
                style="max-width: 600px; height: 500px; flex-direction: column; padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 20px; font-weight: 700;">File BKU di Google Drive</h3>
                    <button onclick="closeDrivePicker()" style="background:none; border:none; cursor:pointer;">
                        <i data-lucide="x" size="20"></i>
                    </button>
                </div>
                <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 20px;">Menampilkan file PDF terbaru
                    yang mengandung kata "BKU" di Drive Anda.</p>

                <div id="driveFileList"
                    style="flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i data-lucide="loader-2" class="spin" size="32" style="margin-bottom: 10px;"></i>
                        <p>Mencari file...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Custom Confirm Modal -->
    <div id="confirmOverlay" class="confirm-overlay">
        <div class="confirm-modal">
            <div class="confirm-icon">
                <i data-lucide="alert-triangle" size="32"></i>
            </div>
            <h3 id="confirmTitle">Konfirmasi Hapus</h3>
            <p id="confirmMessage">Apakah Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="confirm-actions">
                <button class="confirm-btn-cancel" onclick="closeConfirm(false)">Batal</button>
                <button class="confirm-btn-ok" onclick="closeConfirm(true)">Hapus Data</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        // Load Initial Data
        window.addEventListener('load', () => {
            google.script.run
                .withSuccessHandler((data) => {
                    if (data) {
                        document.getElementById('schoolName').value = data.schoolName || '';
                        document.getElementById('schoolAddress').value = data.schoolAddress || '';
                        document.getElementById('npsn').value = data.npsn || '';
                        document.getElementById('kecamatan').value = data.kecamatan || '';
                        document.getElementById('principalName').value = data.principalName || '';
                        document.getElementById('principalNip').value = data.principalNip || '';
                        document.getElementById('treasurerName').value = data.treasurerName || '';
                        document.getElementById('treasurerNip').value = data.treasurerNip || '';
                    }
                })
                .getSchoolData();


        });

        // View Navigation Logic
        function showView(viewId, element) {
            // Remove active class from all sections
            const sections = document.querySelectorAll('.view-section');
            sections.forEach(sec => sec.classList.remove('active'));

            // Show target section
            document.getElementById(viewId).classList.add('active');

            // Update sidebar UI
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            element.classList.add('active');

            // Refresh icons in case any were hidden
            lucide.createIcons();
        }

        // --- Document Generation Logic ---
        let currentScale = 0.8;
        let currentLayout = 'portrait';
        let logoBase64 = null;
        let stampBase64 = null;
        // let availableTemplates = []; // Removed
        // let cachedTemplateHtml = ""; // Removed
        // let currentTemplateId = ""; // Removed
        let logoKBBBase64 = null;
        let docPhotoBase64 = null;

        // Load KBB Logo on start
        window.addEventListener('load', () => {
            google.script.run.withSuccessHandler(res => {
                if (res) logoKBBBase64 = res;
            }).getLogoKBB();
        });

        // Fungsi Terbilang untuk Rupiah
        function terbilang(nilai) {
            nilai = Math.abs(nilai);
            var simpanNilaiBagi = 0;
            var huruf = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
            var temp = "";

            if (nilai < 12) {
                temp = " " + huruf[nilai];
            } else if (nilai < 20) {
                temp = terbilang(nilai - 10) + " Belas";
            } else if (nilai < 100) {
                simpanNilaiBagi = Math.floor(nilai / 10);
                temp = terbilang(simpanNilaiBagi) + " Puluh" + terbilang(nilai % 10);
            } else if (nilai < 200) {
                temp = " Seratus" + terbilang(nilai - 100);
            } else if (nilai < 1000) {
                simpanNilaiBagi = Math.floor(nilai / 100);
                temp = terbilang(simpanNilaiBagi) + " Ratus" + terbilang(nilai % 100);
            } else if (nilai < 2000) {
                temp = " Seribu" + terbilang(nilai - 1000);
            } else if (nilai < 1000000) {
                simpanNilaiBagi = Math.floor(nilai / 1000);
                temp = terbilang(simpanNilaiBagi) + " Ribu" + terbilang(nilai % 1000);
            } else if (nilai < 1000000000) {
                simpanNilaiBagi = Math.floor(nilai / 1000000);
                temp = terbilang(simpanNilaiBagi) + " Juta" + terbilang(nilai % 1000000);
            }
            return temp;
        }

        // Helper untuk format tanggal teks (Contoh: Senin, 20 Mei 2025)
        function getDateText(dateStr) {
            // Asumsi format dd/mm/yyyy
            const parts = dateStr.split('/');
            if (parts.length !== 3) return { dayName: '...', fullDate: dateStr };

            const d = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

            const dayName = days[d.getDay()];
            return { dayName: dayName, fullDate: `${parts[0]} ${months[parseInt(parts[1]) - 1]} ${parts[2]}` };
        }

        function openPreview() {
            // Initialize customizer with global school data
            // These fields now directly pull from the settings form, no need for separate cust inputs
            // document.getElementById('custSchoolName').value = document.getElementById('schoolName').value || "SD NEGERI 01 CONTOH";
            // document.getElementById('custKecamatan').value = document.getElementById('kecamatan').value || "Cikalongwetan";
            // document.getElementById('custSchoolAddress').value = document.getElementById('schoolAddress').value || "Jl. Pendidikan No. 123";
            // document.getElementById('custPrincipalName').value = document.getElementById('principalName').value || "NAMA KEPALA SEKOLAH";
            // document.getElementById('custPrincipalNip').value = document.getElementById('principalNip').value || "19XXXXXXXX XXXXXX X XXX";

            document.getElementById('custPerihal').value = "Permohonan Belanja";
            document.getElementById('custTempatKegiatan').value = document.getElementById('schoolName').value || "Sekolah";
            document.getElementById('custWaktuKegiatan').value = "08.00 sd Selesai";
            document.getElementById('custTembusan').value = "1. Pengawas Pembina\n2. Arsip";

            document.getElementById('previewModal').style.display = 'flex';
            updatePreview();
            lucide.createIcons();
        }

        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }

        function zoomPreview(val) {
            currentScale = val / 100;
            document.getElementById('paper').style.transform = `scale(${currentScale})`;
            document.getElementById('zoomLevel').innerText = `Scale: ${val}%`;
        }

        function changeLayout(layout) {
            currentLayout = layout;
            const paper = document.getElementById('paper');
            if (layout === 'landscape') {
                paper.className = 'paper a5-landscape';
            } else {
                paper.className = 'paper a4';
            }
            updatePreview();
        }

        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    logoBase64 = e.target.result;
                    updatePreview();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleStampUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    stampBase64 = e.target.result;
                    updatePreview();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleDocPhotoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    docPhotoBase64 = e.target.result;
                    updatePreview();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleDocTypeChange() {
            const docType = document.getElementById('docType').value;
            const notaSection = document.getElementById('notaItemsSection');
            const notulenSection = document.getElementById('notulenSection');
            const attendanceSection = document.getElementById('attendanceSection');
            const documentationSection = document.getElementById('documentationSection');
            const rencanaSection = document.getElementById('rencanaExtraSection');
            const spkSection = document.getElementById('spkExtraSection');

            // Hide all special sections
            notaSection.style.display = 'none';
            notulenSection.style.display = 'none';
            attendanceSection.style.display = 'none';
            documentationSection.style.display = 'none';
            rencanaSection.style.display = 'none';
            spkSection.style.display = 'none';

            // Reset visibility of all grouped fields first
            ['fg-nomor', 'fg-perihal', 'fg-vendor-style', 'fg-vendor-name', 'fg-uraian', 'fg-jumlah',
                'fg-tanggal', 'fg-tanggal-pesan', 'fg-tanggal-kegiatan', 'fg-tempat', 'fg-waktu-kegiatan',
                'fg-vendor-address', 'fg-tembusan', 'fg-uploads'].forEach(id => {
                    document.getElementById(id).style.display = 'none';
                });

            // Helper to show specific fields
            const showFields = (ids) => ids.forEach(id => document.getElementById(id).style.display = 'block');

            if (docType === 'kwitansi') {
                showFields(['fg-nomor', 'fg-uraian', 'fg-jumlah', 'fg-tanggal', 'fg-vendor-name']); // Vendor Name used as Penerima
            } else if (docType === 'nota') {
                showFields(['fg-vendor-style', 'fg-vendor-name', 'fg-uraian', 'fg-jumlah', 'fg-tanggal', 'fg-vendor-address', 'fg-uploads']);
                notaSection.style.display = 'block';
                if (document.getElementById('notaItemsList').children.length === 0) {
                    addNotaItem();
                }
            } else if (docType === 'pesanan') {
                showFields(['fg-nomor', 'fg-perihal', 'fg-vendor-name', 'fg-uraian', 'fg-tanggal-pesan', 'fg-tanggal-kegiatan']);
            } else if (docType === 'berita_acara') {
                showFields(['fg-nomor', 'fg-vendor-name', 'fg-uraian', 'fg-jumlah', 'fg-tanggal', 'fg-vendor-address']);
            } else if (docType === 'undangan') {
                showFields(['fg-nomor', 'fg-perihal', 'fg-uraian', 'fg-tanggal-pesan', 'fg-tanggal-kegiatan', 'fg-tempat', 'fg-waktu-kegiatan', 'fg-tembusan']);
            } else if (docType === 'notulen') {
                showFields(['fg-uraian', 'fg-tanggal']);
                notulenSection.style.display = 'block';
            } else if (docType === 'daftar_hadir') {
                showFields(['fg-uraian']);
                attendanceSection.style.display = 'block';
                if (document.getElementById('attendanceList').children.length === 0) {
                    loadDefaultAttendance();
                }
            } else if (docType === 'dokumentasi') {
                showFields(['fg-uraian', 'fg-tanggal']);
                documentationSection.style.display = 'block';
            } else if (docType === 'rencana') {
                showFields(['fg-uraian', 'fg-tanggal', 'fg-tempat', 'fg-jumlah']); // Uraian (Base), Tanggal (Serah), Tempat (Lokasi), Jumlah (Anggaran)
                rencanaSection.style.display = 'block';
            } else if (docType === 'spk') {
                showFields(['fg-nomor', 'fg-tanggal', 'fg-vendor-name', 'fg-uraian', 'fg-jumlah']);
                spkSection.style.display = 'block';
                notaSection.style.display = 'block'; // SPK uses the items table
            }
            updatePreview();
        }

        function addAttendanceRow(nama = "", jabatan = "") {
            const list = document.getElementById('attendanceList');
            const div = document.createElement('div');
            div.className = 'attendance-row';
            div.style = 'display: grid; grid-template-columns: 1fr 1fr 30px; gap: 5px; align-items: center;';
            div.innerHTML = `
                <input type="text" placeholder="Nama" value="${nama}" oninput="updatePreview()" style="padding: 5px; font-size: 11px;">
                <input type="text" placeholder="Jabatan" value="${jabatan}" oninput="updatePreview()" style="padding: 5px; font-size: 11px;">
                <button onclick="this.parentElement.remove(); updatePreview();" style="border:none; background:none; color:red; cursor:pointer;"><i data-lucide="trash-2" size="12"></i></button>
            `;
            list.appendChild(div);
            lucide.createIcons();
        }

        function loadDefaultAttendance() {
            const list = document.getElementById('attendanceList');
            list.innerHTML = "";
            const teachers = [
                { n: "Yuniarti, S.Pd", j: "Kepala Sekolah" },
                { n: "Ahmad, S.Pd", j: "Guru Kelas" },
                { n: "Deni Mulyani, S.Pd", j: "Guru Kelas" },
                { n: "Siti Aisah Nur Fitri", j: "Guru Kelas" },
                { n: "Sarah Siti Nuryati", j: "Guru Kelas" },
                { n: "Rinda Sri Agung Wahyuni, S.Pd", j: "Guru Kelas" },
                { n: "Fika Agustina, S,Pd", j: "Guru Kelas" },
                { n: "NurAsiah, S.Pd", j: "Guru PAI" },
                { n: "Meytha Murty", j: "Guru Kelas" },
                { n: "Vani, S.Pd", j: "Guru Kelas" }
            ];
            teachers.forEach(t => addAttendanceRow(t.n, t.j));
            updatePreview();
        }

        function addNotaItem(nama = "", qty = 1, harga = 0) {
            const list = document.getElementById('notaItemsList');
            const div = document.createElement('div');
            div.className = 'nota-item-row';
            div.style = 'display: grid; grid-template-columns: 1fr 50px 100px 30px; gap: 5px; align-items: center;';
            div.innerHTML = `
                <input type="text" placeholder="Nama Barang" value="${nama}" oninput="updatePreview()" style="padding: 5px; font-size: 12px;">
                <input type="number" placeholder="Qty" value="${qty}" oninput="updatePreview()" style="padding: 5px; font-size: 12px;">
                <input type="number" placeholder="Harga" value="${harga}" oninput="updatePreview()" style="padding: 5px; font-size: 12px;">
                <button onclick="this.parentElement.remove(); updatePreview();" style="border:none; background:none; color:red; cursor:pointer;"><i data-lucide="trash-2" size="14"></i></button>
            `;
            list.appendChild(div);
            lucide.createIcons();
        }

        function updatePreview() {

            const docType = document.getElementById('docType').value;
            const vendorStyle = document.getElementById('vendorStyle').value;
            const vendorName = document.getElementById('custVendorName').value || "TOKO SUMBER JAYA";
            const vendorAddress = document.getElementById('custVendorAddress').value || "Jl. Raya KM 10, Kota Pendidikan";
            const uraian = document.getElementById('custUraian').value || "Belanja Barang Jasa";
            const jumlah = parseFloat(document.getElementById('custJumlah').value) || 0;
            const tanggal = document.getElementById('custTanggal').value || "01/01/2025";
            const nomorSurat = document.getElementById('custNomorSurat').value || "020/SD-BOS/2025";
            const tanggalPesan = document.getElementById('custTanggalPesan').value || tanggal;
            const tanggalKegiatan = document.getElementById('custTanggalKegiatan').value || tanggal;

            const terbilangText = terbilang(jumlah) + " Rupiah";
            const dateInfo = getDateText(tanggal);
            const datePesanInfo = getDateText(tanggalPesan);
            const dateKegiatanInfo = getDateText(tanggalKegiatan);

            // Versi Uraian Bersih (Hanya Nama Kegiatan) untuk Surat Pesanan & Undangan
            const cleanUraian = uraian.replace(/^(Belanja )?Konsumsi \((Makan & Snack|Makan|Snack)\) /i, "")
                .replace(/^Konsumsi \((Makan & Snack|Makan|Snack)\) /i, "");

            const schoolData = {
                name: document.getElementById('schoolName').value || "SD NEGERI 01 CONTOH",
                address: document.getElementById('schoolAddress').value || "Jl. Pendidikan No. 123",
                kecamatan: document.getElementById('kecamatan').value || "Cikalongwetan",
                npsn: document.getElementById('npsn').value || "12345678",
                principal: document.getElementById('principalName').value || "NAMA KEPALA SEKOLAH",
                principalNip: document.getElementById('principalNip').value || "19XXXXXXXX XXXXXX X XXX",
                treasurer: document.getElementById('treasurerName').value || "NAMA BENDAHARA",
                treasurerNip: document.getElementById('treasurerNip').value || "19XXXXXXXX XXXXXX X XXX"
            };

            const perihal = document.getElementById('custPerihal').value || "Surat Pesanan";
            const tempatKegiatan = document.getElementById('custTempatKegiatan').value || "Sekolah";
            const waktuKegiatan = document.getElementById('custWaktuKegiatan').value || "08.00 sd Selesai";
            const tembusan = document.getElementById('custTembusan').value || "";

            let html = '';

            // --- TEMPLATE KOP SURAT SEKOLAH ---
            const schoolKop = `
                <div style="display: flex; align-items: center; border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 20px; font-family: 'Times New Roman', serif;">
                    <div style="width: 80px;">
                        ${logoKBBBase64 ? `<img src="${logoKBBBase64}" style="width: 70px;">` : ''}
                    </div>
                    <div style="flex-grow: 1; text-align: center; margin-right: 80px;">
                        <h3 style="margin:0; font-size: 16px; text-transform: uppercase;">PEMERINTAH KABUPATEN BANDUNG BARAT</h3>
                        <h3 style="margin:0; font-size: 16px; text-transform: uppercase;">DINAS PENDIDIKAN</h3>
                        <h2 style="margin:0; font-size: 18px; text-transform: uppercase; font-weight: bold;">${schoolData.name}</h2>
                        <h3 style="margin:0; font-size: 14px; text-transform: uppercase;">KECAMATAN ${schoolData.kecamatan}</h3>
                        <p style="margin:0; font-size: 11px; font-style: italic;">${schoolData.address} - Kabupaten Bandung Barat</p>
                    </div>
                </div>
            `;

            if (docType === 'nota') {
                // Get manual items if any
                const itemRows = document.querySelectorAll('.nota-item-row');
                let itemsHtml = '';
                let totalManual = 0;

                if (itemRows.length > 0) {
                    itemRows.forEach((row, index) => {
                        const inputs = row.querySelectorAll('input');
                        const name = inputs[0].value || "-";
                        const qty = parseFloat(inputs[1].value) || 0;
                        const price = parseFloat(inputs[2].value) || 0;
                        const sub = qty * price;
                        totalManual += sub;

                        itemsHtml += `
                            <tr style="height: 25px; border-bottom: 1px solid #000;">
                                <td style="border-right: 2px solid #000; padding: 0 8px;">${name}</td>
                                <td style="border-right: 2px solid #000; text-align: center; width: 60px;">${qty}</td>
                                <td style="border-right: 2px solid #000; text-align: right; padding-right: 8px; width: 100px;">${price.toLocaleString('id-ID')}</td>
                                <td style="text-align: right; padding-right: 8px; width: 120px;">${sub.toLocaleString('id-ID')}</td>
                            </tr>
                        `;
                    });

                    // Fill remaining empty rows (up to 12)
                    const remaining = 12 - itemRows.length;
                    for (let i = 0; i < remaining; i++) {
                        itemsHtml += `<tr style="height: 25px; border-bottom: 1px solid #000;"><td style="border-right: 2px solid #000;"></td><td style="border-right: 2px solid #000;"></td><td style="border-right: 2px solid #000;"></td><td></td></tr>`;
                    }
                } else {
                    // Default fallback
                    itemsHtml = `
                        <tr style="height: 25px; border-bottom: 1px solid #000;">
                            <td style="border-right: 2px solid #000; padding: 0 8px;">${uraian}</td>
                            <td style="border-right: 2px solid #000; text-align: center; width: 60px;">1</td>
                            <td style="border-right: 2px solid #000; text-align: right; padding-right: 8px; width: 100px;">${jumlah.toLocaleString('id-ID')}</td>
                            <td style="text-align: right; padding-right: 8px; width: 120px;">${jumlah.toLocaleString('id-ID')}</td>
                        </tr>
                    ` + Array(11).fill('<tr style="height: 25px; border-bottom: 1px solid #000;"><td style="border-right: 2px solid #000;"></td><td style="border-right: 2px solid #000;"></td><td style="border-right: 2px solid #000;"></td><td></td></tr>').join('');
                }

                if (vendorStyle === 'rm-family') {
                    // --- LAYOUT NOTA RM FAMILY (Landscape / Classic) ---
                    html = `
                        <div style="font-family: 'Arial Narrow', Arial, sans-serif; color: #000; border: 2px solid #000; padding: 20px; background: #fff; width: 100%;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="text-align: center; width: 350px;">
                                    <h2 style="margin:0; font-size: 18px; font-weight: bold; letter-spacing: 1px;">RUMAH MAKAN</h2>
                                    <h1 style="margin:0; font-size: 42px; font-family: 'Arial Black', sans-serif; line-height: 1;">"RM. FAMILY"</h1>
                                    <p style="margin:5px 0 0 0; font-size: 11px; font-weight: bold;">${vendorAddress}</p>
                                </div>
                                <div style="width: 250px; font-size: 13px;">
                                    <table style="width: 100%;">
                                        <tr><td style="width: 60px;">Bapak/Ibu</td><td style="border-bottom: 2px solid #000;">: ${schoolData.name.substring(0, 25)}</td></tr>
                                        <tr><td colspan="2" style="border-bottom: 2px solid #000; height: 15px;"></td></tr>
                                        <tr><td colspan="2" style="border-bottom: 2px solid #000; height: 15px;"></td></tr>
                                        <tr><td>Tgl.</td><td style="border-bottom: 2px solid #000; text-align: center;">${tanggal.split('/')[0]} / ${tanggal.split('/')[1]} / ${tanggal.split('/')[2]}</td></tr>
                                        <tr><td>No.</td><td style="border-bottom: 2px solid #000;">: ${nomorSurat}</td></tr>
                                    </table>
                                </div>
                            </div>

                            <div style="background: #000; color: #fff; text-align: center; padding: 4px; margin: 10px 0; font-weight: bold; font-size: 13px;">MENERIMA PESANAN</div>

                            <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 13px;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #000; font-weight: bold;">
                                        <th style="border-right: 2px solid #000; padding: 5px; text-align: center;">MAKANAN / MINUMAN</th>
                                        <th style="border-right: 2px solid #000; padding: 5px; width: 40px; text-align: center;">JML</th>
                                        <th style="border-right: 2px solid #000; padding: 5px; width: 80px; text-align: center;">H. SATUAN</th>
                                        <th style="padding: 5px; width: 110px; text-align: center;">SUB TOTAL</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtml}
                                </tbody>
                            </table>
                            
                            <div style="display: flex; margin-top: 10px;">
                                <div style="flex-grow: 1; display: flex; justify-content: space-around; font-size: 13px; font-weight: bold; padding-top: 20px;">
                                    <div style="text-align: center;">Tanda Terima<br><br><br>( ................. )</div>
                                    <div style="text-align: center;">Hormat Kami<br><br><br>( ................. )</div>
                                </div>
                                <div style="width: 200px; border-left: 2px solid #000;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 14px; font-weight: bold;">
                                        <tr style="border-bottom: 1px solid #000;">
                                            <td style="padding: 5px;">Total</td>
                                            <td style="padding: 5px; text-align: right;">${jumlah.toLocaleString('id-ID')}</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #000;">
                                            <td style="padding: 5px;">DP</td>
                                            <td style="padding: 5px; text-align: right;">-</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 5px;">Sisa</td>
                                            <td style="padding: 5px; text-align: right;">${jumlah.toLocaleString('id-ID')}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <div style="text-align: center; font-style: italic; font-family: 'Brush Script MT', cursive; font-size: 18px; margin-top: 10px;">Terima Kasih Atas Kunjungan Anda</div>
                        </div>
                    `;
                } else if (vendorStyle === 'cahya-cellular') {
                    // --- LAYOUT NOTA CAHYA CELLULAR (Blue Theme) ---
                    html = `
                        <div style="font-family: Arial, sans-serif; color: #1e40af; border: 2px solid #1e40af; padding: 20px; background: #fff; width: 100%; border-radius: 5px;">
                            <div style="display: flex; justify-content: space-between; position: relative;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 60px; height: 60px; border: 3px solid #1e40af; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px;">CC</div>
                                    <div style="text-align: center;">
                                        <h1 style="margin:0; font-size: 24px; font-weight: bold; letter-spacing: 4px; text-transform: uppercase;">CAHYA CELLULAR</h1>
                                    </div>
                                </div>
                                <div style="text-align: left; font-size: 12px; font-weight: 600;">
                                    Cikalongwetan, ........................<br>
                                    Kepada Yth. <br><br>
                                    <div style="height: 2px; background: #ef4444; width: 180px; margin: 5px 0;"></div>
                                    <div style="height: 2px; background: #ef4444; width: 180px;"></div>
                                </div>
                            </div>
                            
                            <p style="margin: 10px 0; font-size: 12px; font-weight: bold; text-transform: uppercase;">KARTU INTERNET - AKSESORIS - HP BARU - SECOND - HP ALL OPERATOR</p>
                            <p style="margin: 0; font-size: 10px; font-weight: bold;">Alamat: ${vendorAddress}</p>
                            <p style="margin: 2px 0 10px 0; font-size: 10px; font-weight: bold;">HP. 082 116 52 5553 / 089 666 8888 06 / 085 719 799 7990</p>
                            
                            <div style="height: 3px; background: #1e40af; margin-bottom: 2px;"></div>
                            <div style="text-align: right; font-weight: bold; font-size: 14px; margin-bottom: 5px;">Nota No : _________</div>

                            <table style="width: 100%; border-collapse: collapse; border: 2px solid #1e40af;">
                                <thead>
                                    <tr style="background: #3b82f6; color: #fff;">
                                        <th style="border: 2px solid #1e40af; padding: 5px; width: 80px;">BANYAKNYA</th>
                                        <th style="border: 2px solid #1e40af; padding: 5px;">NAMA BARANG</th>
                                        <th style="border: 2px solid #1e40af; padding: 5px; width: 100px;">HARGA SATUAN</th>
                                        <th style="border: 2px solid #1e40af; padding: 5px; width: 120px;">JUMLAH RP.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtml.replaceAll('border-right: 2px solid #000', 'border: 2px solid #1e40af').replaceAll('border-bottom: 1px solid #000', 'border: 2px solid #1e40af')}
                                </tbody>
                            </table>
                            
                            <div style="display: flex; margin-top: 10px;">
                                <div style="flex-grow: 1; font-size: 10px; font-weight: bold;">
                                    <p>Perhatian !</p>
                                    <p>Barang Yang Sudah Dibeli Tidak Dapat Ditukar/Dikembalikan</p>
                                    <div style="display: flex; justify-content: space-around; margin-top: 40px; font-size: 12px;">
                                        <div style="text-align: center;">Yang Menerima<br><br><br>( _________ )</div>
                                        <div style="text-align: center;">Hormat Kami<br><br><br>( _________ )</div>
                                    </div>
                                </div>
                                <div style="width: 180px;">
                                    <table style="width: 100%; border-collapse: collapse; font-weight: bold; font-size: 12px; color: #fff;">
                                        <tr><td style="background: #3b82f6; padding: 4px; border: 1px solid #1e40af; text-align: right;">Jumlah</td><td style="border: 1px solid #1e40af; color: #000; width: 100px; text-align: center;">${jumlah.toLocaleString('id-ID')}</td></tr>
                                        <tr><td style="background: #3b82f6; padding: 4px; border: 1px solid #1e40af; text-align: right;">Uang Muka</td><td style="border: 1px solid #1e40af; color: #000; text-align: center;">-</td></tr>
                                        <tr><td style="background: #3b82f6; padding: 4px; border: 1px solid #1e40af; text-align: right;">Sisa</td><td style="border: 1px solid #1e40af; color: #000; text-align: center;">${jumlah.toLocaleString('id-ID')}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (vendorStyle === 'media-komputer') {
                    // --- LAYOUT MEDIA KOMPUTER (Black Theme) ---
                    html = `
                        <div style="font-family: Arial, sans-serif; color: #000; border: 1px solid #666; padding: 30px; background: #fff; width: 100%;">
                            <div style="display: flex; justify-content: space-between;">
                                <div style="display: flex; align-items: flex-start; gap: 15px;">
                                    <div style="width: 60px; height: 60px; background: #0ea5e9; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;">BS</div>
                                    <div>
                                        <h1 style="margin:0; font-size: 48px; font-family: 'Impact', sans-serif; font-weight: normal; font-style: italic; line-height: 1;">MEDIA</h1>
                                        <p style="margin:5px 0 0 0; font-size: 10px; font-weight: bold;">Terima Jual Beli/Service Laptop, Notebook, Printer & Aksesoris</p>
                                        <p style="margin:0; font-size: 10px;">${vendorAddress}</p>
                                    </div>
                                </div>
                                <div style="text-align: left; font-size: 12px;">
                                    Cikalongwetan, ........................<br>
                                    Tuan/Toko : _______________________<br><br>
                                    <div style="border-bottom: 2px dashed #000; width: 150px;"></div>
                                </div>
                            </div>
                            
                            <div style="height: 3px; background: #000; margin: 15px 0 2px 0;"></div>
                            <div style="height: 1px; background: #000; margin-bottom: 15px;"></div>

                            <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 13px;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #000; font-weight: bold;">
                                        <th style="border-right: 1px solid #000; padding: 8px; width: 40px; text-align: center;">NO</th>
                                        <th style="border-right: 1px solid #000; padding: 8px; text-align: center;">ITEM / SERVICE</th>
                                        <th style="border-right: 1px solid #000; padding: 8px; width: 100px; text-align: center;">HARGA SATUAN</th>
                                        <th style="padding: 8px; width: 120px; text-align: center;">JUMLAH</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtml.replaceAll('border-right: 2px solid #000', 'border: 1px solid #000').replaceAll('border-bottom: 1px solid #000', 'border: 1px solid #000')}
                                </tbody>
                            </table>
                            
                            <div style="display: flex; margin-top: 20px;">
                                <div style="flex-grow: 1;">
                                    <div style="display: flex; justify-content: space-around; font-size: 13px;">
                                        <div style="text-align: center;">Yang Terima,<br><br><br>( ................. )</div>
                                        <div style="text-align: center;">Hormat Kami,<br><br><br>( ................. )</div>
                                    </div>
                                    <p style="margin-top: 15px; font-size: 11px; font-weight: bold; font-style: italic;">Barang yang sudah dibeli tidak dapat dikembalikan</p>
                                </div>
                                <div style="width: 250px; text-align: right; font-weight: bold; font-size: 16px; padding-top: 10px;">
                                    JUMLAH Rp. <span style="display: inline-block; width: 120px; border-bottom: 2px solid #000; text-align: right; padding-bottom: 5px;">${jumlah.toLocaleString('id-ID')}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (vendorStyle === 'mitra-photocopy') {
                    // --- LAYOUT MITRA PHOTOCOPY (Simple) ---
                    html = `
                        <div style="font-family: Arial, sans-serif; color: #000; border: 1px solid #ddd; padding: 15px; background: #fff; width: 100%;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <h1 style="margin:0; font-size: 28px; font-weight: normal; letter-spacing: 2px;">MITRA PHOTO COPY</h1>
                                    <p style="margin:5px 0 0 0; font-size: 11px;">${vendorAddress}</p>
                                    <p style="margin:0; font-size: 10px; font-weight: bold; text-transform: uppercase;">Melayani: Penjilidan Hard Cover, Soft Cover, Laminating, Alat Tulis Kantor Dll.</p>
                                </div>
                                <div style="text-align: left; font-size: 12px;">
                                    Cikalongwetan, ........................ 201 .....<br>
                                    _________________________________________<br>
                                    NPWP: 24.251.003.0 - 045.00
                                </div>
                            </div>
                            
                            <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; margin-top: 15px; font-size: 13px;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #000; font-weight: bold;">
                                        <th style="border-right: 2px solid #000; padding: 5px; width: 80px;">Banyaknya</th>
                                        <th style="border-right: 2px solid #000; padding: 5px;">Jenis Jasa</th>
                                        <th style="border-right: 2px solid #000; padding: 5px; width: 100px;">Harga Satuan (Rp)</th>
                                        <th style="padding: 5px; width: 120px;">Jumlah (Rp)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtml}
                                </tbody>
                            </table>
                            
                            <div style="display: flex; margin-top: 10px;">
                                <div style="flex-grow: 1; display: flex; align-items: flex-end; padding-bottom: 20px;">
                                    <h2 style="font-size: 24px; font-weight: normal;">Hormat Kami</h2>
                                </div>
                                <div style="width: 180px; font-size: 12px; font-weight: bold;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr><td style="padding: 5px; text-align: right;">Jumlah Rp.</td><td style="border: 1px solid #000; padding: 5px; text-align: center; width: 100px;">${jumlah.toLocaleString('id-ID')}</td></tr>
                                        <tr><td style="padding: 5px; text-align: right;">Uang Muka Rp.</td><td style="border: 1px solid #000; padding: 5px; text-align: center;">-</td></tr>
                                        <tr><td style="padding: 5px; text-align: right;">Sisa Rp.</td><td style="border: 1px solid #000; padding: 5px; text-align: center;">${jumlah.toLocaleString('id-ID')}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (vendorStyle === 'sinar-abadi') {
                    // --- LAYOUT SINAR ABADI (Classic Red) ---
                    html = `
                        <div style="font-family: 'Times New Roman', serif; color: #1e3a8a; border: 3px double #1e3a8a; padding: 25px; background: #fff; width: 100%; position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="display: flex; gap: 20px;">
                                    <div style="width: 65px; height: 65px; background: #ef4444; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 30px; border: 3px solid #1e3a8a;">SA</div>
                                    <div>
                                        <h1 style="margin:0; font-size: 32px; font-weight: 900; color: #ef4444; font-family: 'Arial Black', sans-serif;">TB. SINAR ABADI</h1>
                                        <p style="margin:0; font-size: 11px; font-weight: bold;">${vendorAddress}</p>
                                        <p style="margin:0; font-size: 11px; font-weight: bold;">Menjual: Bahan Bangunan Kayu Dll</p>
                                        <p style="margin:0; font-size: 11px;">Melayani Eceran dan Grosir</p>
                                    </div>
                                </div>
                                <div style="text-align: left; font-size: 12px; color: #1e3a8a;">
                                    Cikalongwetan, ........................<br>
                                    Tuan : _______________________<br>
                                    Toko : _______________________<br><br>
                                    <div style="border-bottom: 2px solid #1e3a8a; width: 180px;"></div>
                                </div>
                            </div>
                            
                            <table style="width: 100%; border-collapse: collapse; border: 2px solid #1e3a8a; margin-top: 20px; font-size: 14px; position: relative; z-index: 1;">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 120px; font-weight: bold; color: rgba(239, 68, 68, 0.1); z-index: -1;">SA</div>
                                <thead>
                                    <tr style="border-bottom: 2px solid #1e3a8a; font-weight: bold; text-align: center;">
                                        <th style="border-right: 2px solid #1e3a8a; padding: 8px; width: 80px;">Banyak-nya</th>
                                        <th style="border-right: 2px solid #1e3a8a; padding: 8px;">NAMA BARANG</th>
                                        <th style="border-right: 2px solid #1e3a8a; padding: 8px; width: 100px;">HARGA SATUAN</th>
                                        <th style="padding: 8px; width: 130px;">JUMLAH</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtml.replaceAll('border-right: 2px solid #000', 'border-right: 2px solid #1e3a8a').replaceAll('border-bottom: 1px solid #000', 'border-bottom: 1px solid #1e3a8a')}
                                </tbody>
                            </table>
                            
                            <div style="display: flex; margin-top: 15px; font-weight: bold;">
                                <div style="flex-grow: 1; font-size: 12px;">
                                    <p style="margin:0;">Pembayaran Transfer : Bank BCA</p>
                                    <p style="margin:0;">No. 2730110549 a/n : Hendri Fardiansyah</p>
                                    <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                                        <div style="text-align: center;">Tanda Terima,<br><br><br>( ................. )</div>
                                        <div style="text-align: center; border: 2px solid #ef4444; padding: 5px; color: #ef4444; font-size: 10px; width: 120px; margin-top: 10px;">Perhatian !<br>Barang yang sudah dibeli tidak dapat dikembalikan</div>
                                        <div style="text-align: center;">Hormat Kami,<br><br><br>( ................. )</div>
                                    </div>
                                </div>
                                <div style="width: 250px; text-align: right; font-size: 18px; color: #1e3a8a; padding-top: 10px;">
                                    JUMLAH Rp. <span style="display: inline-block; width: 120px; border-bottom: 2px solid #1e3a8a; text-align: right;">${jumlah.toLocaleString('id-ID')}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (vendorStyle === 'standard') {
                    // --- LAYOUT MODERN STANDARD --- (Formerly Toko Prima)
                    html = `
                        <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #000; border: 2px solid #000; padding: 25px; background: #fff;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
                                <div style="display: flex; gap: 20px; align-items: flex-start;">
                                    ${logoBase64 ? `<img src="${logoBase64}" style="height: 70px; border-radius: 8px;">` : `<div style="padding: 10px 15px; background: #000; color: #fff; font-weight: bold; border-radius: 8px; font-size: 20px;">${vendorName.substring(0, 5).toUpperCase()}</div>`}
                                    <div>
                                        <h1 style="margin:0; font-size: 24px; font-weight: 800; color: #000; text-transform: uppercase;">${vendorName}</h1>
                                        <p style="margin:4px 0 0 0; font-size: 11px; white-space: pre-line; line-height: 1.3;">${vendorAddress}</p>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="display: inline-block; border: 2px solid #000; padding: 10px 15px; text-align: left; min-width: 200px; border-radius: 4px;">
                                        <p style="margin:0; font-size: 11px; color: #666;">Kepada Yth:</p>
                                        <p style="margin:4px 0 0 0; font-size: 13px; font-weight: bold;">${schoolData.name}</p>
                                        <p style="margin:2px 0 0 0; font-size: 11px;">Kecamatan ${schoolData.kecamatan}</p>
                                    </div>
                                    <p style="margin:10px 0 0 0; font-size: 12px; font-weight: bold;">TANGGAL: ${tanggal}</p>
                                </div>
                            </div>

                            <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; margin-bottom: 20px;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #000; background: #000; color: #fff;">
                                        <th style="padding: 10px; text-align: left; border-right: 1px solid #fff;">BANYAKNYA</th>
                                        <th style="padding: 10px; text-align: left; border-right: 1px solid #fff;">NAMA BARANG / JASA</th>
                                        <th style="padding: 10px; text-align: right; border-right: 1px solid #fff; width: 110px;">HARGA</th>
                                        <th style="padding: 10px; text-align: right; width: 130px;">JUMLAH</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtml}
                                </tbody>
                                <tfoot>
                                    <tr style="border-top: 2px solid #000; font-weight: bold; font-size: 14px;">
                                        <td colspan="3" style="text-align: right; padding: 12px; border-right: 2px solid #000;">TOTAL BAYAR Rp.</td>
                                        <td style="text-align: right; padding: 12px; background: #f8fafc;">${jumlah.toLocaleString('id-ID')}</td>
                                    </tr>
                                </tfoot>
                            </table>

                            <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                                <div style="text-align: center; width: 180px;">
                                    <p style="margin:0; font-size: 13px;">Tanda Terima,</p>
                                    <br><br><br>
                                    <p style="margin:0; font-weight: bold; border-bottom: 1px solid #000;">( ......................... )</p>
                                </div>
                                <div style="text-align: center;">
                                     <p style="font-style: italic; margin-top: 20px; font-size: 14px; color: #444;">Terima Kasih Atas Kepercayaan Anda</p>
                                </div>
                                <div style="text-align: center; width: 180px;">
                                    <p style="margin:0; font-size: 13px;">Hormat Kami,</p>
                                    <br><br><br>
                                    <p style="margin:0; font-weight: bold; border-bottom: 1px solid #000;">${vendorName}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else if (docType === 'pesanan') {
                // --- TEMPLATE SURAT PESANAN (FORMAL) ---
                html = `
                    <div style="font-family: 'Times New Roman', Times, serif; color: #000; padding: 10px 40px;">
                        ${schoolKop}
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                            <p>${schoolData.kecamatan}, ${datePesanInfo.fullDate}</p>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 20px 1fr; gap: 5px; margin-bottom: 30px;">
                            <div>Nomor</div><div>:</div><div>${nomorSurat}</div>
                            <div>Sifat</div><div>:</div><div>Biasa</div>
                            <div>Lampiran</div><div>:</div><div>-</div>
                            <div>Perihal</div><div>:</div><div style="font-weight: bold; text-decoration: underline;">${perihal}</div>
                            
                            <div style="grid-column: 3; margin-top: 10px;">
                                <strong>Kepada Yth,</strong><br>
                                <strong>${vendorName}</strong><br>
                                di Tempat
                            </div>
                        </div>

                        <p>Assalamualaikum Wr, Wb.</p>
                        <p style="text-indent: 40px; text-align: justify; line-height: 1.5;">
                            Dengan Hormat, Bersamaan ini kami sampaikan bahwa sehubungan dengan akan dilaksanakannya kegiatan pada tanggal <b>${dateKegiatanInfo.fullDate}</b>, Kami bermaksud ingin memesan kebutuhan dengan rincian sebagai berikut:
                        </p>

                        <div style="margin: 20px auto; width: 90%;">
                            <table style="width: 100%; border-collapse: collapse; border: 1px solid #000;">
                                <tr style="background: #f0f0f0;">
                                    <th style="border: 1px solid #000; padding: 8px;">No</th>
                                    <th style="border: 1px solid #000; padding: 8px;">Uraian Barang/Kebutuhan</th>
                                    <th style="border: 1px solid #000; padding: 8px;">Jumlah</th>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">1</td>
                                    <td style="border: 1px solid #000; padding: 8px;">${cleanUraian}</td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">1 Paket</td>
                                </tr>
                            </table>
                        </div>

                        <p style="text-indent: 40px; margin-bottom: 40px;">Demikian surat pesanan ini kami sampaikan, Atas perhatiannya dan kerjasamanya kami ucapkan terimakasih.</p>

                        <div style="display: flex; justify-content: flex-end;">
                            <div style="text-align: center;">
                                <p>Mengetahui,</p>
                                <p style="font-weight: bold; margin-bottom: 80px;">Kepala Sekolah</p>
                                <p style="font-weight: bold; text-decoration: underline; margin:0;">${schoolData.principal}</p>
                                <p style="margin:0;">NIP. ${schoolData.principalNip}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (docType === 'berita_acara') {
                // --- TEMPLATE BERITA ACARA SERAH TERIMA ---
                html = `
                    <div style="font-family: 'Times New Roman', Times, serif; color: #000; padding: 10px 40px;">
                        ${schoolKop}
                        
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h3 style="text-decoration: underline; margin: 0; font-size: 16px;">BERITA ACARA SERAH TERIMA BARANG/JASA</h3>
                            <p style="margin: 5px 0 0 0;">Nomor: ${nomorSurat}</p>
                        </div>

                        <p style="text-align: justify; line-height: 1.6;">
                            Pada hari ini <strong>${dateInfo.dayName}</strong> tanggal <strong>${dateInfo.fullDate}</strong>, kami yang bertanda tangan di bawah ini:
                        </p>

                        <table style="width: 100%; margin-bottom: 20px;">
                            <tr>
                                <td style="width: 30px; vertical-align: top;">1.</td>
                                <td style="width: 100px; vertical-align: top;">Nama</td>
                                <td style="vertical-align: top;">: <strong>${vendorName}</strong></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td style="vertical-align: top;">Alamat</td>
                                <td style="vertical-align: top;">: ${vendorAddress}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td colspan="2" style="padding-top: 5px;">Selanjutnya disebut <strong>PIHAK PERTAMA</strong></td>
                            </tr>
                            <tr><td colspan="3" style="height: 15px;"></td></tr>
                            <tr>
                                <td style="width: 30px; vertical-align: top;">2.</td>
                                <td style="width: 100px; vertical-align: top;">Nama</td>
                                <td style="vertical-align: top;">: <strong>${schoolData.principal}</strong></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td style="vertical-align: top;">NIP</td>
                                <td style="vertical-align: top;">: ${schoolData.principalNip}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td style="vertical-align: top;">Jabatan</td>
                                <td style="vertical-align: top;">: Kepala Sekolah ${schoolData.name}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td colspan="2" style="padding-top: 5px;">Selanjutnya disebut <strong>PIHAK KEDUA</strong></td>
                            </tr>
                        </table>

                        <p style="text-align: justify; line-height: 1.6;">
                            PIHAK PERTAMA menyerahkan barang/jasa kepada PIHAK KEDUA, dan PIHAK KEDUA menerima barang/jasa dari PIHAK PERTAMA berupa:
                        </p>

                        <div style="border: 1px solid #000; padding: 15px; margin: 10px 0;">
                            <table style="width: 100%;">
                                <tr>
                                    <td style="width: 120px; font-weight: bold;">Uraian Barang</td>
                                    <td>: ${uraian}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">Nilai Barang</td>
                                    <td>: Rp ${jumlah.toLocaleString('id-ID')}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">Terbilang</td>
                                    <td style="font-style: italic;">: ${terbilangText}</td>
                                </tr>
                            </table>
                        </div>

                        <p style="text-align: justify; line-height: 1.6; margin-bottom: 40px;">
                            Demikian Berita Acara Serah Terima ini dibuat dengan sebenarnya untuk dapat dipergunakan sebagaimana mestinya.
                        </p>

                        <div style="display: flex; justify-content: space-between; text-align: center;">
                            <div style="width: 200px;">
                                <p>PIHAK PERTAMA</p>
                                <br><br><br><br>
                                <p style="font-weight: bold; text-decoration: underline;">${vendorName}</p>
                            </div>
                            <div style="width: 200px;">
                                <p>PIHAK KEDUA</p>
                                <br><br><br><br>
                                <p style="font-weight: bold; text-decoration: underline;">${schoolData.principal}</p>
                                <p>NIP. ${schoolData.principalNip}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (docType === 'kwitansi') {
                // --- TEMPLATE KWITANSI BENDAHARA (SESUAI GAMBAR) ---
                html = `
                    <div style="border: 4px double #000; padding: 25px; font-family: Arial, sans-serif; color: #000; background: #fff;">
                        <h1 style="text-align: center; text-decoration: underline; margin-bottom: 20px; font-size: 24px; letter-spacing: 5px;">KUITANSI</h1>
                        
                        <div style="display: grid; grid-template-columns: 180px 20px 1fr; gap: 10px; line-height: 2;">
                            <div style="font-weight: bold;">Nomor</div><div>:</div><div style="border-bottom: 1px dashed #000;">${nomorSurat}</div>
                            
                            <div>Sudah terima dari</div><div>:</div><div style="border-bottom: 1px dashed #000; font-weight: bold;">BENDAHARA BOS ${schoolData.name}</div>
                            
                            <div>Banyaknya uang</div><div>:</div><div style="background: #e2e8f0; padding: 0 10px; font-style: italic; font-weight: bold;">### ${terbilangText} ###</div>
                            
                            <div>Untuk pembayaran</div><div>:</div><div style="border-bottom: 1px dashed #000;">${uraian}</div>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 40px;">
                            <div style="text-align: center; border: 1px solid #000; padding: 10px 15px; min-width: 150px; height: fit-content; margin-bottom: 10px;">
                                <p style="margin:0; font-size: 11px;">Jumlah Rp.</p>
                                <p style="margin:0; font-size: 18px; font-weight: bold;">${jumlah.toLocaleString('id-ID')},-</p>
                            </div>
                            
                            <div style="display: flex; gap: 40px;">
                                <div style="text-align: center;">
                                    <p style="margin-bottom: 5px; font-size: 13px;">Setuju Dibayar,</p>
                                    <p style="font-weight: bold; margin-bottom: 60px; font-size: 13px;">Kepala Sekolah</p>
                                    <p style="font-weight: bold; text-decoration: underline; margin:0; font-size: 12px;">${schoolData.principal}</p>
                                    <p style="margin:0; font-size: 11px;">NIP. ${schoolData.principalNip}</p>
                                </div>
                                <div style="text-align: center;">
                                    <p style="margin-bottom: 5px; font-size: 13px;">Lunas Dibayar,</p>
                                    <p style="font-weight: bold; margin-bottom: 60px; font-size: 13px;">Bendahara</p>
                                    <p style="font-weight: bold; text-decoration: underline; margin:0; font-size: 12px;">${schoolData.treasurer}</p>
                                    <p style="margin:0; font-size: 11px;">NIP. ${schoolData.treasurerNip}</p>
                                </div>
                                <div style="text-align: center;">
                                    <p style="margin-bottom: 5px; font-size: 13px;">&nbsp;</p>
                                    <p style="font-weight: bold; margin-bottom: 60px; font-size: 13px;">Penerima</p>
                                    <p style="font-weight: bold; margin:0; font-size: 14px; white-space: nowrap;">( ................................. )</p>
                                </div>
                            </div>
                        </div>
                    `;
            } else if (docType === 'undangan') {
                // --- TEMPLATE UNDANGAN (SESUAI TEKS) ---
                html = `
                    <div style="font-family: 'Times New Roman', Times, serif; color: #000; padding: 10px 40px;">
                        ${schoolKop}
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                            <p>${schoolData.kecamatan}, ${datePesanInfo.fullDate}</p>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 20px 1fr; gap: 5px; margin-bottom: 30px;">
                            <div>Nomor</div><div>:</div><div>${nomorSurat}</div>
                            <div>Sifat</div><div>:</div><div>Biasa</div>
                            <div>Lampiran</div><div>:</div><div>-</div>
                            <div>Perihal</div><div>:</div><div style="font-weight: bold; text-decoration: underline;">${perihal}</div>
                            
                            <div style="grid-column: 3; margin-top: 10px;">
                                <strong>Kepada Yth,</strong><br>
                                <strong>Bapak/Ibu Kepala Sekolah Dasar Se-Gugus</strong><br>
                                di Tempat
                            </div>
                        </div>

                        <p>Assalamualaikum Wr, Wb.</p>
                        <p style="text-indent: 40px; text-align: justify; line-height: 1.5;">
                            Dengan Hormat, Bersamaan ini kami sampaikan bahwa pelaksanaan <b>${cleanUraian}</b> tahun 2025 akan dilaksanakan pada:
                        </p>

                        <div style="margin: 20px 40px; line-height: 2;">
                            <div style="display: grid; grid-template-columns: 100px 20px 1fr;">
                                <div>Hari</div><div>:</div><div>${dateKegiatanInfo.dayName}</div>
                                <div>Tanggal</div><div>:</div><div>${dateKegiatanInfo.fullDate}</div>
                                <div>Tempat</div><div>:</div><div>${schoolData.name} - ${tempatKegiatan}</div>
                                <div>Waktu</div><div>:</div><div>${waktuKegiatan}</div>
                            </div>
                        </div>

                        <p style="text-indent: 40px; margin-bottom: 40px;">Demikian kami sampaikan, Atas perhatiannya dan kehadirannya kami ucapkan terimakasih.</p>

                        <div style="display: flex; justify-content: flex-end;">
                            <div style="text-align: center;">
                                <p style="font-weight: bold; margin-bottom: 80px;">Ketua Gugus,</p>
                                <p style="font-weight: bold; text-decoration: underline; margin:0;">${schoolData.principal}</p>
                                <p style="margin:0;">NIP. ${schoolData.principalNip}</p>
                            </div>
                        </div>

                        <div style="margin-top: 40px; font-size: 11px;">
                            <p style="text-decoration: underline; margin:0;">Tembusan:</p>
                            <div style="white-space: pre-line; margin:0; padding-left: 20px;">${tembusan}</div>
                        </div>
                    </div>
                `;
            } else if (docType === 'notulen') {
                html = getNotulenHtml(uraian, dateInfo, schoolData, schoolKop);
            } else if (docType === 'daftar_hadir') {
                html = getDaftarHadirHtml(uraian, schoolData, schoolKop);
            } else if (docType === 'dokumentasi') {
                html = getDokumentasiHtml(uraian, dateInfo, schoolData, schoolKop);
            } else if (docType === 'rencana') {
                html = getRencanaHtml(uraian, schoolData, schoolKop);
            } else if (docType === 'spk') {
                html = getSpkHtml(uraian, schoolData, schoolKop);
            }

            document.getElementById('paperContent').innerHTML = html;
        }

        /**
         * Dynamic Document Templates Helper Functions
         */
        function getNotulenHtml(uraian, dateInfo, schoolData, schoolKop) {
            const waktu = document.getElementById('custWaktu').value || "11.00  12.30 WIB";
            const hasilLines = (document.getElementById('custHasil').value || "1. Pembahasan satu\n2. Pembahasan dua").split('\n');
            const kesimpulan = document.getElementById('custKesimpulan').value || "Kesimpulan rapat...";
            return `
                <div style="font-family: 'Times New Roman', Times, serif; color: #000; padding: 10px 40px;">
                    ${schoolKop}
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="text-decoration: underline; margin-bottom: 20px;">NOTULEN</h2>
                    </div>
                    <table style="width: 100%; margin-bottom: 20px; line-height: 1.6;">
                        <tr><td style="width: 140px;">Nama Rapat</td><td>: ${uraian}</td></tr>
                        <tr><td>Hari, Tanggal</td><td>: ${dateInfo.dayName}, ${dateInfo.fullDate}</td></tr>
                        <tr><td>Waktu</td><td>: Pukul ${waktu}</td></tr>
                        <tr><td>Tempat</td><td>: Ruang Guru ${schoolData.name}</td></tr>
                    </table>
                    <p style="font-weight: bold; margin-bottom: 10px;">Hasil Pembahasan dan Keputusan:</p>
                    <ol style="padding-left: 20px; margin-bottom: 20px; line-height: 1.6; text-align: justify;">
                        ${hasilLines.map(line => `<li>${line.replace(/^\d+\.\s*/, '')}</li>`).join('')}
                    </ol>
                    <p style="font-weight: bold; margin-bottom: 10px;">Kesimpulan:</p>
                    <p style="text-align: justify; line-height: 1.6; margin-bottom: 40px;">${kesimpulan}</p>
                    <div style="display: flex; justify-content: flex-end;">
                        <div style="text-align: center;">
                            <p style="margin-bottom: 5px;">${schoolData.kecamatan}, ${dateInfo.fullDate}</p>
                            <p style="font-weight: bold; margin-bottom: 80px;">Kepala Sekolah</p>
                            <p style="font-weight: bold; text-decoration: underline; margin:0;">${schoolData.principal}</p>
                            <p style="margin:0;">NIP. ${schoolData.principalNip}</p>
                        </div>
                    </div>
                </div>`;
        }

        function getDaftarHadirHtml(uraian, schoolData, schoolKop) {
            const attendanceRows = document.querySelectorAll('.attendance-row');
            let listHtml = '';
            attendanceRows.forEach((row, i) => {
                const inputs = row.querySelectorAll('input');
                const isEven = (i + 1) % 2 === 0;
                listHtml += `
                    <tr style="height: 50px;">
                        <td style="border: 1px solid #000; text-align: center;">${i + 1}</td>
                        <td style="border: 1px solid #000; padding-left: 8px;">${inputs[0].value || ""}</td>
                        <td style="border: 1px solid #000; padding-left: 8px;">${inputs[1].value || ""}</td>
                        <td style="border: 1px solid #000;">
                            <div style="display: flex; padding-left: 10px; font-size: 11px;">
                                <span>${i + 1}.</span>
                                <div style="width: 100%; border-bottom: 1px dotted #000; margin-top: 15px; margin-left: ${isEven ? '80' : '0'}px;"></div>
                            </div>
                        </td>
                    </tr>`;
            });
            return `
                <div style="font-family: 'Times New Roman', Times, serif; color: #000; padding: 10px 40px;">
                    ${schoolKop}
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">DAFTAR HADIR</h2>
                        <h3 style="margin: 0; font-size: 16px;">${uraian}</h3>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 40px; font-size: 13px;">
                        <thead><tr style="background: #f0f0f0;"><th style="border: 1px solid #000; padding: 10px; width: 40px;">NO</th>
                        <th style="border: 1px solid #000; padding: 10px;">NAMA</th><th style="border: 1px solid #000; padding: 10px; width: 180px;">JABATAN</th>
                        <th style="border: 1px solid #000; padding: 10px; width: 180px;">TANDA TANGAN</th></tr></thead>
                        <tbody>${listHtml || '<tr><td colspan="4" style="text-align:center; padding:20px;">Belum ada data hadir</td></tr>'}</tbody>
                    </table>
                    <div style="display: flex; justify-content: flex-end;"><div style="text-align: center; width: 250px;">
                    <p style="margin-bottom: 5px;">Mengetahui,</p><p style="font-weight: bold; margin-bottom: 80px;">Kepala Sekolah</p>
                    <p style="font-weight: bold; text-decoration: underline; margin:0;">${schoolData.principal}</p><p style="margin:0;">NIP. ${schoolData.principalNip}</p>
                    </div></div>
                </div>`;
        }

        function getDokumentasiHtml(uraian, dateInfo, schoolData, schoolKop) {
            return `
                <div style="font-family: 'Times New Roman', Times, serif; color: #000; padding: 10px 40px;">
                    ${schoolKop}
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="text-decoration: underline; margin-bottom: 10px;">LEMBAR DOKUMENTASI</h2>
                        <h3 style="margin: 0; font-size: 16px;">${uraian}</h3>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 40px; margin-top: 50px;">
                        ${docPhotoBase64 ? `<div style="border: 1px solid #000; padding: 20px;"><img src="${docPhotoBase64}" style="max-width: 500px; max-height: 400px; object-fit: contain;"></div>` :
                    `<div style="border: 2px dashed #ccc; width: 500px; height: 300px; display: flex; align-items: center; justify-content: center; color: #999;">Foto Kegiatan Belum Diupload</div>`}
                    </div>
                    <div style="margin-top: 100px; display: flex; justify-content: flex-end;"><div style="text-align: center;">
                        <p style="margin-bottom: 5px;">${schoolData.kecamatan}, ${dateInfo.fullDate}</p><p style="font-weight: bold; margin-bottom: 80px;">Kepala Sekolah</p>
                        <p style="font-weight: bold; text-decoration: underline; margin:0;">${schoolData.principal}</p><p style="margin:0;">NIP. ${schoolData.principalNip}</p>
                    </div></div>
                </div>`;
        }

        function getRencanaHtml(uraian, schoolData, schoolKop) {
            const kategori = document.getElementById('custKategori').value || "-";
            const jumlahBarang = document.getElementById('custJumlahBarang').value || "1";
            const spesifikasi = document.getElementById('custSpesifikasi').value || uraian;
            const waktuSerah = document.getElementById('custTanggal').value || "-";
            const lokasi = document.getElementById('custTempatKegiatan').value || schoolData.name;
            const anggaran = document.getElementById('custJumlah').value || "0";
            const persyaratan = (document.getElementById('custPersyaratan').value || "").replace(/\n/g, '<br>');
            const tanggal = document.getElementById('custTanggal').value || "";

            // Format anggaran
            let anggaranFmt = "0";
            try {
                anggaranFmt = parseInt(anggaran).toLocaleString('id-ID');
            } catch (e) { }


            return `
                <div style="font-family: Arial, sans-serif; color: #000; padding: 10px 40px;">
                    ${schoolKop}
                    <div style="text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 20px; text-decoration: underline;">DOKUMEN PERENCANAAN</div>
                    
                    <table style="width: 100%; font-weight: bold; margin-bottom: 20px;">
                        <tr><td style="width: 200px;">Nama Satuan Pendidikan</td><td>: ${schoolData.name}</td></tr>
                        <tr><td>Alamat Satuan Pendidikan</td><td>: ${schoolData.address}</td></tr>
                        <tr><td>Kategori Barang/Jasa</td><td>: ${kategori}</td></tr>
                    </table>

                     <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #000; padding: 5px; text-align: center; width: 40px;">NO.</th>
                                <th style="border: 1px solid #000; padding: 5px; text-align: center;">JENIS</th>
                                <th style="border: 1px solid #000; padding: 5px; text-align: center;">KETERANGAN</th>
                            </tr>
                        </thead>
                        <tbody>
                             <tr>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">1</td>
                                <td style="border: 1px solid #000; padding: 5px;">Jumlah barang/jasa</td>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">${jumlahBarang}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">2</td>
                                <td style="border: 1px solid #000; padding: 5px;">Spesifikasi/ruang lingkup barang/jasa</td>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">${spesifikasi}</td>
                            </tr>
                             <tr>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">3</td>
                                <td style="border: 1px solid #000; padding: 5px;">Waktu serah terima</td>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">${waktuSerah}</td>
                            </tr>
                             <tr>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">4</td>
                                <td style="border: 1px solid #000; padding: 5px;">Lokasi serah terima</td>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">${lokasi}</td>
                            </tr>
                             <tr>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">5</td>
                                <td style="border: 1px solid #000; padding: 5px;">Alokasi anggaran</td>
                                <td style="border: 1px solid #000; padding: 5px; text-align: right;">Rp <span style="float:right;">${anggaranFmt}</span></td>
                            </tr>
                             <tr>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center; vertical-align: top;">6</td>
                                <td style="border: 1px solid #000; padding: 5px; vertical-align: top;">Persyaratan Penyedia</td>
                                <td style="border: 1px solid #000; padding: 5px;">${persyaratan}</td>
                            </tr>
                        </tbody>
                    </table>

                     <div style="display: flex; justify-content: flex-end; margin-top: 40px;">
                        <div style="text-align: center;">
                            <p style="margin-bottom: 5px;">${schoolData.kecamatan}, ${getDateText(tanggal).fullDate}</p>
                            <p style="font-weight: bold; margin-bottom: 80px;">Pelaksana</p>
                            <p style="font-weight: bold; text-decoration: underline; margin:0;">${schoolData.principal}</p>
                            <p style="margin:0;">NIP. ${schoolData.principalNip}</p>
                        </div>
                    </div>
                     <div style="margin-top: 20px; font-size: 11px;">
                        (*) Misalnya Buku Teks Utama/Buku Teks Pendamping/Buku Nonteks/Kebutuhan dan Perlengkapan Satuan Pendidikan/Alat Peraga Pendidikan/Komputer dan Aksesoris/Elektronik/Jasa lainnya.
                    </div>
                </div>
            `;
        }

        function getSpkHtml(uraian, schoolData, schoolKop) {
            const nomorSpk = document.getElementById('custNomorSurat').value || "";
            const tglSpk = document.getElementById('custTanggal').value || "";
            const tglNegosiasi = document.getElementById('custTglNegosiasi').value || "";
            const waktuPelaksanaan = document.getElementById('custWaktuPelaksanaan').value || document.getElementById('custTanggal').value || "";
            const waktuPenyelesaian = document.getElementById('custWaktuPenyelesaian').value || "";
            const instruksi = (document.getElementById('custInstruksi').value || "").replace(/\n/g, '<br>');
            const jumlahTotal = parseInt(document.getElementById('custJumlah').value || "0");

            // Get Items from Nota List logic
            const items = [];
            document.querySelectorAll('.nota-item-row').forEach(row => {
                const inputs = row.querySelectorAll('input');
                items.push({
                    name: inputs[0].value,
                    qty: parseInt(inputs[1].value) || 0,
                    price: parseInt(inputs[2].value) || 0,
                    total: (parseInt(inputs[1].value) || 0) * (parseInt(inputs[2].value) || 0)
                });
            });

            // Fallback if no items
            if (items.length === 0) {
                items.push({
                    name: document.getElementById('custUraian').value || "",
                    qty: 1,
                    price: jumlahTotal,
                    total: jumlahTotal
                });
            }

            const itemsHtml = items.map((item, i) => `
                <tr>
                    <td style="border: 1px solid #000; padding: 5px; text-align: center;">${i + 1}</td>
                    <td style="border: 1px solid #000; padding: 5px;">${item.name}</td>
                    <td style="border: 1px solid #000; padding: 5px; text-align: center;">${item.qty}</td>
                    <td style="border: 1px solid #000; padding: 5px; text-align: center;">unit</td>
                    <td style="border: 1px solid #000; padding: 5px; text-align: right;">Rp ${item.price.toLocaleString('id-ID')}</td>
                    <td style="border: 1px solid #000; padding: 5px; text-align: right;">Rp ${item.total.toLocaleString('id-ID')}</td>
                </tr>
             `).join('');

            // Fill empty rows to make it look like the example
            const emptyRows = Array(Math.max(0, 5 - items.length)).fill(`
                <tr>
                     <td style="border: 1px solid #000; padding: 5px;">&nbsp;</td>
                     <td style="border: 1px solid #000; padding: 5px;"></td>
                     <td style="border: 1px solid #000; padding: 5px;"></td>
                     <td style="border: 1px solid #000; padding: 5px;"></td>
                     <td style="border: 1px solid #000; padding: 5px;">Rp -</td>
                     <td style="border: 1px solid #000; padding: 5px;">Rp -</td>
                </tr>
             `).join('');

            const terbilangText = terbilang(jumlahTotal) + " Rupiah";

            return `
                <div style="font-family: Arial, sans-serif; color: #000; padding: 10px 40px;">
                    ${schoolKop}
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 5px;">
                        <tr>
                            <td rowspan="3" style="border: 1px solid #000; padding: 10px; width: 40%; vertical-align: top; text-align: center; font-weight: bold;">
                                <br><br>SURAT PERINTAH KERJA (SPK)
                            </td>
                            <td style="border: 1px solid #000; padding: 5px;">Nama Satuan Pendidikan : ${schoolData.name}</td>
                        </tr>
                        <tr>
                             <td style="border: 1px solid #000; padding: 5px;">Nomor SPK : ${nomorSpk}</td>
                        </tr>
                        <tr>
                             <td style="border: 1px solid #000; padding: 5px;">Tanggal SPK : ${getDateText(tglSpk).fullDate}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 5px;">Paket Pekerjaan : ${uraian}</td>
                            <td style="border: 1px solid #000; padding: 5px;">
                                Tanggal Negosiasi : ${getDateText(tglNegosiasi).fullDate}<br>
                                <span style="font-size: 11px;">SPK ini mulai berlaku efektif terhitung sejak tanggal ditetapkan dan penyelesaian keseluruhan pekerjaan sebagaimana dimaksud dalam SPK ini.</span>
                            </td>
                        </tr>
                    </table>

                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 5px;">
                         <tr>
                            <td style="border: 1px solid #000; padding: 5px; width: 50%;">WAKTU PELAKSANAAN PEKERJAAN : ${getDateText(waktuPelaksanaan).fullDate}</td>
                            <td style="border: 1px solid #000; padding: 5px;"></td>
                        </tr>
                         <tr>
                            <td style="border: 1px solid #000; padding: 5px;">WAKTU PENYELESAIAN PEKERJAAN : ${waktuPenyelesaian ? getDateText(waktuPenyelesaian).fullDate : '-'}</td>
                             <td style="border: 1px solid #000; padding: 5px;"></td>
                        </tr>
                    </table>

                    <div style="text-align: center; font-weight: bold; border: 1px solid #000; padding: 5px; border-bottom: none;">RINCIAN PEKERJAAN</div>
                     <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 20px;">
                        <thead>
                            <tr style="text-align: center; font-weight: bold;">
                                <th style="border: 1px solid #000; padding: 5px; width: 30px;">No</th>
                                <th style="border: 1px solid #000; padding: 5px;">Uraian Barang/Jasa</th>
                                <th style="border: 1px solid #000; padding: 5px; width: 80px;">Jumlah (QTY)</th>
                                <th style="border: 1px solid #000; padding: 5px; width: 80px;">Satuan Ukuran</th>
                                <th style="border: 1px solid #000; padding: 5px; width: 120px;">Harga Satuan</th>
                                <th style="border: 1px solid #000; padding: 5px; width: 120px;">Total Harga</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                            ${emptyRows}
                            <tr>
                                <td colspan="5" style="border: 1px solid #000; padding: 5px; text-align: right;">PPN</td>
                                <td style="border: 1px solid #000; padding: 5px; text-align: right; font-weight: bold;">Rp -</td>
                            </tr>
                            <tr>
                                <td colspan="5" style="border: 1px solid #000; padding: 5px; text-align: right;">Biaya Pengiriman</td>
                                <td style="border: 1px solid #000; padding: 5px; text-align: right; font-weight: bold;">Rp -</td>
                            </tr>
                             <tr>
                                <td colspan="5" style="border: 1px solid #000; padding: 5px; text-align: right;">Asuransi</td>
                                <td style="border: 1px solid #000; padding: 5px; text-align: right; font-weight: bold;">Rp -</td>
                            </tr>
                             <tr style="background: #fbbf24;">
                                <td colspan="5" style="border: 1px solid #000; padding: 5px; text-align: right; font-weight: bold;">Total Pembayaran</td>
                                <td style="border: 1px solid #000; padding: 5px; text-align: right; font-weight: bold;">Rp ${jumlahTotal.toLocaleString('id-ID')}</td>
                            </tr>
                              <tr>
                                <td colspan="6" style="border: 1px solid #000; padding: 5px; font-weight: bold; background: #f3f4f6;">
                                    Terbilang : ${terbilangText}
                                </td>
                            </tr>
                        </tbody>
                    </table>

                     <div style="border: 1px solid #000; padding: 10px; margin-bottom: 20px;">
                        <span style="text-decoration: underline;">INSTRUKSI KE PENYEDIA :</span><br>
                        ${instruksi}
                     </div>

                      <table style="width: 100%; border-collapse: collapse; border: 1px solid #000;">
                        <tr>
                            <td style="border: 1px solid #000; padding: 20px; width: 50%; text-align: center; vertical-align: top;">
                                <br>
                                <strong>Penyedia,</strong>
                                <br><br><br><br><br>
                                ..........................
                            </td>
                            <td style="border: 1px solid #000; padding: 10px; width: 50%; text-align: center; vertical-align: top;">
                                ${schoolData.kecamatan}, ${getDateText(tglSpk).fullDate}<br>
                                <strong>Pelaksana,</strong>
                                <br><br><br><br><br>
                                <strong>${schoolData.principal}</strong><br>
                                NIP. ${schoolData.principalNip}
                            </td>
                        </tr>
                      </table>
                </div>
             `;
        }



        // --- Toast Notification System ---
        function showToast(message, type = 'success', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.classList.add('toast', type);

            let iconHtml = '';
            if (type === 'success') {
                iconHtml = '<i data-lucide="check-circle" size="20"></i>';
            } else if (type === 'error') {
                iconHtml = '<i data-lucide="x-circle" size="20"></i>';
            } else {
                iconHtml = '<i data-lucide="info" size="20"></i>';
            }

            toast.innerHTML = `
                <div class="toast-icon">${iconHtml}</div>
                <div class="toast-content">
                    <div class="toast-title">${message}</div>
                </div>
            `;
            toastContainer.appendChild(toast);
            lucide.createIcons(); // Re-render lucide icons for the new toast

            setTimeout(() => {
                toast.classList.add('toast-out');
                toast.addEventListener('animationend', () => {
                    toast.remove();
                });
            }, duration);
        }

        // --- Custom Confirm Modal System ---
        let confirmCallback = null;

        function showConfirm(message, onConfirm, title = "Konfirmasi") {
            const confirmOverlay = document.getElementById('confirmOverlay');
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMessage').innerText = message;
            confirmCallback = onConfirm;
            confirmOverlay.style.display = 'flex';
            lucide.createIcons();
        }

        function closeConfirm(confirmed) {
            const confirmOverlay = document.getElementById('confirmOverlay');
            confirmOverlay.style.display = 'none';
            if (confirmed && confirmCallback) {
                confirmCallback();
            }
            confirmCallback = null; // Reset callback
        }


        // Action: Save School Data
        function saveData() {
            const formData = {
                schoolName: document.getElementById('schoolName').value,
                schoolAddress: document.getElementById('schoolAddress').value,
                npsn: document.getElementById('npsn').value,
                kecamatan: document.getElementById('kecamatan').value,
                principalName: document.getElementById('principalName').value,
                principalNip: document.getElementById('principalNip').value,
                treasurerName: document.getElementById('treasurerName').value,
                treasurerNip: document.getElementById('treasurerNip').value
            };

            const btn = document.querySelector('.btn-submit');
            const originalText = btn.innerHTML;

            // Visual feedback
            btn.innerHTML = '<i data-lucide="loader-2" class="spin" size="18"></i> Menyimpan...';
            lucide.createIcons();
            btn.disabled = true;

            google.script.run
                .withSuccessHandler((response) => {
                    showToast("Data Berhasil Disimpan!");
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    lucide.createIcons();
                })
                .withFailureHandler((err) => {
                    showToast("Gagal menyimpan: " + err, "error");
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    lucide.createIcons();
                })
                .saveSchoolData(formData);
        }

        let allTransactions = [];

        function renderTransactions(data) {
            allTransactions = data;
            const tbody = document.getElementById('transactionTbody');
            const container = document.getElementById('transactionTableContainer');
            const emptyState = document.getElementById('emptyState');

            if (data.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            emptyState.style.display = 'none';

            tbody.innerHTML = data.map(tx => `
                <tr class="hover-row" style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 16px; font-size: 14px;">${tx.tanggal}</td>
                    <td style="padding: 16px; font-size: 14px;"><span style="background: #eff6ff; color: #2563eb; padding: 4px 8px; border-radius: 4px; font-weight: 600;">${tx.noBukti}</span></td>
                    <td style="padding: 16px; font-size: 14px; max-width: 300px;">${tx.uraian}</td>
                    <td style="padding: 16px; font-size: 14px; font-weight: 600;">Rp ${tx.pengeluaran.toLocaleString('id-ID')}</td>
                    <td style="padding: 16px; display: flex; gap: 8px;">
                        <button class="btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="generateSpj('${tx.id}')" title="Cetak">
                            <i data-lucide="printer" size="14"></i>
                        </button>
                        <button class="btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="removeTransaction('${tx.id}')" title="Hapus">
                            <i data-lucide="trash-2" size="14"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        // --- Manual Transaction Logic ---
        function openAddModal() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('addDate').value = today;
            document.getElementById('addNoBukti').value = '';
            document.getElementById('addUraian').value = '';
            document.getElementById('addPenerima').value = '';
            document.getElementById('addJumlah').value = '';

            document.getElementById('addModal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }

        function saveManualTransaction() {
            const dateVal = document.getElementById('addDate').value;
            const noBukti = document.getElementById('addNoBukti').value;
            const uraian = document.getElementById('addUraian').value;
            const penerima = document.getElementById('addPenerima').value;
            const jumlah = parseFloat(document.getElementById('addJumlah').value);

            if (!dateVal || !noBukti || !uraian || !jumlah) {
                showToast("Mohon lengkapi Tanggal, No Bukti, Uraian, dan Jumlah.", "error");
                return;
            }

            // Format date dd/mm/yyyy
            const d = new Date(dateVal);
            const formattedDate = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;

            // Determine type automatically based on keywords
            let type = 'nota';
            let vendorStyle = 'standard';
            const uLow = uraian.toLowerCase();
            if (uLow.includes('honor') || uLow.includes('transport')) type = 'kwitansi';
            if (uLow.includes('makan') || uLow.includes('snack')) vendorStyle = 'rm-family';

            const newTx = {
                id: 'MANUAL_' + Date.now(),
                tanggal: formattedDate,
                noBukti: noBukti,
                uraian: uraian,
                pengeluaran: jumlah,
                penerima: penerima || uraian,
                type: type,
                vendorStyle: vendorStyle
            };

            allTransactions.push(newTx);
            renderTransactions(allTransactions);
            closeAddModal();

            // Show feedback
            document.getElementById('extractionInfo').innerText = `Total ${allTransactions.length} transaksi (Termasuk manual)`;
        }

        function removeTransaction(id) {
            showConfirm("Apakah Anda yakin ingin menghapus transaksi ini?", () => {
                allTransactions = allTransactions.filter(tx => tx.id !== id);
                renderTransactions(allTransactions);
                document.getElementById('extractionInfo').innerText = `Total ${allTransactions.length} transaksi`;
                showToast("Transaksi berhasil dihapus");
            });
        }

        function generateSpj(txId) {
            const tx = allTransactions.find(t => t.id === txId);
            if (!tx) return;

            // Pre-fill the customizer - (Redundant school fields removed from UI)

            document.getElementById('custVendorName').value = tx.penerima;
            document.getElementById('custVendorAddress').value = "Alamat " + tx.penerima;
            document.getElementById('custUraian').value = tx.uraian;
            document.getElementById('custJumlah').value = tx.pengeluaran;
            document.getElementById('custTanggal').value = tx.tanggal;
            document.getElementById('custTanggalPesan').value = tx.tanggal;
            document.getElementById('custTanggalKegiatan').value = tx.tanggal;
            document.getElementById('custNomorSurat').value = "020/SD-BOS/" + new Date().getFullYear();

            document.getElementById('custPerihal').value = (tx.type === 'konsumsi' ? "Belanja Konsumsi" : "Pesanan Barang/Jasa");
            document.getElementById('custTempatKegiatan').value = document.getElementById('schoolName').value || "Sekolah";
            document.getElementById('custWaktuKegiatan').value = "08.00 sd Selesai";
            document.getElementById('custTembusan').value = "1. Pengawas Pembina\n2. K3S Kecamatan " + (document.getElementById('kecamatan').value || "");

            const docTypeSelect = document.getElementById('docType');
            if (tx.type === 'konsumsi') {
                docTypeSelect.value = 'nota';
                document.getElementById('vendorStyle').value = tx.vendorStyle || 'standard';
            } else if (tx.type === 'jasa') {
                docTypeSelect.value = 'nota';
                document.getElementById('vendorStyle').value = 'toko-prima';
            } else {
                docTypeSelect.value = 'kwitansi';
            }

            handleDocTypeChange(); // This will trigger openPreview and auto-select template
            document.getElementById('previewModal').style.display = 'flex'; // Ensure modal opens
        }

        // --- Drive Picker Logic ---
        function openDrivePicker() {
            document.getElementById('driveModal').style.display = 'flex';
            document.getElementById('driveFileList').innerHTML = `
                                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                        <i data-lucide="loader-2" class="spin" size="32" style="margin-bottom: 10px;"></i>
                                        <p>Mencari file di Drive Anda...</p>
                                    </div>
                                    `;
            lucide.createIcons();

            google.script.run
                .withSuccessHandler((response) => {
                    const listDiv = document.getElementById('driveFileList');
                    if (response.success && response.files && response.files.length > 0) {
                        listDiv.innerHTML = response.files.map(file => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: 0.2s;" 
                                 onclick="processDriveFile('${file.id}', '${file.name}')"
                                 onmouseover="this.style.borderColor='#2563eb'; this.style.background='#eff6ff'"
                                 onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='#f8fafc'">
                                <div>
                                    <div style="font-weight: 600; font-size: 14px;">${file.name}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">${file.date}</div>
                                </div>
                                <i data-lucide="chevron-right" size="18" color="#2563eb"></i>
                            </div>
                        `).join('');
                    } else {
                        listDiv.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i data-lucide="search-x" size="48" style="margin-bottom: 10px; opacity: 0.3;"></i>
                                <p>Tidak ditemukan file PDF dengan nama "BKU" di Drive Anda.</p>
                                <button class="btn-primary" style="margin: 20px auto; font-size: 12px;" onclick="closeDrivePicker()">Tutup</button>
                            </div>
                        `;
                    }
                    lucide.createIcons();
                })
                .getBkuFilesFromDrive();
        }

        function closeDrivePicker() {
            document.getElementById('driveModal').style.display = 'none';
        }

        function processDriveFile(fileId, fileName) {
            closeDrivePicker();

            // Visual feedback on the main button card
            const driveCard = document.querySelector('.upload-card');
            const originalContent = driveCard.innerHTML;
            driveCard.innerHTML = `
                                    <div class="upload-icon-wrapper" style="background: #22c55e; color: white; width: 80px; height: 80px;">
                                        <i data-lucide="loader-2" class="spin" size="40"></i>
                                    </div>
                                    <h3 style="color: #166534;">Membaca File dari Drive...</h3>
                                    <p style="color: #166534;">${fileName}</p>
                                    `;
            lucide.createIcons();

            google.script.run
                .withSuccessHandler((response) => {
                    driveCard.innerHTML = originalContent;
                    lucide.createIcons();

                    if (response.success) {
                        renderTransactions(response.data);
                        document.getElementById('extractionInfo').innerText = `Ditemukan ${response.data.length} transaksi dari Excel: ${fileName}`;
                        showView('manage-view', document.querySelector('.nav-item[onclick*="manage-view"]'));
                    } else {
                        showToast("Gagal memproses file Excel: " + response.error, "error");
                    }
                })
                .processExcelByFileId(fileId);
        }
    </script>
    <style>
        .spin {
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</body>

</html>