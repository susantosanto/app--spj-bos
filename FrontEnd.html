<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si-BOS | Sistem Administrasi</title>
    <!-- Google Fonts: Outfit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Handwriting Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Kalam:wght@300;400;700&family=Nothing+You+Could+Do&family=Reenie+Beanie&family=Shadows+Into+Light&family=Patrick+Hand&family=Indie+Flower&family=Cedarville+Cursive&family=Zeyada&family=La+Belle+Aurore&family=Homemade+Apple&family=Just+Me+Again+Down+Here&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --sidebar-bg: #1e3a8a;
            --bg-main: #f8fafc;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --white: #ffffff;
            --sidebar-hover: rgba(255, 255, 255, 0.1);
            --sidebar-active: rgba(255, 255, 255, 0.2);
            --border: #e2e8f0;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-family: 'Outfit', sans-serif;
        }

        input,
        button,
        select,
        textarea {
            font-family: 'Outfit', sans-serif;
        }

        /* --- Sidebar Styles --- */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--sidebar-bg) 0%, #172554 100%);
            color: var(--white);
            display: flex;
            flex-direction: column;
            padding: 24px 16px;
            flex-shrink: 0;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 12px 32px 12px;
        }

        .logo-icon {
            background: var(--white);
            color: var(--sidebar-bg);
            padding: 8px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-text h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .logo-text p {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: var(--white);
            opacity: 0.8;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-item:hover {
            background: var(--sidebar-hover);
            opacity: 1;
        }

        .nav-item.active {
            background: var(--primary);
            opacity: 1;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        /* --- Custom Notification Styles --- */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 320px;
            pointer-events: auto;
            border-left: 4px solid var(--primary);
            animation: toastIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            position: relative;
            overflow: hidden;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.success {
            border-left-color: #10b981;
        }

        .toast-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .toast.success .toast-icon {
            background: #ecfdf5;
            color: #10b981;
        }

        .toast.error .toast-icon {
            background: #fef2f2;
            color: #ef4444;
        }

        .toast-content {
            flex-grow: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
        }

        @keyframes toastIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-out {
            animation: toastOut 0.3s ease-in forwards !important;
        }

        @keyframes toastOut {
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* --- Custom Confirm Modal --- */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 11000;
            animation: fadeIn 0.2s ease-out;
        }

        .confirm-modal {
            background: white;
            border-radius: 24px;
            padding: 32px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            animation: modalScaleUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes modalScaleUp {
            to {
                transform: scale(1);
            }
        }

        .confirm-icon {
            width: 64px;
            height: 64px;
            background: #fef2f2;
            color: #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .confirm-modal h3 {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
        }

        .confirm-modal p {
            font-size: 15px;
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .confirm-actions {
            display: flex;
            gap: 12px;
        }

        .confirm-actions button {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
        }

        .confirm-btn-cancel {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .confirm-btn-cancel:hover {
            background: #e2e8f0;
        }

        .confirm-btn-ok {
            background: #ef4444;
            color: white;
            border: none;
        }

        .confirm-btn-ok:hover {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .sidebar-footer {
            padding: 12px;
            font-size: 11px;
            opacity: 0.5;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- Clock Widget Styles --- */
        .clock-widget {
            background: var(--white);
            padding: 12px 24px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
            transition: var(--transition);
        }

        .clock-widget:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .clock-time {
            font-size: 32px;
            font-size: 42px;
            font-weight: 800;
            font-variant-numeric: tabular-nums;
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            background: linear-gradient(135deg, #7f1d1d 0%, #dc2626 50%, #ef4444 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.1;
            letter-spacing: -1px;
            letter-spacing: 6px;
            filter: drop-shadow(0 4px 10px rgba(220, 38, 38, 0.3));
        }

        .clock-date {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* --- Dashboard Styles --- */
        /* Layout Fix for Single Page */
        #dashboard-view.active {
            height: calc(100vh - 80px);
            /* Full height minus main-content padding */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .dashboard-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .dashboard-hero {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .hero-text h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 4px;
        }

        .hero-text p {
            font-size: 14px;
            color: var(--text-muted);
        }

        .dashboard-content-grid {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 24px;
            flex-grow: 1;
            overflow: hidden;
        }

        /* Stats Column */
        .stats-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .stat-card-modern {
            background: white;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
            transition: all 0.3s ease;
        }

        .stat-card-modern:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
            border-color: var(--primary);
        }

        .stat-icon-modern {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Quick Access Section */
        .quick-access-section {
            background: white;
            border-radius: 24px;
            padding: 30px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.03);
        }

        .qa-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            height: 100%;
            align-content: center;
        }

        .qa-card {
            background: #f8fafc;
            border-radius: 20px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            height: 100%;
        }

        .qa-card:hover {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 20px 25px -5px rgba(37, 99, 235, 0.1);
            transform: translateY(-5px) scale(1.02);
        }

        .qa-icon {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            transition: 0.3s;
        }

        .qa-card:hover .qa-icon {
            transform: scale(1.1) rotate(-5deg);
        }

        .qa-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 6px;
        }

        .qa-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* Modern Footer */
        .modern-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* --- Main Content Styles --- */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
            padding: 40px;
        }

        .view-section {
            display: none;
            animation: fadeIn 0.4s ease-out;
            max-width: 1200px;
            margin: 0 auto;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Upload View Styles --- */
        .header-center {
            text-align: center;
            margin-bottom: 48px;
        }

        .header-center h2 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1e293b;
        }

        .header-center p {
            color: var(--text-muted);
            font-size: 16px;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .upload-card {
            background: var(--white);
            border: 2px dashed #cbd5e1;
            border-radius: 20px;
            padding: 80px 40px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 60px;
            position: relative;
            overflow: hidden;
        }

        .upload-card:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.02);
            transform: scale(1.01);
        }

        .upload-icon-wrapper {
            width: 80px;
            height: 80px;
            background: #eff6ff;
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            transition: var(--transition);
        }

        .upload-card:hover .upload-icon-wrapper {
            background: var(--primary);
            color: var(--white);
        }

        .upload-card h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-card p {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #fileInput {
            display: none;
        }

        /* --- Info Cards --- */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .info-card {
            background: var(--white);
            padding: 32px 24px;
            border-radius: 16px;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }

        .info-card:hover {
            transform: translateY(-5px);
        }

        .info-card .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .info-card h4 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #1e293b;
        }

        .info-card p {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* --- Transaction View Styles --- */
        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .view-header-text h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .view-header-text p {
            color: var(--text-muted);
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .btn-danger {
            background: #ef4444;
            color: var(--white);
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        tr.hover-row:hover {
            background-color: #f8fafc;
        }

        .empty-state {
            background: var(--white);
            border: 2px dashed #e2e8f0;
            border-radius: 16px;
            padding: 100px 40px;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 48px;
            opacity: 0.2;
            margin-bottom: 16px;
        }

        /* --- Data Sekolah (Settings) Styles --- */
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }

        .settings-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
        }

        .settings-icon {
            background: #eff6ff;
            color: var(--primary);
            padding: 12px;
            border-radius: 12px;
        }

        .settings-title h3 {
            font-size: 20px;
            font-weight: 700;
        }

        .settings-title p {
            font-size: 14px;
            color: var(--text-muted);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: var(--transition);
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--white);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .btn-submit {
            grid-column: span 2;
            margin-top: 20px;
            width: 100%;
            justify-content: center;
            padding: 14px;
            font-size: 16px;
        }

        /* --- Preview Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-container {
            background: #e2e8f0;
            width: 95%;
            height: 90vh;
            border-radius: 20px;
            display: flex;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .preview-sidebar {
            width: 350px;
            background: var(--white);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            overflow-y: auto;
        }

        .preview-main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: #cbd5e1;
            position: relative;
        }

        .preview-toolbar {
            background: var(--white);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        /* --- Paper Simulation --- */
        .paper-viewport {
            flex-grow: 1;
            overflow: auto;
            padding: 40px;
            display: flex;
            justify-content: center;
        }

        .paper {
            background: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 40px;
            /* Standar Margin */
            box-sizing: border-box;
            transition: var(--transition);
            position: relative;
            transform-origin: top center;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .paper.a4 {
            width: 210mm;
            min-height: 297mm;
        }

        .paper.a5-landscape {
            width: 210mm;
            min-height: 148mm;
        }

        .paper.a5-portrait {
            width: 148mm;
            min-height: 210mm;
        }

        /* --- Print Styles --- */
        @media print {
            body * {
                visibility: hidden;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .paper,
            .paper * {
                visibility: visible;
            }

            .paper {
                position: absolute;
                left: 0;
                top: 0;
                width: 100% !important;
                box-shadow: none;
                padding: 0;
                margin: 0;
            }

            .modal-overlay {
                display: block !important;
                background: white;
            }

            .preview-sidebar,
            .preview-toolbar,
            .sidebar {
                display: none !important;
            }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .info-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-group.full-width {
                grid-column: span 1;
            }

            .btn-submit {
                grid-column: span 1;
            }
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-container">
            <div class="logo-icon">
                <i data-lucide="file-text" size="24"></i>
            </div>
            <div class="logo-text">
                <h1>Si-BOS</h1>
                <p>Sistem Administrasi</p>
            </div>
        </div>

        <div class="nav-menu">
            <a href="#" class="nav-item active" onclick="showView('dashboard-view', this)">
                <i data-lucide="home" size="18"></i>
                Dashboard
            </a>
            <a href="#" class="nav-item" onclick="showView('upload-view', this)">
                <i data-lucide="upload-cloud" size="18"></i>
                Unggah BKU
            </a>
            <a href="#" class="nav-item" onclick="showView('manage-view', this)">
                <i data-lucide="layout-grid" size="18"></i>
                Kelola Transaksi
            </a>
            <a href="#" class="nav-item" onclick="showView('settings-view', this)">
                <i data-lucide="school" size="18"></i>
                Data Sekolah
            </a>
            <a href="#" class="nav-item" onclick="showView('designer-view', this)">
                <i data-lucide="pen-tool" size="18"></i>
                Desain Nota
            </a>
        </div>

        <div class="sidebar-footer">
            &copy; 2026 - Developed By <b>Santo X/Code</b>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">

        <!-- View 0: Dashboard -->
        <section id="dashboard-view" class="view-section active">
            <div class="dashboard-container">
                <!-- Header Compact -->
                <div class="dashboard-hero">
                    <div class="hero-text">
                        <h1>Selamat Datang, Admin!</h1>
                        <p>Sistem Administrasi SPJ Bantuan Operasional Sekolah Terpadu.</p>
                    </div>
                    <div class="clock-widget">
                        <div class="clock-time" id="clock">00:00:00</div>
                        <div class="clock-date">
                            <i data-lucide="calendar" size="14"></i>
                            <span id="date">...</span>
                        </div>
                    </div>
                </div>

                <!-- Content Grid -->
                <div class="dashboard-content-grid">
                    <!-- Left: Stats -->
                    <div class="stats-column">
                        <div class="stat-card-modern">
                            <div class="stat-icon-modern" style="background: #eff6ff; color: #3b82f6;">
                                <i data-lucide="calendar" size="20"></i>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #64748b; font-weight: 600;">TAHUN ANGGARAN</div>
                                <div style="font-size: 18px; font-weight: 700; color: #0f172a;">2026</div>
                            </div>
                        </div>
                        <div class="stat-card-modern">
                            <div class="stat-icon-modern" style="background: #f0fdf4; color: #22c55e;">
                                <i data-lucide="check-circle-2" size="20"></i>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #64748b; font-weight: 600;">STATUS SISTEM</div>
                                <div style="font-size: 18px; font-weight: 700; color: #22c55e;">Online</div>
                            </div>
                        </div>
                        <div class="stat-card-modern"
                            style="flex-grow: 1; align-items: flex-start; flex-direction: column;">
                            <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                                <div class="stat-icon-modern" style="background: #fefce8; color: #eab308;">
                                    <i data-lucide="info" size="20"></i>
                                </div>
                                <div style="font-size: 11px; color: #64748b; font-weight: 600;">INFO TERBARU</div>
                            </div>
                            <div style="font-size: 12px; color: #475569; line-height: 1.5; margin-top: 5px;">
                                Versi 1.0.0 Stable.<br>
                                Fitur upload BKU dan cetak kwitansi otomatis telah aktif.
                            </div>
                        </div>
                    </div>

                    <!-- Right: Quick Access -->
                    <div class="quick-access-section">
                        <div
                            style="font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                            <i data-lucide="zap" size="18" style="color: #eab308; fill: #eab308;"></i> Akses Cepat
                        </div>
                        <div class="qa-grid">
                            <div class="qa-card"
                                onclick="document.querySelector('.nav-item[onclick*=\'upload-view\']').click()">
                                <div class="qa-icon" style="background: #eff6ff; color: #3b82f6;">
                                    <i data-lucide="upload-cloud" size="28"></i>
                                </div>
                                <div class="qa-title">Unggah BKU</div>
                                <div class="qa-desc">Import data Excel</div>
                            </div>
                            <div class="qa-card"
                                onclick="document.querySelector('.nav-item[onclick*=\'manage-view\']').click()">
                                <div class="qa-icon" style="background: #f0fdf4; color: #22c55e;">
                                    <i data-lucide="layout-grid" size="28"></i>
                                </div>
                                <div class="qa-title">Kelola Transaksi</div>
                                <div class="qa-desc">Edit & Cetak SPJ</div>
                            </div>
                            <div class="qa-card"
                                onclick="document.querySelector('.nav-item[onclick*=\'settings-view\']').click()">
                                <div class="qa-icon" style="background: #fefce8; color: #eab308;">
                                    <i data-lucide="school" size="28"></i>
                                </div>
                                <div class="qa-title">Data Sekolah</div>
                                <div class="qa-desc">Konfigurasi Kop</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modern Footer -->
                <div class="modern-footer">
                    <div>&copy; 2026 Si-BOS Administration System</div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        Architect by <span style="font-weight: 700; color: #2563eb;">SANTO X/CODE</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- View 1: Unggah BKU -->
        <section id="upload-view" class="view-section">
            <div class="header-center">
                <h2>Mulai Dokumentasi SPJ</h2>
                <p>Unggah file Buku Kas Umum (BKU) Anda. AI kami akan mengekstrak setiap transaksi belanja untuk
                    dibuatkan kwitansi dan kelengkapan nya otomatis.</p>
            </div>

            <div style="max-width: 600px; margin: 0 auto 60px;">
                <div class="upload-card" onclick="openDrivePicker()"
                    style="margin-bottom:0; border-style: solid; border-color: #22c55e; background: #f0fdf4; padding: 60px 40px;">
                    <div class="upload-icon-wrapper"
                        style="background: #22c55e; color: white; width: 80px; height: 80px;">
                        <i data-lucide="hard-drive" size="40"></i>
                    </div>
                    <h3 style="color: #166534; font-size: 24px;">Unggah File dari Google Drive</h3>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <div class="icon-box" style="background: rgba(249, 115, 22, 0.1); color: #f97316;">
                        <i data-lucide="file-search" size="24"></i>
                    </div>
                    <h4>Ekstraksi Pintar</h4>
                    <p>Secara otomatis mengenali toko, jumlah, dan jenis belanja sekolah.</p>
                </div>
                <div class="info-card">
                    <div class="icon-box" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
                        <i data-lucide="printer" size="24"></i>
                    </div>
                    <h4>Siap Cetak</h4>
                    <p>Kwitansi dan Nota diformat sesuai standar pelaporan Dana BOS.</p>
                </div>
                <div class="info-card">
                    <div class="icon-box" style="background: rgba(168, 85, 247, 0.1); color: #a855f7;">
                        <i data-lucide="check-circle" size="24"></i>
                    </div>
                    <h4>Akurat & Cepat</h4>
                    <p>Mengurangi kesalahan penulisan angka dan terbilang secara manual.</p>
                </div>
            </div>
        </section>

        <!-- View 2: Kelola Transaksi -->
        <section id="manage-view" class="view-section">
            <div class="view-header">
                <div class="view-header-text">
                    <h2>Kelola Transaksi BKU</h2>
                    <p id="extractionInfo">Daftar pengeluaran yang terdeteksi. Silakan periksa dan cetak dokumen.</p>
                </div>
                <button class="btn-primary" onclick="openAddModal()">
                    <i data-lucide="plus" size="18"></i>
                    Tambah Manual
                </button>
            </div>

            <div id="emptyState" class="empty-state">
                <div class="empty-icon">
                    <i data-lucide="alert-circle" size="64"></i>
                </div>
                <p>Belum ada data. Silakan unggah file BKU atau tambah manual.</p>
                <div style="margin-top: 20px;">
                    <button class="btn-primary" style="margin: 0 auto;" onclick="openPreview()">Demo Preview</button>
                </div>
            </div>

            <div id="transactionTableContainer" style="display: none;">
                <table
                    style="width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--card-shadow);">
                    <thead>
                        <tr style="background: #f1f5f9; text-align: left;">
                            <th style="padding: 16px; font-size: 13px;">Tanggal</th>
                            <th style="padding: 16px; font-size: 13px;">No Bukti</th>
                            <th style="padding: 16px; font-size: 13px;">Uraian</th>
                            <th style="padding: 16px; font-size: 13px;">Jumlah</th>
                            <th style="padding: 16px; font-size: 13px;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTbody">
                        <!-- Items injected via JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- View 4: Desain Nota Custom -->
        <section id="designer-view" class="view-section">
            <div class="settings-container">
                <div class="settings-header">
                    <div class="settings-icon" style="background: #f0fdf4; color: #16a34a;">
                        <i data-lucide="pen-tool" size="32"></i>
                    </div>
                    <div class="settings-title">
                        <h3>Konfigurasi Nota Custom</h3>
                        <p>Buat template nota standar dengan identitas toko Anda sendiri.</p>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Nama Template (Untuk disimpan di list)</label>
                        <input type="text" id="customTplName" placeholder="Contoh: Toko Bangunan Sejahtera">
                    </div>

                    <div class="form-group">
                        <label>Nama Toko / Vendor</label>
                        <input type="text" id="customStoreName" placeholder="Nama Toko">
                    </div>

                    <div class="form-group">
                        <label>Alamat Toko</label>
                        <input type="text" id="customStoreAddress" placeholder="Alamat Lengkap">
                    </div>

                    <div class="form-group">
                        <label>Warna Tema Nota</label>
                        <select id="customStoreColor"
                            style="width: 100%; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px;">
                            <option value="#000000">Hitam (Standard)</option>
                            <option value="#1e40af">Biru (Professional)</option>
                            <option value="#b91c1c">Merah (Classic)</option>
                            <option value="#15803d">Hijau (Fresh)</option>
                            <option value="#d97706">Oranye (Modern)</option>
                            <option value="#7e22ce">Ungu (Creative)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Logo Toko (Opsional, Max 500KB)</label>
                        <input type="file" id="customStoreLogo" accept="image/*" style="font-size: 12px;">
                    </div>

                    <button type="button" class="btn-primary btn-submit" onclick="saveCustomTemplate()">
                        <i data-lucide="plus-circle" size="18"></i>
                        Simpan & Buat Template
                    </button>
                </div>
            </div>
        </section>

        <!-- View 3: Data Sekolah -->
        <section id="settings-view" class="view-section">
            <div class="settings-container">
                <div class="settings-header">
                    <div class="settings-icon">
                        <i data-lucide="school" size="32"></i>
                    </div>
                    <div class="settings-title">
                        <h3>Konfigurasi Sekolah</h3>
                        <p>Sesuaikan informasi sekolah untuk kop surat & tanda tangan.</p>
                    </div>
                </div>

                <form id="schoolForm">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Nama Sekolah</label>
                            <input type="text" id="schoolName" name="schoolName"
                                placeholder="Contoh: SD NEGERI 01 CONTOH">
                        </div>
                        <div class="form-group full-width">
                            <label>Alamat Lengkap</label>
                            <input type="text" id="schoolAddress" name="schoolAddress"
                                placeholder="Jl. Pendidikan No. 123">
                        </div>
                        <div class="form-group">
                            <label>NPSN</label>
                            <input type="text" id="npsn" name="npsn" placeholder="12345678">
                        </div>
                        <div class="form-group">
                            <label>Kecamatan</label>
                            <input type="text" id="kecamatan" name="kecamatan" placeholder="Contoh: Kec. Ilmu">
                        </div>
                        <div class="form-group">
                            <label>Nama Kepala Sekolah</label>
                            <input type="text" id="principalName" name="principalName"
                                placeholder="Nama Lengkap & Gelar">
                        </div>
                        <div class="form-group">
                            <label>NIP Kepala Sekolah</label>
                            <input type="text" id="principalNip" name="principalNip"
                                placeholder="19XXXXXXXX XXXXXX X XXX">
                        </div>
                        <div class="form-group">
                            <label>Nama Bendahara</label>
                            <input type="text" id="treasurerName" name="treasurerName"
                                placeholder="Nama Lengkap & Gelar">
                        </div>
                        <div class="form-group">
                            <label>NIP Bendahara</label>
                            <input type="text" id="treasurerNip" name="treasurerNip"
                                placeholder="19XXXXXXXX XXXXXX X XXX">
                        </div>

                        <button type="button" class="btn-primary btn-submit" onclick="saveData()">
                            <i data-lucide="save" size="18"></i>
                            Simpan Perubahan
                        </button>
                    </div>
                </form>
            </div>

            <!-- Backup & Restore Section -->
            <div class="settings-container" style="margin-top: 30px;">
                <div class="settings-header">
                    <div class="settings-icon" style="background: #f0fdf4; color: #16a34a;">
                        <i data-lucide="database" size="32"></i>
                    </div>
                    <div class="settings-title">
                        <h3>Backup & Restore Data</h3>
                        <p>Simpan data transaksi dan konfigurasi ke file komputer Anda.</p>
                    </div>
                </div>
                <div class="form-grid">
                    <button type="button" class="btn-primary" onclick="backupData()" style="background: #0ea5e9;">
                        <i data-lucide="download" size="18"></i> Download Backup (.json)
                    </button>
                    <button type="button" class="btn-primary" onclick="document.getElementById('restoreFile').click()"
                        style="background: #64748b;">
                        <i data-lucide="upload" size="18"></i> Restore Data
                    </button>
                    <input type="file" id="restoreFile" accept=".json" style="display: none;"
                        onchange="restoreData(this)">
                </div>
            </div>
        </section>

        <!-- Preview Modal -->
        <div id="previewModal" class="modal-overlay">
            <div class="modal-container">
                <div class="preview-sidebar">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h3 style="font-size: 18px; font-weight: 700;">Customizer</h3>
                        <button onclick="closePreview()"
                            style="background:none; border:none; cursor:pointer; color: var(--text-muted);">
                            <i data-lucide="x" size="20"></i>
                        </button>
                    </div>




                    <div class="form-group">
                        <label>Jenis Dokumen</label>
                        <select id="docType" onchange="handleDocTypeChange()"
                            style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                            <option value="kwitansi">Kwitansi SPJ</option>
                            <option value="nota">Nota Toko / Invoice</option>
                            <option value="pesanan">Surat Pesanan (Formal)</option>
                            <option value="berita_acara">Berita Acara Serah Terima</option>
                            <option value="undangan">Surat Undangan</option>
                            <option value="notulen">Notulen Kegiatan</option>
                            <option value="daftar_hadir">Daftar Hadir</option>
                            <option value="dokumentasi">Lembar Dokumentasi</option>
                            <option value="rencana">Dokumen Perencanaan</option>
                            <option value="spk">Surat Perintah Kerja (SPK)</option>
                        </select>
                    </div>

                    <div class="form-group" id="fg-nomor">
                        <label>Nomor Surat / Berita Acara / SPK</label>
                        <input type="text" id="custNomorSurat" oninput="updatePreview()"
                            placeholder="Contoh: 001/SD/2025">
                    </div>

                    <div class="form-group" id="fg-perihal">
                        <label>Perihal / Subject</label>
                        <input type="text" id="custPerihal" oninput="updatePreview()"
                            placeholder="Contoh: Undangan Lomba">
                    </div>

                    <div class="form-group" id="fg-vendor-style">
                        <label>Template Vendor</label>
                        <select id="vendorStyle" onchange="updatePreview()"
                            style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                            <option value="standard">Standard / Modern</option>
                            <option value="plain">Grosir / Polos</option>
                            <option value="rm-family">RM Family (Landscape)</option>
                            <option value="cahya-cellular">Cahya Cellular (Blue)</option>
                            <option value="media-komputer">Media Komputer (Media)</option>
                            <option value="mitra-photocopy">Mitra Photocopy (Service)</option>
                            <option value="sinar-abadi">Sinar Abadi (Classic Red)</option>
                            <!-- Custom templates will be appended here -->
                        </select>
                    </div>

                    <div class="form-group" id="fg-font-style">
                        <label>Jenis Font (Tulisan Tangan)</label>
                        <select id="fontStyle" onchange="updatePreview()"
                            style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                            <option value="">Default (Arial/System)</option>
                            <option value="'Caveat', cursive">Tulisan Tangan 1 (Caveat)</option>
                            <option value="'Kalam', cursive">Tulisan Tangan 2 (Kalam)</option>
                            <option value="'Patrick Hand', cursive">Tulisan Tangan 3 (Patrick Hand - Natural)</option>
                            <option value="'Indie Flower', cursive">Tulisan Tangan 4 (Indie Flower - Santai)</option>
                            <option value="'Reenie Beanie', cursive">Tulisan Tangan 5 (Kasar/Reenie)</option>
                            <option value="'Shadows Into Light', cursive">Tulisan Tangan 6 (Rapi/Shadows)</option>
                            <option value="'Nothing You Could Do', cursive">Tulisan Tangan 7 (Realistis/Nothing)
                            </option>
                            <option value="'Cedarville Cursive', cursive">Tulisan Tangan 8 (Sangat Natural)</option>
                            <option value="'Zeyada', cursive">Tulisan Tangan 9 (Berantakan)</option>
                            <option value="'La Belle Aurore', cursive">Tulisan Tangan 10 (Cepat/Kasar)</option>
                            <option value="'Homemade Apple', cursive">Tulisan Tangan 11 (Miring/Jelek)</option>
                            <option value="'Just Me Again Down Here', cursive">Tulisan Tangan 12 (Kurus/Tinggi)</option>
                        </select>
                    </div>

                    <div class="form-group" id="fg-font-size">
                        <label>Ukuran Tulisan (px)</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="range" id="fontSize" min="12" max="36" value="16" oninput="updatePreview()"
                                style="flex-grow: 1;">
                            <span id="fontSizeDisplay" style="font-size: 12px; width: 30px;">16px</span>
                        </div>
                    </div>

                    <div class="form-group" id="fg-vendor-name">
                        <label>Nama Vendor / Toko / Penerima</label>
                        <input type="text" id="custVendorName" oninput="updatePreview()" placeholder="NAMA TOKO">
                    </div>

                    <div class="form-group" id="fg-uraian">
                        <label>Uraian Belanja / Kegiatan</label>
                        <textarea id="custUraian" oninput="updatePreview()" rows="3"
                            style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></textarea>
                    </div>

                    <div class="form-group" id="fg-jumlah">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label>Nominal / Anggaran / Total (Rp)</label>
                            <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;">
                                <input type="checkbox" id="manualTotal" onchange="updatePreview()"> Hitung Otomatis
                            </label>
                        </div>
                        <input type="number" id="custJumlah" oninput="updatePreview()">
                    </div>

                    <!-- Extra Fields for Rencana -->
                    <div id="rencanaExtraSection"
                        style="display: none; border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
                        <label style="font-weight: bold; font-size: 14px; margin-bottom: 10px; display: block;">Detail
                            Perencanaan</label>
                        <div class="form-group">
                            <label>Kategori Barang/Jasa</label>
                            <input type="text" id="custKategori" oninput="updatePreview()"
                                placeholder="Contoh: Pemeliharaan Laptop Sekolah">
                        </div>
                        <div class="form-group">
                            <label>Jumlah Barang/Jasa (Teks)</label>
                            <input type="text" id="custJumlahBarang" oninput="updatePreview()"
                                placeholder="Contoh: 1 (Satu) Paket">
                        </div>
                        <div class="form-group">
                            <label>Spesifikasi / Ruang Lingkup</label>
                            <textarea id="custSpesifikasi" oninput="updatePreview()" rows="2"
                                style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;"
                                placeholder="Contoh: Belanja Jasa Service Laptop"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Persyaratan Penyedia</label>
                            <textarea id="custPersyaratan" oninput="updatePreview()" rows="3"
                                style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;">Perorangan/Badan Usaha Memenuhi syarat sebagai berikut:\na. Identitas Penyedia;</textarea>
                        </div>
                        <div style="margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px;">
                            <label style="font-size: 12px; font-weight: bold;">Pelaksana (Opsional - Default: Kepala
                                Sekolah)</label>
                            <input type="text" id="custPelaksanaNameRencana" oninput="updatePreview()"
                                placeholder="Nama Pelaksana" style="margin-bottom: 5px;">
                            <input type="text" id="custPelaksanaNipRencana" oninput="updatePreview()"
                                placeholder="NIP Pelaksana">
                        </div>
                    </div>

                    <!-- Extra Fields for SPK -->
                    <div id="spkExtraSection"
                        style="display: none; border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
                        <label style="font-weight: bold; font-size: 14px; margin-bottom: 10px; display: block;">Detail
                            SPK</label>
                        <div class="form-group">
                            <label>Nama Penyedia (CV / Toko)</label>
                            <input type="text" id="custSpkProvider" oninput="updatePreview()"
                                placeholder="Contoh: CV. Berkah Abadi">
                        </div>
                        <div class="form-group">
                            <label>Tanggal Negosiasi</label>
                            <input type="text" id="custTglNegosiasi" oninput="updatePreview()" placeholder="dd/mm/yyyy">
                        </div>
                        <div class="form-group">
                            <label>Waktu Pelaksanaan</label>
                            <input type="text" id="custWaktuPelaksanaan" oninput="updatePreview()"
                                placeholder="dd/mm/yyyy (Default: Tanggal Transaksi)">
                        </div>
                        <div class="form-group">
                            <label>Waktu Penyelesaian</label>
                            <input type="text" id="custWaktuPenyelesaian" oninput="updatePreview()"
                                placeholder="Contoh: 06 Juni 2025">
                        </div>
                        <div class="form-group">
                            <label>Instruksi ke Penyedia</label>
                            <textarea id="custInstruksi" oninput="updatePreview()" rows="3"
                                style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;">Penagihan hanya dapat dilakukan setelah penyelesaian pekerjaan yang diperintahkan dalam SPK ini dan dibuktikan dengan Berita Acara Serah Terima.</textarea>
                        </div>
                        <div style="margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px;">
                            <label style="font-size: 12px; font-weight: bold;">Pelaksana (Opsional - Default: Kepala
                                Sekolah)</label>
                            <input type="text" id="custPelaksanaNameSpk" oninput="updatePreview()"
                                placeholder="Nama Pelaksana" style="margin-bottom: 5px;">
                            <input type="text" id="custPelaksanaNipSpk" oninput="updatePreview()"
                                placeholder="NIP Pelaksana">
                        </div>
                    </div>

                    <!-- Dynamic Items for Nota -->
                    <div id="notaItemsSection"
                        style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; display: none;">
                        <label style="font-weight: bold; font-size: 14px; margin-bottom: 10px; display: block;">Rincian
                            Barang (Khusus Nota)</label>
                        <div id="notaItemsList" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Items will be added here -->
                        </div>
                        <button onclick="addNotaItem()" class="btn-primary"
                            style="margin-top: 10px; padding: 5px 10px; font-size: 12px; background: #22c55e;">
                            <i data-lucide="plus" size="14"></i> Tambah Item
                        </button>
                    </div>

                    <!-- Documentation Section -->
                    <div id="documentationSection"
                        style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; display: none;">
                        <label style="font-weight: bold; font-size: 14px; margin-bottom: 10px; display: block;">Foto
                            Kegiatan</label>

                        <div class="form-group">
                            <label>Jumlah Foto</label>
                            <select id="docPhotoCount" onchange="updatePhotoInputs()"
                                style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
                                <option value="1">1 Foto</option>
                                <option value="2">2 Foto</option>
                                <option value="3">3 Foto</option>
                                <option value="4">4 Foto</option>
                                <option value="5">5 Foto</option>
                            </select>
                        </div>

                        <div id="docPhotoInputsContainer">
                            <!-- Inputs will be handled dynamically or just pre-rendered -->
                            <div class="form-group" id="ph-1">
                                <label style="font-size:11px;">Foto 1</label>
                                <input type="file" onchange="handleDocPhotoUpload(this, 1)" accept="image/*"
                                    style="font-size: 11px; width: 100%;">
                            </div>
                            <div class="form-group" id="ph-2" style="display:none;">
                                <label style="font-size:11px;">Foto 2</label>
                                <input type="file" onchange="handleDocPhotoUpload(this, 2)" accept="image/*"
                                    style="font-size: 11px; width: 100%;">
                            </div>
                            <div class="form-group" id="ph-3" style="display:none;">
                                <label style="font-size:11px;">Foto 3</label>
                                <input type="file" onchange="handleDocPhotoUpload(this, 3)" accept="image/*"
                                    style="font-size: 11px; width: 100%;">
                            </div>
                            <div class="form-group" id="ph-4" style="display:none;">
                                <label style="font-size:11px;">Foto 4</label>
                                <input type="file" onchange="handleDocPhotoUpload(this, 4)" accept="image/*"
                                    style="font-size: 11px; width: 100%;">
                            </div>
                            <div class="form-group" id="ph-5" style="display:none;">
                                <label style="font-size:11px;">Foto 5</label>
                                <input type="file" onchange="handleDocPhotoUpload(this, 5)" accept="image/*"
                                    style="font-size: 11px; width: 100%;">
                            </div>
                        </div>
                    </div>

                    <!-- Notulen Section -->
                    <div id="notulenSection"
                        style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; display: none;">
                        <div class="form-group">
                            <label>Waktu Kegiatan</label>
                            <input type="text" id="custWaktu" oninput="updatePreview()"
                                placeholder="Contoh: 08.00 - 10.00 WIB">
                        </div>
                        <div class="form-group">
                            <label>Hasil Pembahasan (Pisahkan dengan Enter)</label>
                            <textarea id="custHasil" oninput="updatePreview()" rows="5"
                                placeholder="1. Poin satu&#10;2. Poin dua"
                                style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Kesimpulan</label>
                            <textarea id="custKesimpulan" oninput="updatePreview()" rows="3"
                                placeholder="Kesimpulan rapat..."
                                style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></textarea>
                        </div>
                    </div>

                    <!-- Attendance Section -->
                    <div id="attendanceSection"
                        style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; display: none;">
                        <label style="font-weight: bold; font-size: 14px; margin-bottom: 5px; display: block;">Daftar
                            Hadir</label>
                        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                            <button onclick="addAttendanceRow()" class="btn-primary"
                                style="flex:1; padding: 5px; font-size: 11px; background: #22c55e;">
                                <i data-lucide="plus" size="12"></i> Baris
                            </button>
                            <button onclick="loadDefaultAttendance()" class="btn-primary"
                                style="flex:1; padding: 5px; font-size: 11px; background: #3b82f6;">
                                <i data-lucide="users" size="12"></i> Load Guru
                            </button>
                        </div>
                        <div id="attendanceList" style="display: flex; flex-direction: column; gap: 5px;"></div>
                    </div>



                    <div class="form-group" id="fg-tanggal">
                        <label>Tanggal Transaksi / BAST / SPK / Serah Terima</label>
                        <input type="text" id="custTanggal" oninput="updatePreview()" placeholder="dd/mm/yyyy">
                    </div>

                    <div class="form-group" id="fg-tanggal-pesan">
                        <label>Tanggal Surat / Pesan</label>
                        <input type="text" id="custTanggalPesan" oninput="updatePreview()" placeholder="dd/mm/yyyy">
                    </div>

                    <div class="form-group" id="fg-tanggal-kegiatan">
                        <label>Tanggal Kegiatan</label>
                        <input type="text" id="custTanggalKegiatan" oninput="updatePreview()" placeholder="dd/mm/yyyy">
                    </div>

                    <div class="form-group" id="fg-tempat">
                        <label>Tempat Kegiatan / Lokasi</label>
                        <input type="text" id="custTempatKegiatan" oninput="updatePreview()"
                            placeholder="Contoh: SD Negeri 1 ...">
                    </div>

                    <div class="form-group" id="fg-waktu-kegiatan">
                        <label>Waktu Kegiatan</label>
                        <input type="text" id="custWaktuKegiatan" oninput="updatePreview()"
                            placeholder="Contoh: 08.00 sd Selesai">
                    </div>

                    <div class="form-group" id="fg-vendor-address">
                        <label>Alamat Vendor / Toko</label>
                        <input type="text" id="custVendorAddress" oninput="updatePreview()" placeholder="Alamat Toko">
                    </div>

                    <div class="form-group" id="fg-tembusan">
                        <label>Tembusan (Opsional)</label>
                        <textarea id="custTembusan" oninput="updatePreview()" rows="2"
                            style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;"
                            placeholder="1. Pengawas...&#10;2. K3S..."></textarea>
                    </div>

                    <div class="form-group" id="fg-logo-upload">
                        <label>Logo Toko</label>
                        <input type="file" accept="image/*" onchange="handleLogoUpload(this)"
                            style="font-size: 11px; width: 100%;">
                    </div>

                    <div class="form-group" id="fg-stamp-upload">
                        <label>Stempel Toko / Penyedia</label>
                        <input type="file" accept="image/*" onchange="handleStampUpload(this)"
                            style="font-size: 11px; width: 100%;">
                    </div>

                    <div style="margin-top: auto;">
                        <label>Layout</label>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="changeLayout('portrait')" style="flex:1; padding:8px; font-size:12px;"
                                class="btn-primary">Portrait</button>
                            <button onclick="changeLayout('landscape')" style="flex:1; padding:8px; font-size:12px;"
                                class="btn-primary">Landscape</button>
                        </div>
                    </div>
                </div>

                <div class="preview-main">
                    <div class="preview-toolbar">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="range" min="30" max="150" value="80" oninput="zoomPreview(this.value)">
                            <span id="zoomLevel" style="font-size: 13px; font-weight: 500;">Scale: 80%</span>
                        </div>
                        <button class="btn-primary" onclick="window.print()">
                            <i data-lucide="printer" size="18"></i>
                            Cetak Dokumen
                        </button>
                    </div>

                    <div class="paper-viewport">
                        <div id="paper" class="paper a4">
                            <div id="paperContent">
                                <!-- Konten Dokumen Dinamis -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Manual Transaction Modal -->
        <div id="addModal" class="modal-overlay">
            <div class="modal-container" style="max-width: 500px; height: auto; flex-direction: column; padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 20px; font-weight: 700;">Tambah Transaksi Manual</h3>
                    <button onclick="closeAddModal()" style="background:none; border:none; cursor:pointer;">
                        <i data-lucide="x" size="20"></i>
                    </button>
                </div>

                <div class="form-group">
                    <label>Tanggal</label>
                    <input type="date" id="addDate">
                </div>
                <div class="form-group">
                    <label>No Bukti</label>
                    <input type="text" id="addNoBukti" placeholder="Contoh: BKU-001">
                </div>
                <div class="form-group">
                    <label>Uraian Belanja</label>
                    <input type="text" id="addUraian" placeholder="Contoh: Belanja ATK Kegiatan...">
                </div>
                <div class="form-group">
                    <label>Penerima / Toko</label>
                    <input type="text" id="addPenerima" placeholder="Contoh: Toko Abadi">
                </div>
                <div class="form-group">
                    <label>Jumlah (Rp)</label>
                    <input type="number" id="addJumlah" placeholder="0">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-primary" style="background: #64748b; flex: 1;" onclick="closeAddModal()">
                        Batal
                    </button>
                    <button class="btn-primary" style="flex: 1;" onclick="saveManualTransaction()">
                        <i data-lucide="save" size="18"></i>
                        Simpan
                    </button>
                </div>
            </div>
        </div>

        <!-- Drive Picker Modal -->
        <div id="driveModal" class="modal-overlay">
            <div class="modal-container"
                style="max-width: 600px; height: 500px; flex-direction: column; padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 20px; font-weight: 700;">File BKU di Google Drive</h3>
                    <button onclick="closeDrivePicker()" style="background:none; border:none; cursor:pointer;">
                        <i data-lucide="x" size="20"></i>
                    </button>
                </div>
                <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 20px;">Menampilkan file PDF terbaru
                    yang mengandung kata "BKU" di Drive Anda.</p>

                <div id="driveFileList"
                    style="flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i data-lucide="loader-2" class="spin" size="32" style="margin-bottom: 10px;"></i>
                        <p>Mencari file...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Custom Confirm Modal -->
    <div id="confirmOverlay" class="confirm-overlay">
        <div class="confirm-modal">
            <div class="confirm-icon">
                <i data-lucide="alert-triangle" size="32"></i>
            </div>
            <h3 id="confirmTitle">Konfirmasi Hapus</h3>
            <p id="confirmMessage">Apakah Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="confirm-actions">
                <button class="confirm-btn-cancel" onclick="closeConfirm(false)">Batal</button>
                <button class="confirm-btn-ok" onclick="closeConfirm(true)">Hapus Data</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        // Load Initial Data
        window.addEventListener('load', () => {
            // Load School Data from LocalStorage
            const savedSchoolData = JSON.parse(localStorage.getItem('spj_school_data') || '{}');
            if (savedSchoolData) {
                document.getElementById('schoolName').value = savedSchoolData.schoolName || '';
                document.getElementById('schoolAddress').value = savedSchoolData.schoolAddress || '';
                document.getElementById('npsn').value = savedSchoolData.npsn || '';
                document.getElementById('kecamatan').value = savedSchoolData.kecamatan || '';
                document.getElementById('principalName').value = savedSchoolData.principalName || '';
                document.getElementById('principalNip').value = savedSchoolData.principalNip || '';
                document.getElementById('treasurerName').value = savedSchoolData.treasurerName || '';
                document.getElementById('treasurerNip').value = savedSchoolData.treasurerNip || '';
            }

            loadCustomTemplates(); // Load saved custom templates
            startRealtimeClock();

        });

        // View Navigation Logic
        function showView(viewId, element) {
            // Remove active class from all sections
            const sections = document.querySelectorAll('.view-section');
            sections.forEach(sec => sec.classList.remove('active'));

            // Show target section
            document.getElementById(viewId).classList.add('active');

            // Update sidebar UI
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            element.classList.add('active');

            // Refresh icons in case any were hidden
            lucide.createIcons();
        }

        // --- Realtime Clock Logic ---
        function startRealtimeClock() {
            function update() {
                const now = new Date();
                const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

                const dayName = days[now.getDay()];
                const day = now.getDate();
                const month = months[now.getMonth()];
                const year = now.getFullYear();

                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                const s = String(now.getSeconds()).padStart(2, '0');

                document.getElementById('clock').innerText = `${h}:${m}:${s}`;
                document.getElementById('date').innerText = `${dayName}, ${day} ${month} ${year}`;
            }
            setInterval(update, 1000);
            update();
        }

        // --- Backup & Restore Logic ---
        function backupData() {
            const data = {
                transactions: allTransactions,
                customTemplates: JSON.parse(localStorage.getItem('spj_custom_templates') || '{}'),
                timestamp: new Date().toISOString()
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "backup_sibos_" + new Date().toISOString().slice(0, 10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function restoreData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (data.transactions) {
                        allTransactions = data.transactions;
                        renderTransactions(allTransactions);
                        document.getElementById('extractionInfo').innerText = `Total ${allTransactions.length} transaksi (Restored)`;
                    }

                    if (data.customTemplates) {
                        localStorage.setItem('spj_custom_templates', JSON.stringify(data.customTemplates));
                        if (typeof loadCustomTemplates === 'function') loadCustomTemplates();
                    }

                    showToast("Data berhasil dipulihkan!");
                } catch (err) {
                    showToast("Gagal memproses file backup: " + err, "error");
                }
            };
            reader.readAsText(file);
            input.value = ''; // reset
        }

        // --- Custom Template Logic ---
        function saveCustomTemplate() {
            const name = document.getElementById('customTplName').value.trim();
            const storeName = document.getElementById('customStoreName').value.trim();
            const storeAddress = document.getElementById('customStoreAddress').value.trim();
            const themeColor = document.getElementById('customStoreColor').value;
            const logoInput = document.getElementById('customStoreLogo');

            if (!name || !storeName) {
                showToast("Nama Template dan Nama Toko wajib diisi!", "error");
                return;
            }

            // Helper to process save after getting logo (or not)
            const processSave = (logoBase64) => {
                // Construct Standard HTML Template with injected values
                // Note: We escape ${} for dynamic variables that should be evaluated later in updatePreview

                const html = `
                    <div style="font-family: Arial, sans-serif; border: 1px solid #ccc; padding: 40px; background: #fff; color: #000;">
                        <!-- Header -->
                        <div style="display: flex; justify-content: space-between; border-bottom: 3px double ${themeColor}; padding-bottom: 20px; margin-bottom: 20px;">
                            <div style="display: flex; gap: 20px; align-items: center;">
                                ${logoBase64 ? `<img src="${logoBase64}" style="height: 70px; width: auto; object-fit: contain;">` : ''}
                                <div>
                                    <h1 style="margin: 0; font-size: 26px; font-weight: 800; text-transform: uppercase; color: ${themeColor};">${storeName}</h1>
                                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #555; max-width: 300px;">${storeAddress}</p>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <h2 style="margin: 0; font-size: 28px; color: #ccc; letter-spacing: 2px;">NOTA</h2>
                                <p style="font-size: 13px; margin: 5px 0 0 0; font-weight: bold;">${'${tanggal}'}</p>
                                <p style="font-size: 13px; margin: 2px 0 0 0;">Kepada: <strong>${'${schoolData.name}'}</strong></p>
                            </div>
                        </div>
                        
                        <!-- Table -->
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px;">
                            <thead>
                                <tr style="background: ${themeColor}; color: #fff;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid ${themeColor};">URAIAN BARANG</th>
                                    <th style="padding: 12px; width: 60px; text-align: center; border: 1px solid ${themeColor};">QTY</th>
                                    <th style="padding: 12px; width: 120px; text-align: right; border: 1px solid ${themeColor};">HARGA</th>
                                    <th style="padding: 12px; width: 140px; text-align: right; border: 1px solid ${themeColor};">TOTAL</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${'${itemsHtml}'.replace(/border-right: 2px solid #000/g, 'border: 1px solid #ddd').replace(/border-bottom: 1px solid #000/g, 'border: 1px solid #ddd')}
                            </tbody>
                            <tfoot>
                                <tr style="font-weight: bold;">
                                    <td colspan="3" style="border: 1px solid #ddd; padding: 12px; text-align: right;">TOTAL TAGIHAN</td>
                                    <td style="border: 1px solid #ddd; padding: 12px; text-align: right; color: ${themeColor}; font-size: 14px;">Rp ${'${jumlah.toLocaleString(\'id-ID\')}'}</td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <!-- Footer / Signature -->
                        <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                            <div style="text-align: center; width: 180px;">
                                <p style="margin-bottom: 70px; font-size: 12px;">Tanda Terima,</p>
                                <div style="border-bottom: 1px solid #000;"></div>
                            </div>
                            <div style="text-align: center; width: 180px;">
                                <p style="margin-bottom: 70px; font-size: 12px;">Hormat Kami,</p>
                                <p style="font-weight: bold; margin: 0; font-size: 13px; color: ${themeColor};">${storeName}</p>
                            </div>
                        </div>
                    </div>
                `;

                // Save to LocalStorage
                try {
                    let templates = JSON.parse(localStorage.getItem('spj_custom_templates') || '{}');
                    templates['custom_' + name.replace(/\s+/g, '_')] = { name: name, html: html };
                    localStorage.setItem('spj_custom_templates', JSON.stringify(templates));

                    showToast("Template Nota berhasil dibuat & disimpan!");
                    loadCustomTemplates();
                    // Reset form
                    document.getElementById('customTplName').value = '';
                    document.getElementById('customStoreName').value = '';
                } catch (e) {
                    showToast("Gagal menyimpan (Mungkin ukuran logo terlalu besar): " + e.message, "error");
                }
            };

            // Handle File Upload
            if (logoInput.files && logoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) { processSave(e.target.result); };
                reader.onerror = function () { showToast("Gagal membaca file logo", "error"); };
                reader.readAsDataURL(logoInput.files[0]);
            } else {
                processSave(null);
            }
        }

        function loadCustomTemplates() {
            const select = document.getElementById('vendorStyle');
            // Remove existing custom options (identified by value starting with 'custom_')
            Array.from(select.options).forEach(opt => {
                if (opt.value.startsWith('custom_')) opt.remove();
            });

            const templates = JSON.parse(localStorage.getItem('spj_custom_templates') || '{}');
            Object.keys(templates).forEach(key => {
                const opt = new Option(" " + templates[key].name + " (Custom)", key);
                select.add(opt);
            });
        }

        // --- Document Generation Logic ---
        let currentScale = 0.8;
        let currentLayout = 'portrait';
        let logoBase64 = null;
        let stampBase64 = null;
        // let availableTemplates = []; // Removed
        // let cachedTemplateHtml = ""; // Removed
        // let currentTemplateId = ""; // Removed
        let logoKBBBase64 = null;
        let docPhotos = {}; // Replaced single docPhotoBase64

        // Load KBB Logo on start
        window.addEventListener('load', () => {
            google.script.run.withSuccessHandler(res => {
                if (res) logoKBBBase64 = res;
            }).getLogoKBB();
        });

        // Fungsi Terbilang untuk Rupiah
        function terbilang(nilai) {
            nilai = Math.abs(nilai);
            var simpanNilaiBagi = 0;
            var huruf = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
            var temp = "";

            if (nilai < 12) {
                temp = " " + huruf[nilai];
            } else if (nilai < 20) {
                temp = terbilang(nilai - 10) + " Belas";
            } else if (nilai < 100) {
                simpanNilaiBagi = Math.floor(nilai / 10);
                temp = terbilang(simpanNilaiBagi) + " Puluh" + terbilang(nilai % 10);
            } else if (nilai < 200) {
                temp = " Seratus" + terbilang(nilai - 100);
            } else if (nilai < 1000) {
                simpanNilaiBagi = Math.floor(nilai / 100);
                temp = terbilang(simpanNilaiBagi) + " Ratus" + terbilang(nilai % 100);
            } else if (nilai < 2000) {
                temp = " Seribu" + terbilang(nilai - 1000);
            } else if (nilai < 1000000) {
                simpanNilaiBagi = Math.floor(nilai / 1000);
                temp = terbilang(simpanNilaiBagi) + " Ribu" + terbilang(nilai % 1000);
            } else if (nilai < 1000000000) {
                simpanNilaiBagi = Math.floor(nilai / 1000000);
                temp = terbilang(simpanNilaiBagi) + " Juta" + terbilang(nilai % 1000000);
            }
            return temp;
        }

        // Helper untuk format tanggal teks (Contoh: Senin, 20 Mei 2025)
        function getDateText(dateStr) {
            // Asumsi format dd/mm/yyyy
            const parts = dateStr.split('/');
            if (parts.length !== 3) return { dayName: '...', fullDate: dateStr };

            const d = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

            const dayName = days[d.getDay()];
            return { dayName: dayName, fullDate: `${parts[0]} ${months[parseInt(parts[1]) - 1]} ${parts[2]}` };
        }

        function openPreview() {
            // Initialize customizer with global school data
            // These fields now directly pull from the settings form, no need for separate cust inputs
            // document.getElementById('custSchoolName').value = document.getElementById('schoolName').value || "SD NEGERI 01 CONTOH";
            // document.getElementById('custKecamatan').value = document.getElementById('kecamatan').value || "Cikalongwetan";
            // document.getElementById('custSchoolAddress').value = document.getElementById('schoolAddress').value || "Jl. Pendidikan No. 123";
            // document.getElementById('custPrincipalName').value = document.getElementById('principalName').value || "NAMA KEPALA SEKOLAH";
            // document.getElementById('custPrincipalNip').value = document.getElementById('principalNip').value || "19XXXXXXXX XXXXXX X XXX";

            document.getElementById('custPerihal').value = "Permohonan Belanja";
            document.getElementById('custTempatKegiatan').value = document.getElementById('schoolName').value || "Sekolah";
            document.getElementById('custWaktuKegiatan').value = "08.00 sd Selesai";
            document.getElementById('custTembusan').value = "1. Pengawas Pembina\n2. Arsip";

            document.getElementById('previewModal').style.display = 'flex';
            updatePreview();
            lucide.createIcons();
        }

        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }

        function zoomPreview(val) {
            currentScale = val / 100;
            document.getElementById('paper').style.transform = `scale(${currentScale})`;
            document.getElementById('zoomLevel').innerText = `Scale: ${val}%`;
        }

        function changeLayout(layout) {
            currentLayout = layout;
            const paper = document.getElementById('paper');
            if (layout === 'landscape') {
                paper.className = 'paper a5-landscape';
            } else {
                paper.className = 'paper a4';
            }
            updatePreview();
        }

        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    logoBase64 = e.target.result;
                    updatePreview();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleStampUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    stampBase64 = e.target.result;
                    updatePreview();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleDocPhotoUpload(input, index = 1) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    docPhotos[index] = e.target.result;
                    updatePreview();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updatePhotoInputs() {
            const count = parseInt(document.getElementById('docPhotoCount').value);
            for (let i = 1; i <= 5; i++) {
                const el = document.getElementById('ph-' + i);
                if (el) el.style.display = (i <= count) ? 'block' : 'none';
            }
        }

        function handleDocTypeChange() {
            const docType = document.getElementById('docType').value;
            const notaSection = document.getElementById('notaItemsSection');
            const notulenSection = document.getElementById('notulenSection');
            const attendanceSection = document.getElementById('attendanceSection');
            const documentationSection = document.getElementById('documentationSection');
            const rencanaSection = document.getElementById('rencanaExtraSection');
            const spkSection = document.getElementById('spkExtraSection');

            // Hide all special sections
            notaSection.style.display = 'none';
            notulenSection.style.display = 'none';
            attendanceSection.style.display = 'none';
            documentationSection.style.display = 'none';
            rencanaSection.style.display = 'none';
            spkSection.style.display = 'none';

            // Reset visibility of all grouped fields first
            ['fg-nomor', 'fg-perihal', 'fg-vendor-style', 'fg-font-style', 'fg-font-size', 'fg-vendor-name', 'fg-uraian', 'fg-jumlah',
                'fg-tanggal', 'fg-tanggal-pesan', 'fg-tanggal-kegiatan', 'fg-tempat', 'fg-waktu-kegiatan',
                'fg-vendor-address', 'fg-tembusan', 'fg-logo-upload', 'fg-stamp-upload'].forEach(id => {
                    document.getElementById(id).style.display = 'none';
                });

            // Helper to show specific fields
            const showFields = (ids) => ids.forEach(id => document.getElementById(id).style.display = 'block');

            if (docType === 'kwitansi') {
                showFields(['fg-nomor', 'fg-uraian', 'fg-jumlah', 'fg-tanggal', 'fg-vendor-name', 'fg-stamp-upload']); // Added stamp
            } else if (docType === 'nota') {
                showFields(['fg-vendor-style', 'fg-font-style', 'fg-font-size', 'fg-vendor-name', 'fg-uraian', 'fg-jumlah', 'fg-tanggal', 'fg-vendor-address', 'fg-stamp-upload']); // Removed logo, kept stamp
                notaSection.style.display = 'block';
                if (document.getElementById('notaItemsList').children.length === 0) {
                    addNotaItem();
                }
            } else if (docType === 'pesanan') {
                showFields(['fg-nomor', 'fg-perihal', 'fg-vendor-name', 'fg-uraian', 'fg-tanggal-pesan', 'fg-tanggal-kegiatan']);
            } else if (docType === 'berita_acara') {
                showFields(['fg-nomor', 'fg-vendor-name', 'fg-uraian', 'fg-jumlah', 'fg-tanggal', 'fg-vendor-address']);
            } else if (docType === 'undangan') {
                showFields(['fg-nomor', 'fg-perihal', 'fg-uraian', 'fg-tanggal-pesan', 'fg-tanggal-kegiatan', 'fg-tempat', 'fg-waktu-kegiatan', 'fg-tembusan']);
            } else if (docType === 'notulen') {
                showFields(['fg-uraian', 'fg-tanggal']);
                notulenSection.style.display = 'block';
            } else if (docType === 'daftar_hadir') {
                showFields(['fg-uraian']);
                attendanceSection.style.display = 'block';
                if (document.getElementById('attendanceList').children.length === 0) {
                    loadDefaultAttendance();
                }
            } else if (docType === 'dokumentasi') {
                showFields(['fg-uraian', 'fg-tanggal']);
                documentationSection.style.display = 'block';
            } else if (docType === 'rencana') {
                showFields(['fg-uraian', 'fg-tanggal', 'fg-tempat', 'fg-jumlah']);
                rencanaSection.style.display = 'block';
            } else if (docType === 'spk') {
                showFields(['fg-nomor', 'fg-tanggal', 'fg-uraian', 'fg-jumlah']); // Removed fg-vendor-name
                spkSection.style.display = 'block';
                notaSection.style.display = 'block';
            }
            updatePreview();
        }

        function addAttendanceRow(nama = "", jabatan = "") {
            const list = document.getElementById('attendanceList');
            const div = document.createElement('div');
            div.className = 'attendance-row';
            div.style = 'display: grid; grid-template-columns: 1fr 1fr 30px; gap: 5px; align-items: center;';
            div.innerHTML = `
                <input type="text" placeholder="Nama" value="${nama}" oninput="updatePreview()" style="padding: 5px; font-size: 11px;">
                <input type="text" placeholder="Jabatan" value="${jabatan}" oninput="updatePreview()" style="padding: 5px; font-size: 11px;">
                <button onclick="this.parentElement.remove(); updatePreview();" style="border:none; background:none; color:red; cursor:pointer;"><i data-lucide="trash-2" size="12"></i></button>
            `;
            list.appendChild(div);
            lucide.createIcons();
        }

        function loadDefaultAttendance() {
            const list = document.getElementById('attendanceList');
            list.innerHTML = "";
            const teachers = [
                { n: "Yuniarti, S.Pd", j: "Kepala Sekolah" },
                { n: "Ahmad, S.Pd", j: "Guru Kelas" },
                { n: "Deni Mulyani, S.Pd", j: "Guru Kelas" },
                { n: "Siti Aisah Nur Fitri", j: "Guru Kelas" },
                { n: "Sarah Siti Nuryati", j: "Guru Kelas" },
                { n: "Rinda Sri Agung Wahyuni, S.Pd", j: "Guru Kelas" },
                { n: "Fika Agustina, S,Pd", j: "Guru Kelas" },
                { n: "NurAsiah, S.Pd", j: "Guru PAI" },
                { n: "Meytha Murty", j: "Guru Kelas" },
                { n: "Vani, S.Pd", j: "Guru Kelas" }
            ];
            teachers.forEach(t => addAttendanceRow(t.n, t.j));
            updatePreview();
        }

        function addNotaItem(nama = "", qty = 1, harga = 0) {
            const list = document.getElementById('notaItemsList');
            const div = document.createElement('div');
            div.className = 'nota-item-row';
            div.style = 'display: grid; grid-template-columns: 1fr 50px 100px 30px; gap: 5px; align-items: center;';
            div.innerHTML = `
                <input type="text" placeholder="Nama Barang" value="${nama}" oninput="updatePreview()" style="padding: 5px; font-size: 12px;">
                <input type="number" placeholder="Qty" value="${qty}" oninput="updatePreview()" style="padding: 5px; font-size: 12px;">
                <input type="number" placeholder="Harga" value="${harga}" oninput="updatePreview()" style="padding: 5px; font-size: 12px;">
                <button onclick="this.parentElement.remove(); updatePreview();" style="border:none; background:none; color:red; cursor:pointer;"><i data-lucide="trash-2" size="14"></i></button>
            `;
            list.appendChild(div);
            lucide.createIcons();
        }

        function updatePreview() {


            const docType = document.getElementById('docType').value;
            const vendorStyle = document.getElementById('vendorStyle').value;
            const vendorName = document.getElementById('custVendorName').value || ""; // Default empty
            const vendorAddress = document.getElementById('custVendorAddress').value || "Jl. Raya KM 10, Kota Pendidikan";
            const uraian = document.getElementById('custUraian').value || "Belanja Barang Jasa";
            let jumlah = parseFloat(document.getElementById('custJumlah').value) || 0;
            const tanggal = document.getElementById('custTanggal').value || "01/01/2025";
            const nomorSurat = document.getElementById('custNomorSurat').value || "020/SD-BOS/2025";
            const tanggalPesan = document.getElementById('custTanggalPesan').value || tanggal;
            const tanggalKegiatan = document.getElementById('custTanggalKegiatan').value || tanggal;
            const fontStyle = document.getElementById('fontStyle').value; // Get font preference
            const fontSize = document.getElementById('fontSize').value || "16";
            const fontSizeDisplay = document.getElementById('fontSizeDisplay');
            if (fontSizeDisplay) fontSizeDisplay.innerText = fontSize + "px";

            let terbilangText = terbilang(jumlah) + " Rupiah";
            const dateInfo = getDateText(tanggal);
            const datePesanInfo = getDateText(tanggalPesan);
            const dateKegiatanInfo = getDateText(tanggalKegiatan);

            // Versi Uraian Bersih (Hanya Nama Kegiatan) untuk Surat Pesanan & Undangan
            const cleanUraian = uraian.replace(/^(Belanja )?Konsumsi \((Makan & Snack|Makan|Snack)\) /i, "")
                .replace(/^Konsumsi \((Makan & Snack|Makan|Snack)\) /i, "");

            const schoolData = {
                name: document.getElementById('schoolName').value || "SD NEGERI 01 CONTOH",
                address: document.getElementById('schoolAddress').value || "Jl. Pendidikan No. 123",
                kecamatan: document.getElementById('kecamatan').value || "Cikalongwetan",
                npsn: document.getElementById('npsn').value || "12345678",
                principal: document.getElementById('principalName').value || "NAMA KEPALA SEKOLAH",
                principalNip: document.getElementById('principalNip').value || "19XXXXXXXX XXXXXX X XXX",
                treasurer: document.getElementById('treasurerName').value || "NAMA BENDAHARA",
                treasurerNip: document.getElementById('treasurerNip').value || "19XXXXXXXX XXXXXX X XXX"
            };

            const perihal = document.getElementById('custPerihal').value || "Surat Pesanan";
            const tempatKegiatan = document.getElementById('custTempatKegiatan').value || "Sekolah";
            const waktuKegiatan = document.getElementById('custWaktuKegiatan').value || "08.00 sd Selesai";
            const tembusan = document.getElementById('custTembusan').value || "";

            let html = '';

            // --- TEMPLATE KOP SURAT SEKOLAH ---
            const schoolKop = `
                <div style="display: flex; align-items: center; border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 20px; font-family: 'Times New Roman', serif;">
                    <div style="width: 80px;">
                        ${logoKBBBase64 ? `<img src="${logoKBBBase64}" style="width: 70px;">` : ''}
                    </div>
                    <div style="flex-grow: 1; text-align: center; margin-right: 80px;">
                        <h3 style="margin:0; font-size: 16px; text-transform: uppercase;">PEMERINTAH KABUPATEN BANDUNG BARAT</h3>
                        <h3 style="margin:0; font-size: 16px; text-transform: uppercase;">DINAS PENDIDIKAN</h3>
                        <h2 style="margin:0; font-size: 18px; text-transform: uppercase; font-weight: bold;">${schoolData.name}</h2>
                        <h3 style="margin:0; font-size: 14px; text-transform: uppercase;">KECAMATAN ${schoolData.kecamatan}</h3>
                        <p style="margin:0; font-size: 11px; font-style: italic;">${schoolData.address} - Kabupaten Bandung Barat</p>
                    </div>
                </div>
            `;

            if (docType === 'nota') {
                // Handwriting font helper  defined OUTSIDE template literals to avoid nested backtick issues
                const hwStyle = fontStyle || '';
                const hwAttr = (fontStyle ? 'font-family:' + fontStyle + ';' : '') + 'font-size:' + fontSize + 'px;';

                // Get manual items if any
                const itemRows = document.querySelectorAll('.nota-item-row');
                let itemsHtml = '';
                let itemsHtmlSwapped = ''; // For templates with [Qty, Name] order
                let totalManual = 0;


                if (itemRows.length > 0) {
                    itemRows.forEach((row, index) => {
                        const inputs = row.querySelectorAll('input');
                        const name = inputs[0].value || "-";
                        const rawQty = inputs[1].value;
                        const rawPrice = inputs[2].value;

                        const qty = parseFloat(rawQty) || 0;
                        const price = parseFloat(rawPrice) || 0;
                        const sub = qty * price;
                        totalManual += sub;

                        if (vendorStyle === 'rm-family' && (!rawQty || qty === 0) && (!rawPrice || price === 0)) {
                            // Special Menu Line for RM Family & Standard
                            itemsHtml += `
                                    <tr style="height: 25px; border-bottom: 1px solid #000;">
                                        <td style="border-right: 2px solid #000; padding: 0 8px 0 30px; font-style: italic;">${name}</td>
                                        <td style="border-right: 2px solid #000; text-align: center; width: 60px;"></td>
                                        <td style="border-right: 2px solid #000; text-align: right; padding-right: 8px; width: 100px;"></td>
                                        <td style="text-align: right; padding-right: 8px; width: 120px;"></td>
                                    </tr>
                                `;
                            itemsHtmlSwapped += `
                                    <tr style="height: 25px; border-bottom: 1px solid #000;">
                                        <td style="border-right: 2px solid #000; text-align: center; width: 60px;"></td>
                                        <td style="border-right: 2px solid #000; padding: 0 8px 0 30px; font-style: italic;">${name}</td>
                                        <td style="border-right: 2px solid #000; text-align: right; padding-right: 8px; width: 100px;"></td>
                                        <td style="text-align: right; padding-right: 8px; width: 120px;"></td>
                                    </tr>
                                `;
                        } else {
                            // Standard Line
                            itemsHtml += `
                                    <tr style="height: 25px; border-bottom: 1px solid #000;">
                                        <td style="border-right: 2px solid #000; padding: 0 8px; ${hwAttr}">${name}</td>
                                        <td style="border-right: 2px solid #000; text-align: center; width: 60px; ${hwAttr}">${qty || ""}</td>
                                        <td style="border-right: 2px solid #000; text-align: right; padding-right: 8px; width: 100px; ${hwAttr}">${price ? price.toLocaleString('id-ID') : ""}</td>
                                        <td style="text-align: right; padding-right: 8px; width: 120px; ${hwAttr}">${price ? sub.toLocaleString('id-ID') : ""}</td>
                                    </tr>
                                `;
                            // Swapped Line (Qty First)
                            itemsHtmlSwapped += `
                                    <tr style="height: 25px; border-bottom: 1px solid #000;">
                                        <td style="border-right: 2px solid #000; text-align: center; width: 60px; ${hwAttr}">${qty || ""}</td>
                                        <td style="border-right: 2px solid #000; padding: 0 8px; ${hwAttr}">${name}</td>
                                        <td style="border-right: 2px solid #000; text-align: right; padding-right: 8px; width: 100px; ${hwAttr}">${price ? price.toLocaleString('id-ID') : ""}</td>
                                        <td style="text-align: right; padding-right: 8px; width: 120px; ${hwAttr}">${price ? sub.toLocaleString('id-ID') : ""}</td>
                                    </tr>
                                `;
                        }
                    });

                    // Fill remaining empty rows (up to 12)
                    const remaining = 12 - itemRows.length;
                    for (let i = 0; i < remaining; i++) {
                        itemsHtml += `<tr style="height: 25px; border-bottom: 1px solid #000;"><td style="border-right: 2px solid #000;"></td><td style="border-right: 2px solid #000;"></td><td style="border-right: 2px solid #000;"></td><td></td></tr>`;
                        itemsHtmlSwapped += `<tr style="height: 25px; border-bottom: 1px solid #000;"><td style="border-right: 2px solid #000;"></td><td style="border-right: 2px solid #000;"></td><td style="border-right: 2px solid #000;"></td><td></td></tr>`;
                    }
                } else {
                    // Default fallback
                    itemsHtml = ``;
                    itemsHtmlSwapped = ``;
                }

                // AUTO CALC LOGIC
                if (itemRows.length > 0 && document.getElementById('manualTotal').checked) {
                    jumlah = totalManual;
                    document.getElementById('custJumlah').value = jumlah;
                    terbilangText = terbilang(jumlah) + " Rupiah";
                }

                if (itemRows.length === 0) { // Fallback if no items
                    // Default fallback
                    itemsHtml = `
                        <tr style="height: 25px; border-bottom: 1px solid #000;">
                            <td style="border-right: 2px solid #000; padding: 0 8px; ${hwAttr}">${uraian}</td>
                            <td style="border-right: 2px solid #000; text-align: center; width: 60px; ${hwAttr}">1</td>
                            <td style="border-right: 2px solid #000; text-align: right; padding-right: 8px; width: 100px; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</td>
                            <td style="text-align: right; padding-right: 8px; width: 120px; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</td>
                        </tr>
                    ` + Array(11).fill('<tr style="height: 25px; border-bottom: 1px solid #000;"><td style="border-right: 2px solid #000;"></td><td style="border-right: 2px solid #000;"></td><td style="border-right: 2px solid #000;"></td><td></td></tr>').join('');

                    itemsHtmlSwapped = `
                        <tr style="height: 25px; border-bottom: 1px solid #000;">
                            <td style="border-right: 2px solid #000; text-align: center; width: 60px; ${hwAttr}">1</td>
                            <td style="border-right: 2px solid #000; padding: 0 8px; ${hwAttr}">${uraian}</td>
                            <td style="border-right: 2px solid #000; text-align: right; padding-right: 8px; width: 100px; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</td>
                            <td style="text-align: right; padding-right: 8px; width: 120px; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</td>
                        </tr>
                    ` + Array(11).fill('<tr style="height: 25px; border-bottom: 1px solid #000;"><td style="border-right: 2px solid #000;"></td><td style="border-right: 2px solid #000;"></td><td style="border-right: 2px solid #000;"></td><td></td></tr>').join('');
                }

                if (vendorStyle === 'rm-family') {
                    // --- LAYOUT NOTA RM FAMILY (Landscape / Classic) ---
                    html = `
                        <div style="font-family: 'Arial Narrow', Arial, sans-serif; color: #000; border: 2px solid #000; padding: 20px; background: #fff; width: 100%;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="text-align: center; width: 350px;">
                                    <h2 style="margin:0; font-size: 18px; font-weight: bold; letter-spacing: 1px;">RUMAH MAKAN</h2>
                                    <h1 style="margin:0; font-size: 42px; font-family: 'Arial Black', sans-serif; line-height: 1;">"RM. FAMILY"</h1>
                                    <p style="margin:5px 0 0 0; font-size: 11px; font-weight: bold;">${vendorAddress}</p>
                                </div>
                                <div style="width: 250px; font-size: 13px;">
                                    <table style="width: 100%;">
                                        <tr><td style="width: 60px;">Bapak/Ibu</td><td style="border-bottom: 2px solid #000; ${hwAttr}">: ${schoolData.name.substring(0, 25)}</td></tr>
                                        <tr><td colspan="2" style="border-bottom: 2px solid #000; height: 15px;"></td></tr>
                                        <tr><td colspan="2" style="border-bottom: 2px solid #000; height: 15px;"></td></tr>
                                        <tr><td>Tgl.</td><td style="border-bottom: 2px solid #000; text-align: center; ${hwAttr}">${tanggal.split('/')[0]} / ${tanggal.split('/')[1]} / ${tanggal.split('/')[2]}</td></tr>
                                        <tr><td>No.</td><td style="border-bottom: 2px solid #000; ${hwAttr}">: ${nomorSurat}</td></tr>
                                    </table>
                                </div>
                            </div>

                            <div style="background: #000; color: #fff; text-align: center; padding: 4px; margin: 10px 0; font-weight: bold; font-size: 13px;">MENERIMA PESANAN</div>

                            <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 13px; font-family: inherit;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #000; font-weight: bold;">
                                        <th style="border-right: 2px solid #000; padding: 5px; text-align: center;">MAKANAN / MINUMAN</th>
                                        <th style="border-right: 2px solid #000; padding: 5px; width: 40px; text-align: center;">JML</th>
                                        <th style="border-right: 2px solid #000; padding: 5px; width: 80px; text-align: center;">H. SATUAN</th>
                                        <th style="padding: 5px; width: 110px; text-align: center;">SUB TOTAL</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtml}
                                </tbody>
                            </table>
                            
                            <div style="display: flex; margin-top: 10px;">
                                <div style="flex-grow: 1; display: flex; justify-content: space-around; font-size: 13px; font-weight: bold; padding-top: 20px;">
                                    <div style="text-align: center;">Tanda Terima<br><br><br>( ................. )</div>
                                    <div style="text-align: center;">Hormat Kami<br><br><br>( ................. )</div>
                                </div>
                                <div style="width: 200px; border-left: 2px solid #000;">
                                    <table style="width: 100%; border-collapse: collapse; font-size: 14px; font-weight: bold;">
                                        <tr style="border-bottom: 1px solid #000;">
                                            <td style="padding: 5px;">Total</td>
                                            <td style="padding: 5px; text-align: right; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</td>
                                        </tr>
                                        <tr style="border-bottom: 1px solid #000;">
                                            <td style="padding: 5px;">DP</td>
                                            <td style="padding: 5px; text-align: right;">-</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 5px;">Sisa</td>
                                            <td style="padding: 5px; text-align: right; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <div style="text-align: center; font-style: italic; font-family: 'Brush Script MT', cursive; font-size: 18px; margin-top: 10px;">Terima Kasih Atas Kunjungan Anda</div>
                        </div>
                    `;
                } else if (vendorStyle === 'cahya-cellular') {
                    // --- LAYOUT NOTA CAHYA CELLULAR (Blue Theme) ---
                    html = `
                        <div style="font-family: 'Arial', sans-serif; color: #1e40af; border: 2px solid #1e40af; padding: 20px; background: #fff; width: 100%; border-radius: 5px;">
                            <div style="display: flex; justify-content: space-between; position: relative;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 60px; height: 60px; border: 3px solid #1e40af; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px;">CC</div>
                                    <div style="text-align: center;">
                                        <h1 style="margin:0; font-size: 24px; font-weight: bold; letter-spacing: 4px; text-transform: uppercase;">CAHYA CELLULAR</h1>
                                    </div>
                                </div>
                                <div style="text-align: left; font-size: 12px; font-weight: 600;">
                                    Cikalongwetan, <span style="${hwAttr}">${tanggal}</span><br>
                                    Kepada Yth. <span style="${hwAttr}">${schoolData.name}</span><br><br>
                                    <div style="height: 2px; background: #ef4444; width: 180px; margin: 5px 0;"></div>
                                    <div style="height: 2px; background: #ef4444; width: 180px;"></div>
                                </div>
                            </div>
                            
                            <p style="margin: 10px 0; font-size: 12px; font-weight: bold; text-transform: uppercase;">KARTU INTERNET - AKSESORIS - HP BARU - SECOND - HP ALL OPERATOR</p>
                            <p style="margin: 0; font-size: 10px; font-weight: bold;">Alamat: ${vendorAddress}</p>
                            <p style="margin: 2px 0 10px 0; font-size: 10px; font-weight: bold;">HP. 082 116 52 5553 / 089 666 8888 06 / 085 719 799 7990</p>
                            
                            <div style="height: 3px; background: #1e40af; margin-bottom: 2px;"></div>
                            <div style="text-align: right; font-weight: bold; font-size: 14px; margin-bottom: 5px;">Nota No : _________</div>

                            <table style="width: 100%; border-collapse: collapse; border: 2px solid #1e40af; font-family: inherit;">
                                <thead>
                                    <tr style="background: #3b82f6; color: #fff;">
                                        <th style="border: 2px solid #1e40af; padding: 5px; width: 80px; text-align: center;">BANYAKNYA</th>
                                        <th style="border: 2px solid #1e40af; padding: 5px;">NAMA BARANG</th>
                                        <th style="border: 2px solid #1e40af; padding: 5px; width: 100px; text-align: right;">HARGA SATUAN</th>
                                        <th style="border: 2px solid #1e40af; padding: 5px; width: 120px; text-align: right;">JUMLAH RP.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtmlSwapped.replaceAll('border-right: 2px solid #000', 'border: 2px solid #1e40af').replaceAll('border-bottom: 1px solid #000', 'border: 2px solid #1e40af')}
                                </tbody>
                            </table>
                            
                            <div style="display: flex; margin-top: 10px;">
                                <div style="flex-grow: 1; font-size: 10px; font-weight: bold;">
                                    <p>Perhatian !</p>
                                    <p>Barang Yang Sudah Dibeli Tidak Dapat Ditukar/Dikembalikan</p>
                                    <div style="display: flex; justify-content: space-around; margin-top: 40px; font-size: 12px;">
                                        <div style="text-align: center;">Yang Menerima<br><br><br>( _________ )</div>
                                        <div style="text-align: center;">Hormat Kami<br><br><br>( _________ )</div>
                                    </div>
                                </div>
                                <div style="width: 180px;">
                                    <table style="width: 100%; border-collapse: collapse; font-weight: bold; font-size: 12px; color: #fff;">
                                        <tr><td style="background: #3b82f6; padding: 4px; border: 1px solid #1e40af; text-align: right;">Jumlah</td><td style="border: 1px solid #1e40af; color: #000; width: 100px; text-align: center; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</td></tr>
                                        <tr><td style="background: #3b82f6; padding: 4px; border: 1px solid #1e40af; text-align: right;">Uang Muka</td><td style="border: 1px solid #1e40af; color: #000; text-align: center;">-</td></tr>
                                        <tr><td style="background: #3b82f6; padding: 4px; border: 1px solid #1e40af; text-align: right;">Sisa</td><td style="border: 1px solid #1e40af; color: #000; text-align: center; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (vendorStyle === 'media-komputer') {
                    // --- LAYOUT MEDIA KOMPUTER (Black Theme) ---
                    html = `
                        <div style="font-family: 'Arial', sans-serif; color: #000; border: 1px solid #666; padding: 30px; background: #fff; width: 100%;">
                            <div style="display: flex; justify-content: space-between;">
                                <div style="display: flex; align-items: flex-start; gap: 15px;">
                                    <div style="width: 60px; height: 60px; background: #0ea5e9; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;">BS</div>
                                    <div>
                                        <h1 style="margin:0; font-size: 48px; font-family: 'Impact', sans-serif; font-weight: normal; font-style: italic; line-height: 1;">MEDIA</h1>
                                        <p style="margin:5px 0 0 0; font-size: 10px; font-weight: bold;">Terima Jual Beli/Service Laptop, Notebook, Printer & Aksesoris</p>
                                        <p style="margin:0; font-size: 10px;">${vendorAddress}</p>
                                    </div>
                                </div>
                                <div style="text-align: left; font-size: 12px;">
                                    Cikalongwetan, <span style="${hwAttr}">${tanggal}</span><br>
                                    Tuan/Toko : <span style="${hwAttr}">${schoolData.name}</span><br><br>
                                    <div style="border-bottom: 2px dashed #000; width: 150px;"></div>
                                </div>
                            </div>
                            
                            <div style="height: 3px; background: #000; margin: 15px 0 2px 0;"></div>
                            <div style="height: 1px; background: #000; margin-bottom: 15px;"></div>

                            <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 13px; font-family: inherit;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #000; font-weight: bold;">
                                        <th style="border-right: 1px solid #000; padding: 8px; width: 30px; text-align: center;">NO</th>
                                        <th style="border-right: 1px solid #000; padding: 8px; text-align: center;">ITEM / SERVICE</th>
                                        <th style="border-right: 1px solid #000; padding: 8px; width: 90px; text-align: center;">HARGA SATUAN</th>
                                        <th style="padding: 8px; width: 120px; text-align: center;">JUMLAH</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtmlSwapped.replaceAll('border-right: 2px solid #000', 'border: 1px solid #000').replaceAll('border-bottom: 1px solid #000', 'border: 1px solid #000')}
                                </tbody>
                            </table>
                            
                            <div style="display: flex; margin-top: 20px;">
                                <div style="flex-grow: 1;">
                                    <div style="display: flex; justify-content: space-around; font-size: 13px;">
                                        <div style="text-align: center;">Yang Terima,<br><br><br>( ................. )</div>
                                        <div style="text-align: center;">Hormat Kami,<br><br><br>( ................. )</div>
                                    </div>
                                    <p style="margin-top: 15px; font-size: 11px; font-weight: bold; font-style: italic;">Barang yang sudah dibeli tidak dapat dikembalikan</p>
                                </div>
                                <div style="width: 250px; text-align: right; font-weight: bold; font-size: 16px; padding-top: 10px;">
                                    JUMLAH Rp. <span style="display: inline-block; width: 120px; border-bottom: 2px solid #000; text-align: right; padding-bottom: 5px; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (vendorStyle === 'mitra-photocopy') {
                    // --- LAYOUT MITRA PHOTOCOPY (Simple) ---
                    html = `
                        <div style="font-family: 'Arial', sans-serif; color: #000; border: 1px solid #ddd; padding: 15px; background: #fff; width: 100%;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <h1 style="margin:0; font-size: 28px; font-weight: normal; letter-spacing: 2px;">MITRA PHOTO COPY</h1>
                                    <p style="margin:5px 0 0 0; font-size: 11px;">${vendorAddress}</p>
                                    <p style="margin:0; font-size: 10px; font-weight: bold; text-transform: uppercase;">Melayani: Penjilidan Hard Cover, Soft Cover, Laminating, Alat Tulis Kantor Dll.</p>
                                </div>
                                <div style="text-align: left; font-size: 12px;">
                                    Cikalongwetan, <span style="${hwAttr}">${tanggal}</span><br>
                                    <span style="${hwAttr}">${schoolData.name}</span><br>
                                    NPWP: 24.251.003.0 - 045.00
                                </div>
                            </div>
                            
                            <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; margin-top: 15px; font-size: 13px; font-family: inherit;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #000; font-weight: bold;">
                                        <th style="border-right: 2px solid #000; padding: 5px; width: 80px;  text-align: center;">Banyaknya</th>
                                        <th style="border-right: 2px solid #000; padding: 5px;">Jenis Jasa</th>
                                        <th style="border-right: 2px solid #000; padding: 5px; width: 100px;  text-align: right;">Harga Satuan (Rp)</th>
                                        <th style="padding: 5px; width: 120px;">Jumlah (Rp)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtmlSwapped}
                                </tbody>
                            </table>
                            
                            <div style="display: flex; margin-top: 10px;">
                                <div style="flex-grow: 1; display: flex; align-items: flex-end; padding-bottom: 20px;">
                                    <h2 style="font-size: 24px; font-weight: normal;">Hormat Kami</h2>
                                </div>
                                <div style="width: 180px; font-size: 12px; font-weight: bold;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <tr><td style="padding: 5px; text-align: right;">Jumlah Rp.</td><td style="border: 1px solid #000; padding: 5px; text-align: center; width: 100px; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</td></tr>
                                        <tr><td style="padding: 5px; text-align: right;">Uang Muka Rp.</td><td style="border: 1px solid #000; padding: 5px; text-align: center;">-</td></tr>
                                        <tr><td style="padding: 5px; text-align: right;">Sisa Rp.</td><td style="border: 1px solid #000; padding: 5px; text-align: center; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (vendorStyle === 'sinar-abadi') {
                    // --- LAYOUT SINAR ABADI (Classic Red) ---
                    html = `
                        <div style="font-family: 'Times New Roman', serif; color: #1e3a8a; border: 3px double #1e3a8a; padding: 25px; background: #fff; width: 100%; position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="display: flex; gap: 20px;">
                                    <div style="width: 65px; height: 65px; background: #ef4444; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 30px; border: 3px solid #1e3a8a;">SA</div>
                                    <div>
                                        <h1 style="margin:0; font-size: 32px; font-weight: 900; color: #ef4444; font-family: 'Arial Black', sans-serif;">TB. SINAR ABADI</h1>
                                        <p style="margin:0; font-size: 11px; font-weight: bold;">${vendorAddress}</p>
                                        <p style="margin:0; font-size: 11px; font-weight: bold;">Menjual: Bahan Bangunan Kayu Dll</p>
                                        <p style="margin:0; font-size: 11px;">Melayani Eceran dan Grosir</p>
                                    </div>
                                </div>
                                <div style="text-align: left; font-size: 12px; color: #1e3a8a;">
                                    Cikalongwetan, <span style="${hwAttr}">${tanggal}</span><br>
                                    Tuan : <span style="${hwAttr}">${schoolData.name}</span><br>
                                    Toko : _______________________<br><br>
                                    <div style="border-bottom: 2px solid #1e3a8a; width: 180px;"></div>
                                </div>
                            </div>
                            
                            <table style="width: 100%; border-collapse: collapse; border: 2px solid #1e3a8a; margin-top: 20px; font-size: 14px; position: relative; z-index: 1; font-family: inherit;">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 120px; font-weight: bold; color: rgba(239, 68, 68, 0.1); z-index: -1;">SA</div>
                                <thead>
                                    <tr style="border-bottom: 2px solid #1e3a8a; font-weight: bold; text-align: center;">
                                        <th style="border-right: 2px solid #1e3a8a; padding: 8px; width: 80px;">Banyak-nya</th>
                                        <th style="border-right: 2px solid #1e3a8a; padding: 8px;  text-align: left;">NAMA BARANG</th>
                                        <th style="border-right: 2px solid #1e3a8a; padding: 8px; width: 100px;  text-align: right;">HARGA SATUAN</th>
                                        <th style="padding: 8px; width: 130px;  text-align: right;">JUMLAH</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itemsHtmlSwapped.replaceAll('border-right: 2px solid #000', 'border-right: 2px solid #1e3a8a').replaceAll('border-bottom: 1px solid #000', 'border-bottom: 1px solid #1e3a8a')}
                                </tbody>
                            </table>
                            
                            <div style="display: flex; margin-top: 15px; font-weight: bold;">
                                <div style="flex-grow: 1; font-size: 12px;">
                                    <p style="margin:0;">Pembayaran Transfer : Bank BCA</p>
                                    <p style="margin:0;">No. 2730110549 a/n : Hendri Fardiansyah</p>
                                    <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                                        <div style="text-align: center;">Tanda Terima,<br><br><br>( ................. )</div>
                                        <div style="text-align: center; border: 2px solid #ef4444; padding: 5px; color: #ef4444; font-size: 10px; width: 120px; margin-top: 10px;">Perhatian !<br>Barang yang sudah dibeli tidak dapat dikembalikan</div>
                                        <div style="text-align: center;">Hormat Kami,<br><br><br>( ................. )</div>
                                    </div>
                                </div>
                                <div style="width: 250px; text-align: right; font-size: 18px; color: #1e3a8a; padding-top: 10px;">
                                    JUMLAH Rp. <span style="display: inline-block; width: 120px; border-bottom: 2px solid #1e3a8a; text-align: right; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (vendorStyle === 'standard') {
                    // --- LAYOUT MODERN STANDARD (Clean Invoice) ---
                    html = `
                        <div style="font-family: 'Arial', sans-serif; color: #000; border: 1px solid #ccc; padding: 40px; background: #fff; max-width: 100%;">
                            <!-- Header Info -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px;">
                                <div>
                                    <h1 style="margin: 0; font-size: 28px; font-weight: bold; text-transform: uppercase;">${vendorName || "NAMA TOKO"}</h1>
                                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #555;">${vendorAddress}</p>
                                </div>
                                <div style="text-align: right;">
                                    <h2 style="margin: 0; font-size: 24px; color: #555;">NOTA</h2>
                                    <p style="margin: 5px 0 0 0; font-size: 13px;">Tanggal: <strong style="${hwAttr}">${tanggal}</strong></p>
                                    <p style="margin: 2px 0 0 0; font-size: 13px;">Kepada: <strong style="${hwAttr}">${schoolData.name}</strong></p>
                                </div>
                            </div>

                            <!-- Table -->
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 13px; font-family: inherit;">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: left; width: 50%;">URAIAN</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: center; width: 10%;">QTY</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: right; width: 20%;">HARGA</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: right; width: 20%;">TOTAL</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(document.getElementById('notaItemsList').children.length > 0) ?
                            Array.from(document.querySelectorAll('.nota-item-row')).map(row => {
                                const ins = row.querySelectorAll('input');
                                const n = ins[0].value || "-";
                                const q = parseInt(ins[1].value) || 0;
                                const p = parseInt(ins[2].value) || 0;
                                return `
                                                <tr>
                                                    <td style="border: 1px solid #ddd; padding: 10px; ${hwAttr}">${n}</td>
                                                    <td style="border: 1px solid #ddd; padding: 10px; text-align: center; ${hwAttr}">${q}</td>
                                                    <td style="border: 1px solid #ddd; padding: 10px; text-align: right; ${hwAttr}">${p.toLocaleString('id-ID')}</td>
                                                    <td style="border: 1px solid #ddd; padding: 10px; text-align: right; ${hwAttr}">${(q * p).toLocaleString('id-ID')}</td>
                                                </tr>
                                            `;
                            }).join('')
                            :
                            `<tr>
                                            <td style="border: 1px solid #ddd; padding: 10px; ${hwAttr}">${uraian}</td>
                                            <td style="border: 1px solid #ddd; padding: 10px; text-align: center; ${hwAttr}">1</td>
                                            <td style="border: 1px solid #ddd; padding: 10px; text-align: right; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</td>
                                            <td style="border: 1px solid #ddd; padding: 10px; text-align: right; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</td>
                                        </tr>`
                        }
                                </tbody>
                                <tfoot>
                                    <tr style="font-weight: bold; background: #f8f9fa;">
                                        <td colspan="3" style="border: 1px solid #ddd; padding: 12px; text-align: right;">TOTAL TAGIHAN</td>
                                        <td style="border: 1px solid #ddd; padding: 12px; text-align: right; ${hwAttr}">Rp ${jumlah.toLocaleString('id-ID')}</td>
                                    </tr>
                                </tfoot>
                            </table>

                            <!-- Signature -->
                            <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                                <div style="text-align: center; width: 200px;">
                                    <p style="margin-bottom: 60px; font-size: 13px;">Tanda Terima,</p>
                                    <div style="border-bottom: 1px solid #000; width: 100%;"></div>
                                </div>
                                <div style="text-align: center; width: 200px; position: relative;">
                                    <p style="margin-bottom: 60px; font-size: 13px;">Hormat Kami,</p>
                                    ${stampBase64 ? `<img src="${stampBase64}" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 80px; opacity: 0.8;">` : ''}
                                    <p style="font-weight: bold; margin: 0;">${vendorName || "Administrator"}</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (vendorStyle === 'plain') {
                    // --- LAYOUT GROSIR / POLOS (Authentic Handwritten Store Note) ---

                    // Build rows using itemsHtmlSwapped (Qty first) with vertical lines
                    const itemRows2 = document.querySelectorAll('.nota-item-row');
                    let plainRows = '';

                    if (itemRows2.length > 0) {
                        itemRows2.forEach((row, idx) => {
                            const ins = row.querySelectorAll('input');
                            const nm = ins[0].value || '';
                            const rawQ = ins[1].value;
                            const rawP = ins[2].value;
                            const q = parseFloat(rawQ) || 0;
                            const p = parseFloat(rawP) || 0;
                            const sub = q * p;
                            const isLast = idx === itemRows2.length - 1;
                            plainRows += `
                                <tr style="height:32px;">
                                    <td style="border-right:1.5px solid #888; border-bottom:1px solid #ddd; padding:2px 8px; text-align:center; width:60px; ${hwAttr}">${q || ''}</td>
                                    <td style="border-right:1.5px solid #888; border-bottom:1px solid #ddd; padding:2px 8px; ${hwAttr}">${nm}</td>
                                    <td style="border-right:1.5px solid #888; border-bottom:1px solid #ddd; padding:2px 8px; text-align:right; width:110px; ${hwAttr}">${p ? p.toLocaleString('id-ID') : ''}</td>
                                    <td style="border-bottom:1px solid #ddd; padding:2px 8px; text-align:right; width:120px; ${hwAttr}">${sub ? sub.toLocaleString('id-ID') : ''}</td>
                                </tr>`;
                        });
                        // Fill empty rows up to 12
                        const rem = Math.max(0, 12 - itemRows2.length);
                        for (let i = 0; i < rem; i++) {
                            plainRows += `<tr style="height:32px;"><td style="border-right:1.5px solid #888; border-bottom:1px solid #ddd;"></td><td style="border-right:1.5px solid #888; border-bottom:1px solid #ddd;"></td><td style="border-right:1.5px solid #888; border-bottom:1px solid #ddd;"></td><td style="border-bottom:1px solid #ddd;"></td></tr>`;
                        }
                    } else {
                        // Default single row
                        plainRows = `<tr style="height:32px;"><td style="border-right:1.5px solid #888; border-bottom:1px solid #ddd; padding:2px 8px; text-align:center; width:60px; ${hwAttr}">1</td><td style="border-right:1.5px solid #888; border-bottom:1px solid #ddd; padding:2px 8px; ${hwAttr}">${uraian}</td><td style="border-right:1.5px solid #888; border-bottom:1px solid #ddd; padding:2px 8px; text-align:right; width:110px; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</td><td style="border-bottom:1px solid #ddd; padding:2px 8px; text-align:right; width:120px; ${hwAttr}">${jumlah.toLocaleString('id-ID')}</td></tr>`;
                        for (let i = 0; i < 11; i++) {
                            plainRows += `<tr style="height:32px;"><td style="border-right:1.5px solid #888; border-bottom:1px solid #ddd;"></td><td style="border-right:1.5px solid #888; border-bottom:1px solid #ddd;"></td><td style="border-right:1.5px solid #888; border-bottom:1px solid #ddd;"></td><td style="border-bottom:1px solid #ddd;"></td></tr>`;
                        }
                    }

                    html = `
                        <div style="font-family: 'Arial', sans-serif; color: #1a1a1a; padding: 22px 26px; background: #fffef5; width: 100%; border: 1.5px solid #c8b89a; border-radius: 3px; box-shadow: inset 0 0 40px rgba(180,150,80,0.06);">
                            
                            <!-- Header: tanggal & kepada -->
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:14px;">
                                <div style="font-size:13px; line-height:2;">
                                    <div>Kepada Yth. <span style="border-bottom:1px solid #888; display:inline-block; min-width:180px; padding-bottom:1px; ${hwAttr}">${schoolData.name}</span></div>
                                    <div>di &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Tempat</div>
                                </div>
                                <div style="text-align:right; font-size:13px; line-height:2;">
                                    <div>${schoolData.kecamatan}, <span style="border-bottom:1px solid #888; display:inline-block; min-width:120px; padding-bottom:1px; ${hwAttr}">${dateInfo.fullDate}</span></div>
                                    <div>No. &nbsp;<span style="border-bottom:1px solid #888; display:inline-block; min-width:80px; padding-bottom:1px; ${hwAttr}">-</span></div>
                                </div>
                            </div>

                            <!-- Divider -->
                            <div style="border-top:1.5px solid #888; margin-bottom:0;"></div>

                            <!-- Table with vertical lines -->
                            <table style="width:100%; border-collapse:collapse; font-size:13px; font-family: inherit;">
                                <thead>
                                    <tr style="border-bottom:1.5px solid #888;">
                                        <th style="border-right:1.5px solid #888; padding:6px 8px; width:60px; font-weight:600; text-align: center;">Banyak</th>
                                        <th style="border-right:1.5px solid #888; padding:6px 8px; text-align:left; font-weight:600;">Nama Barang</th>
                                        <th style="border-right:1.5px solid #888; padding:6px 8px; width:110px; font-weight:600; text-align: right;">Harga</th>
                                        <th style="padding:6px 8px; text-align:right; width:120px; font-weight:600;">Jumlah</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${plainRows}
                                </tbody>
                            </table>

                            <!-- Total row -->
                            <div style="display:flex; justify-content:flex-end; border-top:1.5px solid #888; padding-top:8px; margin-top:0;">
                                <div style="font-size:14px; font-weight:700; display:flex; gap:20px; align-items:center;">
                                    <span>Jumlah</span>
                                    <span style="border-bottom:1.5px solid #333; min-width:140px; text-align:right; display:inline-block; padding-bottom:2px; ${hwAttr}">Rp ${jumlah.toLocaleString('id-ID')}</span>
                                </div>
                            </div>

                            <!-- Terbilang -->
                            <div style="font-size:11px; color:#555; margin-top:4px; font-style:italic; text-align:right; ${hwAttr}">Terbilang: ${terbilangText}</div>

                            <!-- Signatures -->
                            <div style="display:flex; justify-content:space-between; margin-top:30px; font-size:13px;">
                                <div style="text-align:center;">
                                    <div style="margin-bottom:50px;">Yang Menerima,</div>
                                    <div style="border-top:1px solid #555; width:130px; padding-top:4px;">( ..................... )</div>
                                </div>
                                <div style="text-align:center; position:relative;">
                                    <div style="margin-bottom:50px;">Hormat Kami,</div>
                                    ${stampBase64 ? `<img src="${stampBase64}" style="position:absolute; top:0; left:50%; transform:translateX(-50%); width:65px; opacity:0.65;">` : ''}
                                    <div style="border-top:1px solid #555; width:130px; padding-top:4px;">( ..................... )</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (vendorStyle.startsWith('custom_')) {
                    // --- CUSTOM TEMPLATE RENDERER ---
                    const templates = JSON.parse(localStorage.getItem('spj_custom_templates') || '{}');
                    const tpl = templates[vendorStyle];
                    if (tpl) {
                        try {
                            // Simple replacement strategy for common variables
                            let rawHtml = tpl.html;

                            // Helper to replace ${var}
                            const replaceVar = (str, key, value) => str.split('${' + key + '}').join(value);

                            rawHtml = replaceVar(rawHtml, 'vendorName', vendorName || "NAMA TOKO");
                            rawHtml = replaceVar(rawHtml, 'vendorAddress', vendorAddress);
                            rawHtml = replaceVar(rawHtml, 'tanggal', tanggal);
                            rawHtml = replaceVar(rawHtml, 'schoolData.name', schoolData.name);
                            rawHtml = replaceVar(rawHtml, 'schoolData.address', schoolData.address);
                            rawHtml = replaceVar(rawHtml, 'schoolData.kecamatan', schoolData.kecamatan);
                            rawHtml = replaceVar(rawHtml, 'schoolData.principal', schoolData.principal);
                            rawHtml = replaceVar(rawHtml, 'nomorSurat', nomorSurat);
                            rawHtml = replaceVar(rawHtml, 'itemsHtml', itemsHtml);
                            rawHtml = replaceVar(rawHtml, 'itemsHtmlSwapped', itemsHtmlSwapped);
                            rawHtml = replaceVar(rawHtml, 'jumlah.toLocaleString(\'id-ID\')', jumlah.toLocaleString('id-ID'));
                            rawHtml = replaceVar(rawHtml, 'terbilangText', terbilangText);
                            rawHtml = replaceVar(rawHtml, 'hwAttr', hwAttr);

                            html = rawHtml;
                        } catch (e) {
                            html = `<div style="color:red; padding:20px;">Error rendering custom template: ${e.message}</div>`;
                        }
                    }
                }
            } else if (docType === 'pesanan') {
                // --- TEMPLATE SURAT PESANAN (FORMAL) ---
                html = `
                    <div style="font-family: 'Times New Roman', Times, serif; color: #000; padding: 10px 40px;">
                        ${schoolKop}
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                            <p>${schoolData.kecamatan}, ${datePesanInfo.fullDate}</p>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 20px 1fr; gap: 5px; margin-bottom: 30px;">
                            <div>Nomor</div><div>:</div><div>${nomorSurat}</div>
                            <div>Sifat</div><div>:</div><div>Biasa</div>
                            <div>Lampiran</div><div>:</div><div>-</div>
                            <div>Perihal</div><div>:</div><div style="font-weight: bold; text-decoration: underline;">${perihal}</div>
                            
                            <div style="grid-column: 3; margin-top: 10px;">
                                <strong>Kepada Yth,</strong><br>
                                <strong>${vendorName}</strong><br>
                                di Tempat
                            </div>
                        </div>

                        <p>Assalamualaikum Wr, Wb.</p>
                        <p style="text-indent: 40px; text-align: justify; line-height: 1.5;">
                            Dengan Hormat, Bersamaan ini kami sampaikan bahwa sehubungan dengan akan dilaksanakannya kegiatan pada tanggal <b>${dateKegiatanInfo.fullDate}</b>, Kami bermaksud ingin memesan kebutuhan dengan rincian sebagai berikut:
                        </p>

                        <div style="margin: 20px auto; width: 90%;">
                            <table style="width: 100%; border-collapse: collapse; border: 1px solid #000;">
                                <tr style="background: #f0f0f0;">
                                    <th style="border: 1px solid #000; padding: 8px;">No</th>
                                    <th style="border: 1px solid #000; padding: 8px;">Uraian Barang/Kebutuhan</th>
                                    <th style="border: 1px solid #000; padding: 8px;">Jumlah</th>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">1</td>
                                    <td style="border: 1px solid #000; padding: 8px;">${cleanUraian}</td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">1 Paket</td>
                                </tr>
                            </table>
                        </div>

                        <p style="text-indent: 40px; margin-bottom: 40px;">Demikian surat pesanan ini kami sampaikan, Atas perhatiannya dan kerjasamanya kami ucapkan terimakasih.</p>

                        <div style="display: flex; justify-content: flex-end; padding-right: 50px;">
                            <div style="text-align: center;">
                                <p>Mengetahui,</p>
                                <p style="font-weight: bold; margin-bottom: 80px;">Kepala Sekolah</p>
                                <p style="font-weight: bold; text-decoration: underline; margin:0;">${schoolData.principal}</p>
                                <p style="margin:0;">NIP. ${schoolData.principalNip}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (docType === 'berita_acara') {
                // --- TEMPLATE BERITA ACARA SERAH TERIMA ---
                html = `
                    <div style="font-family: 'Times New Roman', Times, serif; color: #000; padding: 10px 40px;">
                        ${schoolKop}
                        
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h3 style="text-decoration: underline; margin: 0; font-size: 16px;">BERITA ACARA SERAH TERIMA BARANG/JASA</h3>
                            <p style="margin: 5px 0 0 0;">Nomor: ${nomorSurat}</p>
                        </div>

                        <p style="text-align: justify; line-height: 1.6;">
                            Pada hari ini <strong>${dateInfo.dayName}</strong> tanggal <strong>${dateInfo.fullDate}</strong>, kami yang bertanda tangan di bawah ini:
                        </p>

                        <table style="width: 100%; margin-bottom: 20px;">
                            <tr>
                                <td style="width: 30px; vertical-align: top;">1.</td>
                                <td style="width: 100px; vertical-align: top;">Nama</td>
                                <td style="vertical-align: top;">: <strong>${vendorName}</strong></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td style="vertical-align: top;">Alamat</td>
                                <td style="vertical-align: top;">: ${vendorAddress}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td colspan="2" style="padding-top: 5px;">Selanjutnya disebut <strong>PIHAK PERTAMA</strong></td>
                            </tr>
                            <tr><td colspan="3" style="height: 15px;"></td></tr>
                            <tr>
                                <td style="width: 30px; vertical-align: top;">2.</td>
                                <td style="width: 100px; vertical-align: top;">Nama</td>
                                <td style="vertical-align: top;">: <strong>${schoolData.principal}</strong></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td style="vertical-align: top;">NIP</td>
                                <td style="vertical-align: top;">: ${schoolData.principalNip}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td style="vertical-align: top;">Jabatan</td>
                                <td style="vertical-align: top;">: Kepala Sekolah ${schoolData.name}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td colspan="2" style="padding-top: 5px;">Selanjutnya disebut <strong>PIHAK KEDUA</strong></td>
                            </tr>
                        </table>

                        <p style="text-align: justify; line-height: 1.6;">
                            PIHAK PERTAMA menyerahkan barang/jasa kepada PIHAK KEDUA, dan PIHAK KEDUA menerima barang/jasa dari PIHAK PERTAMA berupa:
                        </p>

                        <div style="border: 1px solid #000; padding: 15px; margin: 10px 0;">
                            <table style="width: 100%;">
                                <tr>
                                    <td style="width: 120px; font-weight: bold;">Uraian Barang</td>
                                    <td>: ${uraian}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">Nilai Barang</td>
                                    <td>: Rp ${jumlah.toLocaleString('id-ID')}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">Terbilang</td>
                                    <td style="font-style: italic;">: ${terbilangText}</td>
                                </tr>
                            </table>
                        </div>

                        <p style="text-align: justify; line-height: 1.6; margin-bottom: 40px;">
                            Demikian Berita Acara Serah Terima ini dibuat dengan sebenarnya untuk dapat dipergunakan sebagaimana mestinya.
                        </p>

                        <div style="display: flex; justify-content: space-between; text-align: center;">
                            <div style="width: 200px;">
                                <p>PIHAK PERTAMA</p>
                                <br><br><br><br>
                                <p style="font-weight: bold; text-decoration: underline;">${vendorName}</p>
                            </div>
                            <div style="width: 200px;">
                                <p>PIHAK KEDUA</p>
                                <br><br><br><br>
                                <p style="font-weight: bold; text-decoration: underline;">${schoolData.principal}</p>
                                <p>NIP. ${schoolData.principalNip}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (docType === 'kwitansi') {
                // --- TEMPLATE KWITANSI BENDAHARA (SESUAI GAMBAR) ---
                html = `
                    <div style="border: 4px double #000; padding: 25px; font-family: Arial, sans-serif; color: #000; background: #fff;">
                        <h1 style="text-align: center; text-decoration: underline; margin-bottom: 20px; font-size: 24px; letter-spacing: 5px;">KUITANSI</h1>
                        
                        <div style="display: grid; grid-template-columns: 180px 20px 1fr; gap: 10px; line-height: 2;">
                            <div style="font-weight: bold;">Nomor</div><div>:</div><div style="border-bottom: 1px dashed #000;">${nomorSurat}</div>
                            
                            <div>Sudah terima dari</div><div>:</div><div style="border-bottom: 1px dashed #000; font-weight: bold;">BENDAHARA BOS ${schoolData.name}</div>
                            
                            <div>Banyaknya uang</div><div>:</div><div style="background: #e2e8f0; padding: 0 10px; font-style: italic; font-weight: bold;">### ${terbilangText} ###</div>
                            
                            <div>Untuk pembayaran</div><div>:</div><div style="border-bottom: 1px dashed #000;">${uraian}</div>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-top: 40px;">
                            <div style="text-align: center; border: 1px solid #000; padding: 10px 15px; min-width: 150px; height: fit-content; margin-bottom: 10px;">
                                <p style="margin:0; font-size: 11px;">Jumlah Rp.</p>
                                <p style="margin:0; font-size: 18px; font-weight: bold;">${jumlah.toLocaleString('id-ID')},-</p>
                            </div>
                            
                            <div style="display: flex; gap: 40px;">
                                <div style="text-align: center;">
                                    <p style="margin-bottom: 5px; font-size: 13px;">Setuju Dibayar,</p>
                                    <p style="font-weight: bold; margin-bottom: 60px; font-size: 13px;">Kepala Sekolah</p>
                                    <p style="font-weight: bold; text-decoration: underline; margin:0; font-size: 12px;">${schoolData.principal}</p>
                                    <p style="margin:0; font-size: 11px;">NIP. ${schoolData.principalNip}</p>
                                </div>
                                <div style="text-align: center;">
                                    <p style="margin-bottom: 5px; font-size: 13px;">Lunas Dibayar,</p>
                                    <p style="font-weight: bold; margin-bottom: 60px; font-size: 13px;">Bendahara</p>
                                    <p style="font-weight: bold; text-decoration: underline; margin:0; font-size: 12px;">${schoolData.treasurer}</p>
                                    <p style="margin:0; font-size: 11px;">NIP. ${schoolData.treasurerNip}</p>
                                </div>
                                <div style="text-align: center; position: relative;">
                                    <p style="margin-bottom: 5px; font-size: 13px;">&nbsp;</p>
                                    ${stampBase64 ? `<img src="${stampBase64}" style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 70px; opacity: 0.8;">` : ''}
                                    <p style="font-weight: bold; margin-bottom: 60px; font-size: 13px;">Penerima</p>
                                    <p style="font-weight: bold; margin:0; font-size: 14px; white-space: nowrap;">( ${vendorName || "................................."} )</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (docType === 'undangan') {
                // --- TEMPLATE UNDANGAN (SESUAI TEKS) ---
                html = `
                    <div style="font-family: 'Times New Roman', Times, serif; color: #000; padding: 10px 40px;">
                        ${schoolKop}
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                            <p>${schoolData.kecamatan}, ${datePesanInfo.fullDate}</p>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 20px 1fr; gap: 5px; margin-bottom: 30px;">
                            <div>Nomor</div><div>:</div><div>${nomorSurat}</div>
                            <div>Sifat</div><div>:</div><div>Biasa</div>
                            <div>Lampiran</div><div>:</div><div>-</div>
                            <div>Perihal</div><div>:</div><div style="font-weight: bold; text-decoration: underline;">${perihal}</div>
                            
                            <div style="grid-column: 3; margin-top: 10px;">
                                <strong>Kepada Yth,</strong><br>
                                <strong>Bapak/Ibu Kepala Sekolah Dasar Se-Gugus</strong><br>
                                di Tempat
                            </div>
                        </div>

                        <p>Assalamualaikum Wr, Wb.</p>
                        <p style="text-indent: 40px; text-align: justify; line-height: 1.5;">
                            Dengan Hormat, Bersamaan ini kami sampaikan bahwa pelaksanaan <b>${cleanUraian}</b> tahun 2025 akan dilaksanakan pada:
                        </p>

                        <div style="margin: 20px 40px; line-height: 2;">
                            <div style="display: grid; grid-template-columns: 100px 20px 1fr;">
                                <div>Hari</div><div>:</div><div>${dateKegiatanInfo.dayName}</div>
                                <div>Tanggal</div><div>:</div><div>${dateKegiatanInfo.fullDate}</div>
                                <div>Tempat</div><div>:</div><div>${schoolData.name} - ${tempatKegiatan}</div>
                                <div>Waktu</div><div>:</div><div>${waktuKegiatan}</div>
                            </div>
                        </div>

                        <p style="text-indent: 40px; margin-bottom: 40px;">Demikian kami sampaikan, Atas perhatiannya dan kehadirannya kami ucapkan terimakasih.</p>

                        <div style="display: flex; justify-content: flex-end; padding-right: 50px;">
                            <div style="text-align: center;">
                                <p style="font-weight: bold; margin-bottom: 80px;">Kepala Sekolah,</p>
                                <p style="font-weight: bold; text-decoration: underline; margin:0;">${schoolData.principal}</p>
                                <p style="margin:0;">NIP. ${schoolData.principalNip}</p>
                            </div>
                        </div>

                        <div style="margin-top: 40px; font-size: 11px;">
                            <p style="text-decoration: underline; margin:0;">Tembusan:</p>
                            <div style="white-space: pre-line; margin:0; padding-left: 20px;">${tembusan}</div>
                        </div>
                    </div>
                `;
            } else if (docType === 'notulen') {
                html = getNotulenHtml(uraian, dateInfo, schoolData, schoolKop);
            } else if (docType === 'daftar_hadir') {
                html = getDaftarHadirHtml(uraian, schoolData, schoolKop);
            } else if (docType === 'dokumentasi') {
                html = getDokumentasiHtml(uraian, dateInfo, schoolData, schoolKop);
            } else if (docType === 'rencana') {
                html = getRencanaHtml(uraian, schoolData, schoolKop);
            } else if (docType === 'spk') {
                html = getSpkHtml(uraian, schoolData, schoolKop);
            }

            document.getElementById('paperContent').innerHTML = html;
        }

        /**
         * Dynamic Document Templates Helper Functions
         */
        function getNotulenHtml(uraian, dateInfo, schoolData, schoolKop) {
            // Clean Uraian for Notulen
            const cleanUraian = uraian.replace(/^(Belanja )?Konsumsi \((Makan & Snack|Makan|Snack)\) /i, "")
                .replace(/^Konsumsi \((Makan & Snack|Makan|Snack)\) /i, "");

            const hariTanggal = document.getElementById('custTanggalKegiatan').value || getDateText(new Date()).fullDate;
            const waktu = document.getElementById('custWaktuKegiatan').value || "08.00 s.d Selesai";
            const tempat = document.getElementById('custTempatKegiatan').value || "Ruang Kelas";

            return `
                <div style="font-family: Arial, sans-serif; color: #000; padding: 10px 40px;">
                    ${schoolKop}
                    <div style="text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 20px; text-decoration: underline;">NOTULEN KEGIATAN</div>
                    
                    <table style="width: 100%; margin-bottom: 20px;">
                        <tr><td style="width: 150px;">Hari / Tanggal</td><td>: ${hariTanggal}</td></tr>
                        <tr><td>Waktu</td><td>: ${waktu}</td></tr>
                        <tr><td>Tempat</td><td>: ${tempat}</td></tr>
                        <tr><td>Acara</td><td>: ${cleanUraian}</td></tr>
                    </table>
                    
                    <div style="text-align: justify; margin-bottom: 20px;">
                        Pada hari ini <strong>${hariTanggal}</strong>, bertempat di <strong>${tempat}</strong>, telah dilaksanakan kegiatan <strong>${cleanUraian}</strong>.
                        <br><br>
                        Adapun hasil kegiatan tersebut adalah sebagai berikut:
                        <br>
                        <div style="border: 1px solid #000; height: 300px; margin-top: 10px;"></div>
                    </div>

                    <div style="display: flex; justify-content: flex-end; margin-top: 40px;">
                        <div style="text-align: center;">
                            <p style="margin-bottom: 5px;">${schoolData.kecamatan}, ${hariTanggal}</p>
                            <p style="font-weight: bold; margin-bottom: 80px;">Ketua Panitia / Notulen,</p>
                            <p style="font-weight: bold; text-decoration: underline; margin:0;">( .................................... )</p>
                        </div>
                    </div>
                </div>`;
        }

        function getDaftarHadirHtml(uraian, schoolData, schoolKop) {
            // Clean Uraian for Daftar Hadir
            const cleanUraian = uraian.replace(/^(Belanja )?Konsumsi \((Makan & Snack|Makan|Snack)\) /i, "")
                .replace(/^Konsumsi \((Makan & Snack|Makan|Snack)\) /i, "");

            const attendanceRows = document.querySelectorAll('.attendance-row');
            let listHtml = '';
            attendanceRows.forEach((row, i) => {
                const inputs = row.querySelectorAll('input');
                const isEven = (i + 1) % 2 === 0;
                listHtml += `
                    <tr style="height: 50px;">
                        <td style="border: 1px solid #000; text-align: center;">${i + 1}</td>
                        <td style="border: 1px solid #000; padding-left: 8px;">${inputs[0].value || ""}</td>
                        <td style="border: 1px solid #000; padding-left: 8px;">${inputs[1].value || ""}</td>
                        <td style="border: 1px solid #000;">
                            <div style="display: flex; padding-left: 10px; font-size: 11px;">
                                <span>${i + 1}.</span>
                                <div style="width: 100%; border-bottom: 1px dotted #000; margin-top: 15px; margin-left: ${isEven ? '80' : '0'}px;"></div>
                            </div>
                        </td>
                    </tr> `;
            });
            return `
                <div style="font-family: 'Times New Roman', Times, serif; color: #000; padding: 10px 40px;">
                    ${schoolKop}
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">DAFTAR HADIR</h2>
                        <h3 style="margin: 0; font-size: 16px;">${cleanUraian}</h3>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 40px; font-size: 13px;">
                        <thead><tr style="background: #f0f0f0;"><th style="border: 1px solid #000; padding: 10px; width: 40px;">NO</th>
                        <th style="border: 1px solid #000; padding: 10px;">NAMA</th><th style="border: 1px solid #000; padding: 10px; width: 180px;">JABATAN</th>
                        <th style="border: 1px solid #000; padding: 10px; width: 180px;">TANDA TANGAN</th></tr></thead>
                        <tbody>${listHtml || '<tr><td colspan="4" style="text-align:center; padding:20px;">Belum ada data hadir</td></tr>'}</tbody>
                    </table>
                    <div style="display: flex; justify-content: flex-end;"><div style="text-align: center; width: 250px;">
                    <p style="margin-bottom: 5px;">Mengetahui,</p><p style="font-weight: bold; margin-bottom: 80px;">Kepala Sekolah</p>
                    <p style="font-weight: bold; text-decoration: underline; margin:0;">${schoolData.principal}</p><p style="margin:0;">NIP. ${schoolData.principalNip}</p>
                    </div></div>
                </div > `;
        }

        function getDokumentasiHtml(uraian, dateInfo, schoolData, schoolKop) {
            const cleanUraian = uraian.replace(/^(Belanja )?Konsumsi \((Makan & Snack|Makan|Snack)\) /i, "")
                .replace(/^Konsumsi \((Makan & Snack|Makan|Snack)\) /i, "");

            // Collect uploaded photos in order (index 1-5)
            const photos = [];
            for (let i = 1; i <= 5; i++) {
                if (docPhotos[i]) photos.push(docPhotos[i]);
            }
            const count = photos.length;

            let photoHtml = '';
            const imgStyle = (maxH) => `max-width:100%; max-height:${maxH}px; object-fit:contain; display:block; margin:auto;`;
            const box = (src, maxH) => `<div style="border:1px solid #555; padding:6px; background:#fafafa;"><img src="${src}" style="${imgStyle(maxH)}"></div>`;
            const caption = (n) => `<div style="text-align:center; font-size:10px; color:#555; margin-top:3px;">Foto ${n}</div>`;
            const cell = (src, n, maxH) => `<div>${box(src, maxH)}${caption(n)}</div>`;

            if (count === 0) {
                // Placeholder
                photoHtml = `<div style="border:2px dashed #ccc; width:100%; height:280px; display:flex; align-items:center; justify-content:center; color:#aaa; font-size:14px; border-radius:4px;"> Foto Kegiatan Belum Diupload</div>`;

            } else if (count === 1) {
                // 1 foto  full width, tall
                photoHtml = `
                    <div style="width:100%;">
                        ${box(photos[0], 480)}
                        ${caption(1)}
                    </div>`;

            } else if (count === 2) {
                // 2 foto  side by side
                photoHtml = `
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; width:100%;">
                        ${cell(photos[0], 1, 320)}
                        ${cell(photos[1], 2, 320)}
                    </div>`;

            } else if (count === 3) {
                // 3 foto  1 besar di atas, 2 kecil di bawah
                photoHtml = `
                    <div style="display:flex; flex-direction:column; gap:12px; width:100%;">
                        <div>${box(photos[0], 320)}${caption(1)}</div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                            ${cell(photos[1], 2, 220)}
                            ${cell(photos[2], 3, 220)}
                        </div>
                    </div>`;

            } else if (count === 4) {
                // 4 foto  grid 2x2
                photoHtml = `
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; width:100%;">
                        ${cell(photos[0], 1, 240)}
                        ${cell(photos[1], 2, 240)}
                        ${cell(photos[2], 3, 240)}
                        ${cell(photos[3], 4, 240)}
                    </div>`;

            } else if (count === 5) {
                // 5 foto  2 di atas, 3 di bawah
                photoHtml = `
                    <div style="display:flex; flex-direction:column; gap:12px; width:100%;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                            ${cell(photos[0], 1, 210)}
                            ${cell(photos[1], 2, 210)}
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                            ${cell(photos[2], 3, 180)}
                            ${cell(photos[3], 4, 180)}
                            ${cell(photos[4], 5, 180)}
                        </div>
                    </div>`;
            }

            return `
                <div style="font-family:'Times New Roman',Times,serif; color:#000; padding:10px 40px;">
                    ${schoolKop}
                    <div style="text-align:center; margin-bottom:16px;">
                        <h2 style="text-decoration:underline; margin-bottom:6px; font-size:18px;">LEMBAR DOKUMENTASI</h2>
                        <h3 style="margin:0; font-size:15px; font-weight:normal;">${cleanUraian}</h3>
                    </div>
                    <div style="width:100%; margin-top:12px;">
                        ${photoHtml}
                    </div>
                    <div style="margin-top:30px; display:flex; justify-content:flex-end;">
                        <div style="text-align:center;">
                            <p style="margin-bottom:4px;">${schoolData.kecamatan}, ${dateInfo.fullDate}</p>
                            <p style="font-weight:bold; margin-bottom:70px;">Kepala Sekolah,</p>
                            <p style="font-weight:bold; text-decoration:underline; margin:0;">${schoolData.principal}</p>
                            <p style="margin:0;">NIP. ${schoolData.principalNip}</p>
                        </div>
                    </div>
                </div>`;
        }

        function getRencanaHtml(uraian, schoolData, schoolKop) {
            const kategori = document.getElementById('custKategori').value || "-";
            const jumlahBarang = document.getElementById('custJumlahBarang').value || "1";
            const spesifikasi = document.getElementById('custSpesifikasi').value || uraian;
            const waktuSerah = document.getElementById('custTanggal').value || "-";
            const lokasi = document.getElementById('custTempatKegiatan').value || schoolData.name;
            const anggaran = document.getElementById('custJumlah').value || "0";
            const persyaratan = (document.getElementById('custPersyaratan').value || "").replace(/\n/g, '<br>');
            const tanggal = document.getElementById('custTanggal').value || "";

            // Pelaksana Logic
            const pelaksanaName = document.getElementById('custPelaksanaNameRencana').value || schoolData.principal;
            const pelaksanaNip = document.getElementById('custPelaksanaNipRencana').value || schoolData.principalNip;

            // Format anggaran
            let anggaranFmt = "0";
            try {
                anggaranFmt = parseInt(anggaran).toLocaleString('id-ID');
            } catch (e) { }


            return `
                <div style="font-family: Arial, sans-serif; color: #000; padding: 10px 40px;">
                    ${schoolKop}
                    <div style="text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 20px; text-decoration: underline;">DOKUMEN PERENCANAAN</div>
                    
                    <table style="width: 100%; font-weight: bold; margin-bottom: 20px;">
                        <tr><td style="width: 200px;">Nama Satuan Pendidikan</td><td>: ${schoolData.name}</td></tr>
                        <tr><td>Alamat Satuan Pendidikan</td><td>: ${schoolData.address}</td></tr>
                        <tr><td>Kategori Barang/Jasa</td><td>: ${kategori}</td></tr>
                    </table>

                     <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #000; padding: 5px; text-align: center; width: 40px;">NO.</th>
                                <th style="border: 1px solid #000; padding: 5px; text-align: center;">JENIS</th>
                                <th style="border: 1px solid #000; padding: 5px; text-align: center;">KETERANGAN</th>
                            </tr>
                        </thead>
                        <tbody>
                             <tr>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">1</td>
                                <td style="border: 1px solid #000; padding: 5px;">Jumlah barang/jasa</td>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">${jumlahBarang}</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">2</td>
                                <td style="border: 1px solid #000; padding: 5px;">Spesifikasi/ruang lingkup barang/jasa</td>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">${spesifikasi}</td>
                            </tr>
                             <tr>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">3</td>
                                <td style="border: 1px solid #000; padding: 5px;">Waktu serah terima</td>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">${waktuSerah}</td>
                            </tr>
                             <tr>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">4</td>
                                <td style="border: 1px solid #000; padding: 5px;">Lokasi serah terima</td>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">${lokasi}</td>
                            </tr>
                             <tr>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center;">5</td>
                                <td style="border: 1px solid #000; padding: 5px;">Alokasi anggaran</td>
                                <td style="border: 1px solid #000; padding: 5px; text-align: right;">Rp <span style="float:right;">${anggaranFmt}</span></td>
                            </tr>
                             <tr>
                                <td style="border: 1px solid #000; padding: 5px; text-align: center; vertical-align: top;">6</td>
                                <td style="border: 1px solid #000; padding: 5px; vertical-align: top;">Persyaratan Penyedia</td>
                                <td style="border: 1px solid #000; padding: 5px;">${persyaratan}</td>
                            </tr>
                        </tbody>
                    </table>

                     <div style="display: flex; justify-content: flex-end; margin-top: 40px;">
                        <div style="text-align: center;">
                            <p style="margin-bottom: 5px;">${schoolData.kecamatan}, ${getDateText(tanggal).fullDate}</p>
                            <p style="font-weight: bold; margin-bottom: 80px;">Pelaksana</p>
                            <p style="font-weight: bold; text-decoration: underline; margin:0;">${pelaksanaName}</p>
                            <p style="margin:0;">NIP. ${pelaksanaNip}</p>
                        </div>
                    </div>
                     <div style="margin-top: 20px; font-size: 11px;">
                        (*) Misalnya Buku Teks Utama/Buku Teks Pendamping/Buku Nonteks/Kebutuhan dan Perlengkapan Satuan Pendidikan/Alat Peraga Pendidikan/Komputer dan Aksesoris/Elektronik/Jasa lainnya.
                    </div>
                </div >
            `;
        }

        function getSpkHtml(uraian, schoolData, schoolKop) {
            const nomorSpk = document.getElementById('custNomorSurat').value || "";
            const tglSpk = document.getElementById('custTanggal').value || "";
            const tglNegosiasi = document.getElementById('custTglNegosiasi').value || "";
            const waktuPelaksanaan = document.getElementById('custWaktuPelaksanaan').value || document.getElementById('custTanggal').value || "";
            const waktuPenyelesaian = document.getElementById('custWaktuPenyelesaian').value || "";
            const instruksi = (document.getElementById('custInstruksi').value || "").replace(/\n/g, '<br>');
            const jumlahTotal = parseInt(document.getElementById('custJumlah').value || "0");
            const penyedia = document.getElementById('custSpkProvider').value || "Penyedia Barang/Jasa"; // SPK Provider Logic

            // Pelaksana Logic
            const pelaksanaName = document.getElementById('custPelaksanaNameSpk').value || schoolData.principal;
            const pelaksanaNip = document.getElementById('custPelaksanaNipSpk').value || schoolData.principalNip;

            // Get Items from Nota List logic
            const items = [];
            document.querySelectorAll('.nota-item-row').forEach(row => {
                const inputs = row.querySelectorAll('input');
                items.push({
                    name: inputs[0].value,
                    qty: parseInt(inputs[1].value) || 0,
                    price: parseInt(inputs[2].value) || 0,
                    total: (parseInt(inputs[1].value) || 0) * (parseInt(inputs[2].value) || 0)
                });
            });

            // Fallback if no items
            if (items.length === 0) {
                items.push({
                    name: document.getElementById('custUraian').value || "",
                    qty: 1,
                    price: jumlahTotal,
                    total: jumlahTotal
                });
            }

            const itemsHtml = items.map((item, i) => `
                <tr style="height: 25px;">
                    <td style="border: 1px solid #000; padding: 2px 5px; text-align: center;">${i + 1}</td>
                    <td style="border: 1px solid #000; padding: 2px 5px;">${item.name}</td>
                    <td style="border: 1px solid #000; padding: 2px 5px; text-align: center;">${item.qty}</td>
                    <td style="border: 1px solid #000; padding: 2px 5px; text-align: center;">unit</td>
                    <td style="border: 1px solid #000; padding: 2px 5px; text-align: right;">Rp ${item.price.toLocaleString('id-ID')}</td>
                    <td style="border: 1px solid #000; padding: 2px 5px; text-align: right;">Rp ${item.total.toLocaleString('id-ID')}</td>
                </tr>
            `).join('');

            // Reduced empty rows
            // Reduced empty rows
            const emptyRows = Array(Math.max(0, 3 - items.length)).fill(`
                <tr style="height: 25px;">
                     <td style="border: 1px solid #000; padding: 2px 5px;">&nbsp;</td>
                     <td style="border: 1px solid #000; padding: 2px 5px;"></td>
                     <td style="border: 1px solid #000; padding: 2px 5px;"></td>
                     <td style="border: 1px solid #000; padding: 2px 5px;"></td>
                     <td style="border: 1px solid #000; padding: 2px 5px;">Rp -</td>
                     <td style="border: 1px solid #000; padding: 2px 5px;">Rp -</td>
                </tr>
            `).join('');

            const terbilangText = terbilang(jumlahTotal) + " Rupiah";

            return `
                <div style="font-family: Arial, sans-serif; color: #000; padding: 10px 40px; font-size: 12px;"> 
                    ${schoolKop}
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 5px; border-top:none;">
                        <tr>
                            <td rowspan="3" style="border: 1px solid #000; padding: 5px; width: 40%; vertical-align: middle; text-align: center; font-weight: bold;">
                                SURAT PERINTAH KERJA (SPK)
                            </td>
                            <td style="border: 1px solid #000; padding: 3px 5px;">Nama Satuan Pendidikan : ${schoolData.name}</td>
                        </tr>
                        <tr>
                             <td style="border: 1px solid #000; padding: 3px 5px;">Nomor SPK : ${nomorSpk}</td>
                        </tr>
                        <tr>
                             <td style="border: 1px solid #000; padding: 3px 5px;">Tanggal SPK : ${getDateText(tglSpk).fullDate}</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #000; padding: 3px 5px;">Paket Pekerjaan : ${uraian}</td>
                            <td style="border: 1px solid #000; padding: 3px 5px;">
                                Tanggal Negosiasi : ${getDateText(tglNegosiasi).fullDate}<br>
                                <span style="font-size: 10px;">SPK ini mulai berlaku efektif terhitung sejak tanggal ditetapkan.</span>
                            </td>
                        </tr>
                    </table>

                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 5px;">
                         <tr>
                            <td style="border: 1px solid #000; padding: 3px 5px; width: 50%;">WAKTU PELAKSANAAN : ${getDateText(waktuPelaksanaan).fullDate}</td>
                            <td style="border: 1px solid #000; padding: 3px 5px;">PENYELESAIAN : ${waktuPenyelesaian ? getDateText(waktuPenyelesaian).fullDate : '-'}</td>
                        </tr>
                    </table>

                    <div style="text-align: center; font-weight: bold; border: 1px solid #000; padding: 3px; border-bottom: none; background: #eee;">RINCIAN PEKERJAAN</div>
                     <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 10px;">
                        <thead>
                            <tr style="text-align: center; font-weight: bold; background: #eee;">
                                <th style="border: 1px solid #000; padding: 3px; width: 30px;">No</th>
                                <th style="border: 1px solid #000; padding: 3px;">Uraian Barang/Jasa</th>
                                <th style="border: 1px solid #000; padding: 3px; width: 60px;">Qty</th>
                                <th style="border: 1px solid #000; padding: 3px; width: 60px;">Sat</th>
                                <th style="border: 1px solid #000; padding: 3px; width: 100px;">Harga</th>
                                <th style="border: 1px solid #000; padding: 3px; width: 100px;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                            ${emptyRows}
                            <tr style="background: #fbbf24; font-weight: bold;">
                                <td colspan="5" style="border: 1px solid #000; padding: 3px 5px; text-align: right;">Total Pembayaran</td>
                                <td style="border: 1px solid #000; padding: 3px 5px; text-align: right;">Rp ${jumlahTotal.toLocaleString('id-ID')}</td>
                            </tr>
                              <tr>
                                <td colspan="6" style="border: 1px solid #000; padding: 3px 5px; font-weight: bold; background: #f3f4f6; font-style: italic;">
                                    Terbilang : ${terbilangText}
                                </td>
                            </tr>
                        </tbody>
                    </table>

                     <div style="border: 1px solid #000; padding: 5px; margin-bottom: 20px;">
                        <span style="text-decoration: underline; font-weight: bold;">INSTRUKSI:</span><br>
                        ${instruksi}
                     </div>

                      <table style="width: 100%; border-collapse: collapse; border: 1px solid #000;">
                        <tr>
                            <td style="border: 1px solid #000; padding: 10px; width: 50%; text-align: center; vertical-align: top;">
                                <br>
                                <strong>Penyedia,</strong>
                                <br><br><br><br>
                                <strong>${penyedia}</strong>
                            </td>
                            <td style="border: 1px solid #000; padding: 10px; width: 50%; text-align: center; vertical-align: top;">
                                ${schoolData.kecamatan}, ${getDateText(tglSpk).fullDate}<br>
                                <strong>Pelaksana,</strong>
                                <br><br><br><br>
                                <strong>${pelaksanaName}</strong><br>
                                NIP. ${pelaksanaNip}
                            </td>
                        </tr>
                      </table>
                </div>
             `;
        }



        // --- Toast Notification System ---
        function showToast(message, type = 'success', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.classList.add('toast', type);

            let iconHtml = '';
            if (type === 'success') {
                iconHtml = '<i data-lucide="check-circle" size="20"></i>';
            } else if (type === 'error') {
                iconHtml = '<i data-lucide="x-circle" size="20"></i>';
            } else {
                iconHtml = '<i data-lucide="info" size="20"></i>';
            }

            toast.innerHTML = `
                <div class="toast-icon">${iconHtml}</div>
                <div class="toast-content">
                    <div class="toast-title">${message}</div>
                </div>
            `;
            toastContainer.appendChild(toast);
            lucide.createIcons(); // Re-render lucide icons for the new toast

            setTimeout(() => {
                toast.classList.add('toast-out');
                toast.addEventListener('animationend', () => {
                    toast.remove();
                });
            }, duration);
        }

        // --- Custom Confirm Modal System ---
        let confirmCallback = null;

        function showConfirm(message, onConfirm, title = "Konfirmasi") {
            const confirmOverlay = document.getElementById('confirmOverlay');
            document.getElementById('confirmTitle').innerText = title;
            document.getElementById('confirmMessage').innerText = message;
            confirmCallback = onConfirm;
            confirmOverlay.style.display = 'flex';
            lucide.createIcons();
        }

        function closeConfirm(confirmed) {
            const confirmOverlay = document.getElementById('confirmOverlay');
            confirmOverlay.style.display = 'none';
            if (confirmed && confirmCallback) {
                confirmCallback();
            }
            confirmCallback = null; // Reset callback
        }


        // Action: Save School Data
        function saveData() {
            const formData = {
                schoolName: document.getElementById('schoolName').value,
                schoolAddress: document.getElementById('schoolAddress').value,
                npsn: document.getElementById('npsn').value,
                kecamatan: document.getElementById('kecamatan').value,
                principalName: document.getElementById('principalName').value,
                principalNip: document.getElementById('principalNip').value,
                treasurerName: document.getElementById('treasurerName').value,
                treasurerNip: document.getElementById('treasurerNip').value
            };

            const btn = document.querySelector('.btn-submit');
            const originalText = btn.innerHTML;

            // Visual feedback
            btn.innerHTML = '<i data-lucide="loader-2" class="spin" size="18"></i> Menyimpan...';
            lucide.createIcons();
            btn.disabled = true;

            // Save to LocalStorage instead of Google Script Properties
            localStorage.setItem('spj_school_data', JSON.stringify(formData));

            setTimeout(() => {
                showToast("Data Berhasil Disimpan di Browser!");
                btn.innerHTML = originalText;
                btn.disabled = false;
                lucide.createIcons();
            }, 500);
        }

        let allTransactions = [];

        function renderTransactions(data) {
            allTransactions = data;
            const tbody = document.getElementById('transactionTbody');
            const container = document.getElementById('transactionTableContainer');
            const emptyState = document.getElementById('emptyState');

            if (data.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            emptyState.style.display = 'none';

            tbody.innerHTML = data.map(tx => `
                <tr class="hover-row" style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 16px; font-size: 14px;">${tx.tanggal}</td>
                    <td style="padding: 16px; font-size: 14px;"><span style="background: #eff6ff; color: #2563eb; padding: 4px 8px; border-radius: 4px; font-weight: 600;">${tx.noBukti}</span></td>
                    <td style="padding: 16px; font-size: 14px; max-width: 300px;">${tx.uraian}</td>
                    <td style="padding: 16px; font-size: 14px; font-weight: 600;">Rp ${tx.pengeluaran.toLocaleString('id-ID')}</td>
                    <td style="padding: 16px; display: flex; gap: 8px;">
                        <button class="btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="generateSpj('${tx.id}')" title="Cetak">
                            <i data-lucide="printer" size="14"></i>
                        </button>
                        <button class="btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="removeTransaction('${tx.id}')" title="Hapus">
                            <i data-lucide="trash-2" size="14"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        // --- Manual Transaction Logic ---
        function openAddModal() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('addDate').value = today;
            document.getElementById('addNoBukti').value = '';
            document.getElementById('addUraian').value = '';
            document.getElementById('addPenerima').value = '';
            document.getElementById('addJumlah').value = '';

            document.getElementById('addModal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }

        function saveManualTransaction() {
            const dateVal = document.getElementById('addDate').value;
            const noBukti = document.getElementById('addNoBukti').value;
            const uraian = document.getElementById('addUraian').value;
            const penerima = document.getElementById('addPenerima').value;
            const jumlah = parseFloat(document.getElementById('addJumlah').value);

            if (!dateVal || !noBukti || !uraian || !jumlah) {
                showToast("Mohon lengkapi Tanggal, No Bukti, Uraian, dan Jumlah.", "error");
                return;
            }

            // Format date dd/mm/yyyy
            const d = new Date(dateVal);
            const formattedDate = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;

            // Determine type automatically based on keywords
            let type = 'nota';
            let vendorStyle = 'standard';
            const uLow = uraian.toLowerCase();
            if (uLow.includes('honor') || uLow.includes('transport')) type = 'kwitansi';
            if (uLow.includes('makan') || uLow.includes('snack')) vendorStyle = 'rm-family';

            const newTx = {
                id: 'MANUAL_' + Date.now(),
                tanggal: formattedDate,
                noBukti: noBukti,
                uraian: uraian,
                pengeluaran: jumlah,
                penerima: penerima || uraian,
                type: type,
                vendorStyle: vendorStyle
            };

            allTransactions.push(newTx);
            renderTransactions(allTransactions);
            closeAddModal();

            // Show feedback
            document.getElementById('extractionInfo').innerText = `Total ${allTransactions.length} transaksi (Termasuk manual)`;
        }

        function removeTransaction(id) {
            showConfirm("Apakah Anda yakin ingin menghapus transaksi ini?", () => {
                allTransactions = allTransactions.filter(tx => tx.id !== id);
                renderTransactions(allTransactions);
                document.getElementById('extractionInfo').innerText = `Total ${allTransactions.length} transaksi`;
                showToast("Transaksi berhasil dihapus");
            });
        }

        function generateSpj(txId) {
            const tx = allTransactions.find(t => t.id === txId);
            if (!tx) return;

            // Pre-fill the customizer - (Redundant school fields removed from UI)

            document.getElementById('custVendorName').value = tx.penerima;
            document.getElementById('custVendorAddress').value = "Alamat " + tx.penerima;
            document.getElementById('custUraian').value = tx.uraian;
            document.getElementById('custJumlah').value = tx.pengeluaran;
            document.getElementById('custTanggal').value = tx.tanggal;
            document.getElementById('custTanggalPesan').value = tx.tanggal;
            document.getElementById('custTanggalKegiatan').value = tx.tanggal;
            document.getElementById('custNomorSurat').value = "020/SD-BOS/" + new Date().getFullYear();

            document.getElementById('custPerihal').value = (tx.type === 'konsumsi' ? "Belanja Konsumsi" : "Pesanan Barang/Jasa");
            document.getElementById('custTempatKegiatan').value = document.getElementById('schoolName').value || "Sekolah";
            document.getElementById('custWaktuKegiatan').value = "08.00 sd Selesai";
            document.getElementById('custTembusan').value = "1. Pengawas Pembina\n2. K3S Kecamatan " + (document.getElementById('kecamatan').value || "");

            const docTypeSelect = document.getElementById('docType');
            if (tx.type === 'konsumsi') {
                docTypeSelect.value = 'nota';
                document.getElementById('vendorStyle').value = tx.vendorStyle || 'standard';
            } else if (tx.type === 'jasa') {
                docTypeSelect.value = 'nota';
                document.getElementById('vendorStyle').value = 'toko-prima';
            } else {
                docTypeSelect.value = 'kwitansi';
            }

            // Populate Nota Items if needed to preserve total
            if (docTypeSelect.value === 'nota') {
                document.getElementById('notaItemsList').innerHTML = '';
                addNotaItem(tx.uraian.replace(/"/g, '&quot;'), 1, tx.pengeluaran);
            }

            handleDocTypeChange(); // This will trigger openPreview and auto-select template
            document.getElementById('previewModal').style.display = 'flex'; // Ensure modal opens
        }

        // --- Drive Picker Logic ---
        function openDrivePicker() {
            document.getElementById('driveModal').style.display = 'flex';
            document.getElementById('driveFileList').innerHTML = `
                                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                        <i data-lucide="loader-2" class="spin" size="32" style="margin-bottom: 10px;"></i>
                                        <p>Mencari file di Drive Anda...</p>
                                    </div>
                                    `;
            lucide.createIcons();

            google.script.run
                .withSuccessHandler((response) => {
                    const listDiv = document.getElementById('driveFileList');
                    if (response.success && response.files && response.files.length > 0) {
                        listDiv.innerHTML = response.files.map(file => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: 0.2s;" 
                                 onclick="processDriveFile('${file.id}', '${file.name}')"
                                 onmouseover="this.style.borderColor='#2563eb'; this.style.background='#eff6ff'"
                                 onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='#f8fafc'">
                                <div>
                                    <div style="font-weight: 600; font-size: 14px;">${file.name}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">${file.date}</div>
                                </div>
                                <i data-lucide="chevron-right" size="18" color="#2563eb"></i>
                            </div>
                        `).join('');
                    } else {
                        listDiv.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i data-lucide="search-x" size="48" style="margin-bottom: 10px; opacity: 0.3;"></i>
                                <p>Tidak ditemukan file PDF dengan nama "BKU" di Drive Anda.</p>
                                <button class="btn-primary" style="margin: 20px auto; font-size: 12px;" onclick="closeDrivePicker()">Tutup</button>
                            </div>
                        `;
                    }
                    lucide.createIcons();
                })
                .getBkuFilesFromDrive();
        }

        function closeDrivePicker() {
            document.getElementById('driveModal').style.display = 'none';
        }

        function processDriveFile(fileId, fileName) {
            closeDrivePicker();

            // Visual feedback on the main button card
            const driveCard = document.querySelector('.upload-card');
            const originalContent = driveCard.innerHTML;
            driveCard.innerHTML = `
                                    <div class="upload-icon-wrapper" style="background: #22c55e; color: white; width: 80px; height: 80px;">
                                        <i data-lucide="loader-2" class="spin" size="40"></i>
                                    </div>
                                    <h3 style="color: #166534;">Membaca File dari Drive...</h3>
                                    <p style="color: #166534;">${fileName}</p>
                                    `;
            lucide.createIcons();

            google.script.run
                .withSuccessHandler((response) => {
                    driveCard.innerHTML = originalContent;
                    lucide.createIcons();

                    if (response.success) {
                        renderTransactions(response.data);
                        document.getElementById('extractionInfo').innerText = `Ditemukan ${response.data.length} transaksi dari Excel: ${fileName}`;
                        showView('manage-view', document.querySelector('.nav-item[onclick*="manage-view"]'));
                    } else {
                        showToast("Gagal memproses file Excel: " + response.error, "error");
                    }
                })
                .processExcelByFileId(fileId);
        }
    </script>
    <style>
        .spin {
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</body>

</html>