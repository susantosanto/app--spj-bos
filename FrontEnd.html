<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si-BOS | Sistem Administrasi</title>
    <!-- Google Fonts: Outfit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --sidebar-bg: #1e3a8a;
            --bg-main: #f8fafc;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --white: #ffffff;
            --sidebar-hover: rgba(255, 255, 255, 0.1);
            --sidebar-active: rgba(255, 255, 255, 0.2);
            --border: #e2e8f0;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar Styles --- */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--sidebar-bg) 0%, #172554 100%);
            color: var(--white);
            display: flex;
            flex-direction: column;
            padding: 24px 16px;
            flex-shrink: 0;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 12px 32px 12px;
        }

        .logo-icon {
            background: var(--white);
            color: var(--sidebar-bg);
            padding: 8px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-text h1 {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .logo-text p {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.7;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: var(--white);
            opacity: 0.8;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-item:hover {
            background: var(--sidebar-hover);
            opacity: 1;
        }

        .nav-item.active {
            background: var(--primary);
            opacity: 1;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .sidebar-footer {
            padding: 12px;
            font-size: 11px;
            opacity: 0.5;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- Main Content Styles --- */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
            padding: 40px;
        }

        .view-section {
            display: none;
            animation: fadeIn 0.4s ease-out;
            max-width: 1200px;
            margin: 0 auto;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Upload View Styles --- */
        .header-center {
            text-align: center;
            margin-bottom: 48px;
        }

        .header-center h2 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1e293b;
        }

        .header-center p {
            color: var(--text-muted);
            font-size: 16px;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .upload-card {
            background: var(--white);
            border: 2px dashed #cbd5e1;
            border-radius: 20px;
            padding: 80px 40px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 60px;
            position: relative;
            overflow: hidden;
        }

        .upload-card:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.02);
            transform: scale(1.01);
        }

        .upload-icon-wrapper {
            width: 80px;
            height: 80px;
            background: #eff6ff;
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            transition: var(--transition);
        }

        .upload-card:hover .upload-icon-wrapper {
            background: var(--primary);
            color: var(--white);
        }

        .upload-card h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-card p {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #fileInput {
            display: none;
        }

        /* --- Info Cards --- */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .info-card {
            background: var(--white);
            padding: 32px 24px;
            border-radius: 16px;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }

        .info-card:hover {
            transform: translateY(-5px);
        }

        .info-card .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .info-card h4 {
            font-size: 18px;
            margin-bottom: 12px;
            color: #1e293b;
        }

        .info-card p {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* --- Transaction View Styles --- */
        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .view-header-text h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .view-header-text p {
            color: var(--text-muted);
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .btn-danger {
            background: #ef4444;
            color: var(--white);
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        tr.hover-row:hover {
            background-color: #f8fafc;
        }

        .empty-state {
            background: var(--white);
            border: 2px dashed #e2e8f0;
            border-radius: 16px;
            padding: 100px 40px;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 48px;
            opacity: 0.2;
            margin-bottom: 16px;
        }

        /* --- Data Sekolah (Settings) Styles --- */
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }

        .settings-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 32px;
        }

        .settings-icon {
            background: #eff6ff;
            color: var(--primary);
            padding: 12px;
            border-radius: 12px;
        }

        .settings-title h3 {
            font-size: 20px;
            font-weight: 700;
        }

        .settings-title p {
            font-size: 14px;
            color: var(--text-muted);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: var(--transition);
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--white);
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .btn-submit {
            grid-column: span 2;
            margin-top: 20px;
            width: 100%;
            justify-content: center;
            padding: 14px;
            font-size: 16px;
        }

        /* --- Preview Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-container {
            background: #e2e8f0;
            width: 95%;
            height: 90vh;
            border-radius: 20px;
            display: flex;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .preview-sidebar {
            width: 350px;
            background: var(--white);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            overflow-y: auto;
        }

        .preview-main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: #cbd5e1;
            position: relative;
        }

        .preview-toolbar {
            background: var(--white);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        /* --- Paper Simulation --- */
        .paper-viewport {
            flex-grow: 1;
            overflow: auto;
            padding: 40px;
            display: flex;
            justify-content: center;
        }

        .paper {
            background: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 40px;
            /* Standar Margin */
            box-sizing: border-box;
            transition: var(--transition);
            position: relative;
            transform-origin: top center;
        }

        .paper.a4 {
            width: 210mm;
            min-height: 297mm;
        }

        .paper.a5-landscape {
            width: 210mm;
            min-height: 148mm;
        }

        .paper.a5-portrait {
            width: 148mm;
            min-height: 210mm;
        }

        /* --- Print Styles --- */
        @media print {
            body * {
                visibility: hidden;
            }

            .paper,
            .paper * {
                visibility: visible;
            }

            .paper {
                position: absolute;
                left: 0;
                top: 0;
                width: 100% !important;
                box-shadow: none;
                padding: 0;
                margin: 0;
            }

            .modal-overlay {
                display: block !important;
                background: white;
            }

            .preview-sidebar,
            .preview-toolbar,
            .sidebar {
                display: none !important;
            }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .info-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .form-group.full-width {
                grid-column: span 1;
            }

            .btn-submit {
                grid-column: span 1;
            }
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-container">
            <div class="logo-icon">
                <i data-lucide="file-text" size="24"></i>
            </div>
            <div class="logo-text">
                <h1>Si-BOS</h1>
                <p>Sistem Administrasi</p>
            </div>
        </div>

        <div class="nav-menu">
            <a href="#" class="nav-item active" onclick="showView('upload-view', this)">
                <i data-lucide="upload-cloud" size="18"></i>
                Unggah BKU
            </a>
            <a href="#" class="nav-item" onclick="showView('manage-view', this)">
                <i data-lucide="layout-grid" size="18"></i>
                Kelola Transaksi
            </a>
            <a href="#" class="nav-item" onclick="showView('settings-view', this)">
                <i data-lucide="school" size="18"></i>
                Data Sekolah
            </a>
        </div>

        <div class="sidebar-footer">
            &copy; 2026 - Developed By <b>Santo X/Code</b>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">

        <!-- View 1: Unggah BKU -->
        <section id="upload-view" class="view-section active">
            <div class="header-center">
                <h2>Mulai Dokumentasi SPJ</h2>
                <p>Unggah file PDF Buku Kas Umum (BKU) Anda. AI kami akan mengekstrak setiap transaksi belanja untuk
                    dibuatkan kwitansi otomatis.</p>
            </div>

            <div style="max-width: 600px; margin: 0 auto 60px;">
                <div class="upload-card" onclick="openDrivePicker()"
                    style="margin-bottom:0; border-style: solid; border-color: #22c55e; background: #f0fdf4; padding: 60px 40px;">
                    <div class="upload-icon-wrapper"
                        style="background: #22c55e; color: white; width: 80px; height: 80px;">
                        <i data-lucide="hard-drive" size="40"></i>
                    </div>
                    <h3 style="color: #166534; font-size: 24px;">Ambil dari Google Drive</h3>
                    <p style="color: #166534; letter-spacing: 2px;">PROSES OTOMATIS TANPA UPLOAD</p>
                    <div style="margin-top: 20px; font-size: 14px; color: #166534; opacity: 0.8;">
                        <i data-lucide="check-circle" size="14"
                            style="display:inline-block; vertical-align:middle;"></i>
                        Aman, Cepat & Tanpa Batas Ukuran File
                    </div>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <div class="icon-box" style="background: rgba(249, 115, 22, 0.1); color: #f97316;">
                        <i data-lucide="file-search" size="24"></i>
                    </div>
                    <h4>Ekstraksi Pintar</h4>
                    <p>Secara otomatis mengenali toko, jumlah, dan jenis belanja sekolah.</p>
                </div>
                <div class="info-card">
                    <div class="icon-box" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
                        <i data-lucide="printer" size="24"></i>
                    </div>
                    <h4>Siap Cetak</h4>
                    <p>Kwitansi dan Nota diformat sesuai standar pelaporan Dana BOS.</p>
                </div>
                <div class="info-card">
                    <div class="icon-box" style="background: rgba(168, 85, 247, 0.1); color: #a855f7;">
                        <i data-lucide="check-circle" size="24"></i>
                    </div>
                    <h4>Akurat & Cepat</h4>
                    <p>Mengurangi kesalahan penulisan angka dan terbilang secara manual.</p>
                </div>
            </div>
        </section>

        <!-- View 2: Kelola Transaksi -->
        <section id="manage-view" class="view-section">
            <div class="view-header">
                <div class="view-header-text">
                    <h2>Kelola Transaksi BKU</h2>
                    <p id="extractionInfo">Daftar pengeluaran yang terdeteksi. Silakan periksa dan cetak dokumen.</p>
                </div>
                <button class="btn-primary" onclick="openAddModal()">
                    <i data-lucide="plus" size="18"></i>
                    Tambah Manual
                </button>
            </div>

            <div id="emptyState" class="empty-state">
                <div class="empty-icon">
                    <i data-lucide="alert-circle" size="64"></i>
                </div>
                <p>Belum ada data. Silakan unggah file BKU atau tambah manual.</p>
                <div style="margin-top: 20px;">
                    <button class="btn-primary" style="margin: 0 auto;" onclick="openPreview()">Demo Preview</button>
                </div>
            </div>

            <div id="transactionTableContainer" style="display: none;">
                <table
                    style="width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--card-shadow);">
                    <thead>
                        <tr style="background: #f1f5f9; text-align: left;">
                            <th style="padding: 16px; font-size: 13px;">Tanggal</th>
                            <th style="padding: 16px; font-size: 13px;">No Bukti</th>
                            <th style="padding: 16px; font-size: 13px;">Uraian</th>
                            <th style="padding: 16px; font-size: 13px;">Jumlah</th>
                            <th style="padding: 16px; font-size: 13px;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transactionTbody">
                        <!-- Items injected via JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- View 3: Data Sekolah -->
        <section id="settings-view" class="view-section">
            <div class="settings-container">
                <div class="settings-header">
                    <div class="settings-icon">
                        <i data-lucide="school" size="32"></i>
                    </div>
                    <div class="settings-title">
                        <h3>Konfigurasi Sekolah</h3>
                        <p>Sesuaikan informasi sekolah untuk kop surat & tanda tangan.</p>
                    </div>
                </div>

                <form id="schoolForm">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Nama Sekolah</label>
                            <input type="text" id="schoolName" name="schoolName"
                                placeholder="Contoh: SD NEGERI 01 CONTOH">
                        </div>
                        <div class="form-group full-width">
                            <label>Alamat Lengkap</label>
                            <input type="text" id="schoolAddress" name="schoolAddress"
                                placeholder="Jl. Pendidikan No. 123">
                        </div>
                        <div class="form-group">
                            <label>NPSN</label>
                            <input type="text" id="npsn" name="npsn" placeholder="12345678">
                        </div>
                        <div class="form-group">
                            <label>Kecamatan</label>
                            <input type="text" id="kecamatan" name="kecamatan" placeholder="Contoh: Kec. Ilmu">
                        </div>
                        <div class="form-group">
                            <label>Nama Kepala Sekolah</label>
                            <input type="text" id="principalName" name="principalName"
                                placeholder="Nama Lengkap & Gelar">
                        </div>
                        <div class="form-group">
                            <label>NIP Kepala Sekolah</label>
                            <input type="text" id="principalNip" name="principalNip"
                                placeholder="19XXXXXXXX XXXXXX X XXX">
                        </div>
                        <div class="form-group">
                            <label>Nama Bendahara</label>
                            <input type="text" id="treasurerName" name="treasurerName"
                                placeholder="Nama Lengkap & Gelar">
                        </div>
                        <div class="form-group">
                            <label>NIP Bendahara</label>
                            <input type="text" id="treasurerNip" name="treasurerNip"
                                placeholder="19XXXXXXXX XXXXXX X XXX">
                        </div>

                        <button type="button" class="btn-primary btn-submit" onclick="saveData()">
                            <i data-lucide="save" size="18"></i>
                            Simpan Perubahan
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Preview Modal -->
        <div id="previewModal" class="modal-overlay">
            <div class="modal-container">
                <div class="preview-sidebar">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h3 style="font-size: 18px; font-weight: 700;">Customizer</h3>
                        <button onclick="closePreview()"
                            style="background:none; border:none; cursor:pointer; color: var(--text-muted);">
                            <i data-lucide="x" size="20"></i>
                        </button>
                    </div>

                    <div class="form-group">
                        <label>Gunakan Template Drive</label>
                        <select id="driveTemplateSelect" onchange="handleTemplateChange()"
                            style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                            <option value="">-- Gunakan Layout Bawaan --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Jenis Dokumen</label>
                        <select id="docType" onchange="handleDocTypeChange()"
                            style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                            <option value="kwitansi">Kwitansi SPJ</option>
                            <option value="nota">Nota Toko / Invoice</option>
                            <option value="pesanan">Surat Pesanan (Formal)</option>
                            <option value="berita_acara">Berita Acara Serah Terima</option>
                            <option value="undangan">Surat Undangan</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Nomor Surat</label>
                        <input type="text" id="custNomorSurat" oninput="updatePreview()"
                            placeholder="Contoh: 001/SD/2025">
                    </div>

                    <div class="form-group">
                        <label>Template Vendor</label>
                        <select id="vendorStyle" onchange="updatePreview()"
                            style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                            <option value="standard">Standard Style</option>
                            <option value="rm-family">RM Family (Landscape)</option>
                            <option value="toko-prima">Toko Prima (Modern)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Nama Vendor / Toko</label>
                        <input type="text" id="custVendorName" oninput="updatePreview()" placeholder="NAMA TOKO">
                    </div>

                    <div class="form-group">
                        <label>Uraian Belanja</label>
                        <textarea id="custUraian" oninput="updatePreview()" rows="3"
                            style="width:100%; padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Nominal (Rp)</label>
                        <input type="number" id="custJumlah" oninput="updatePreview()">
                    </div>

                    <div class="form-group">
                        <label>Tanggal Transaksi</label>
                        <input type="text" id="custTanggal" oninput="updatePreview()" placeholder="dd/mm/yyyy">
                    </div>

                    <div class="form-group">
                        <label>Tanggal Surat / Pesan</label>
                        <input type="text" id="custTanggalPesan" oninput="updatePreview()" placeholder="dd/mm/yyyy">
                    </div>

                    <div class="form-group">
                        <label>Tanggal Kegiatan</label>
                        <input type="text" id="custTanggalKegiatan" oninput="updatePreview()" placeholder="dd/mm/yyyy">
                    </div>

                    <div class="form-group">
                        <label>Alamat Vendor</label>
                        <input type="text" id="custVendorAddress" oninput="updatePreview()" placeholder="Alamat Toko">
                    </div>

                    <div class="form-group">
                        <label>Logo Toko (Upload)</label>
                        <input type="file" accept="image/*" onchange="handleLogoUpload(this)" style="font-size: 11px;">
                    </div>

                    <div class="form-group">
                        <label>Stempel Toko</label>
                        <input type="file" accept="image/*" onchange="handleStampUpload(this)" style="font-size: 11px;">
                    </div>

                    <div style="margin-top: auto;">
                        <label>Layout</label>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="changeLayout('portrait')" style="flex:1; padding:8px; font-size:12px;"
                                class="btn-primary">Portrait</button>
                            <button onclick="changeLayout('landscape')" style="flex:1; padding:8px; font-size:12px;"
                                class="btn-primary">Landscape</button>
                        </div>
                    </div>
                </div>

                <div class="preview-main">
                    <div class="preview-toolbar">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="range" min="30" max="150" value="80" oninput="zoomPreview(this.value)">
                            <span id="zoomLevel" style="font-size: 13px; font-weight: 500;">Scale: 80%</span>
                        </div>
                        <button class="btn-primary" onclick="window.print()">
                            <i data-lucide="printer" size="18"></i>
                            Cetak Dokumen
                        </button>
                    </div>

                    <div class="paper-viewport">
                        <div id="paper" class="paper a4">
                            <div id="paperContent">
                                <!-- Konten Dokumen Dinamis -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Manual Transaction Modal -->
        <div id="addModal" class="modal-overlay">
            <div class="modal-container" style="max-width: 500px; height: auto; flex-direction: column; padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 20px; font-weight: 700;">Tambah Transaksi Manual</h3>
                    <button onclick="closeAddModal()" style="background:none; border:none; cursor:pointer;">
                        <i data-lucide="x" size="20"></i>
                    </button>
                </div>

                <div class="form-group">
                    <label>Tanggal</label>
                    <input type="date" id="addDate">
                </div>
                <div class="form-group">
                    <label>No Bukti</label>
                    <input type="text" id="addNoBukti" placeholder="Contoh: BKU-001">
                </div>
                <div class="form-group">
                    <label>Uraian Belanja</label>
                    <input type="text" id="addUraian" placeholder="Contoh: Belanja ATK Kegiatan...">
                </div>
                <div class="form-group">
                    <label>Penerima / Toko</label>
                    <input type="text" id="addPenerima" placeholder="Contoh: Toko Abadi">
                </div>
                <div class="form-group">
                    <label>Jumlah (Rp)</label>
                    <input type="number" id="addJumlah" placeholder="0">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-primary" style="background: #64748b; flex: 1;" onclick="closeAddModal()">
                        Batal
                    </button>
                    <button class="btn-primary" style="flex: 1;" onclick="saveManualTransaction()">
                        <i data-lucide="save" size="18"></i>
                        Simpan
                    </button>
                </div>
            </div>
        </div>

        <!-- Drive Picker Modal -->
        <div id="driveModal" class="modal-overlay">
            <div class="modal-container"
                style="max-width: 600px; height: 500px; flex-direction: column; padding: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 20px; font-weight: 700;">File BKU di Google Drive</h3>
                    <button onclick="closeDrivePicker()" style="background:none; border:none; cursor:pointer;">
                        <i data-lucide="x" size="20"></i>
                    </button>
                </div>
                <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 20px;">Menampilkan file PDF terbaru
                    yang mengandung kata "BKU" di Drive Anda.</p>

                <div id="driveFileList"
                    style="flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i data-lucide="loader-2" class="spin" size="32" style="margin-bottom: 10px;"></i>
                        <p>Mencari file...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        // Load Initial Data
        window.addEventListener('load', () => {
            google.script.run
                .withSuccessHandler((data) => {
                    if (data) {
                        document.getElementById('schoolName').value = data.schoolName || '';
                        document.getElementById('schoolAddress').value = data.schoolAddress || '';
                        document.getElementById('npsn').value = data.npsn || '';
                        document.getElementById('kecamatan').value = data.kecamatan || '';
                        document.getElementById('principalName').value = data.principalName || '';
                        document.getElementById('principalNip').value = data.principalNip || '';
                        document.getElementById('treasurerName').value = data.treasurerName || '';
                        document.getElementById('treasurerNip').value = data.treasurerNip || '';
                    }
                })
                .getSchoolData();

            // Load Templates from Drive Folder "TEMPLATE"
            google.script.run.withSuccessHandler(populateTemplates).getTemplatesFromFolder();
        });

        // View Navigation Logic
        function showView(viewId, element) {
            // Remove active class from all sections
            const sections = document.querySelectorAll('.view-section');
            sections.forEach(sec => sec.classList.remove('active'));

            // Show target section
            document.getElementById(viewId).classList.add('active');

            // Update sidebar UI
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            element.classList.add('active');

            // Refresh icons in case any were hidden
            lucide.createIcons();
        }

        // --- Document Generation Logic ---
        let currentScale = 0.8;
        let currentLayout = 'portrait';
        let logoBase64 = null;
        let stampBase64 = null;
        let availableTemplates = [];
        let cachedTemplateHtml = "";
        let currentTemplateId = "";

        // Fungsi Terbilang untuk Rupiah
        function terbilang(nilai) {
            nilai = Math.abs(nilai);
            var simpanNilaiBagi = 0;
            var huruf = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan", "Sepuluh", "Sebelas"];
            var temp = "";

            if (nilai < 12) {
                temp = " " + huruf[nilai];
            } else if (nilai < 20) {
                temp = terbilang(nilai - 10) + " Belas";
            } else if (nilai < 100) {
                simpanNilaiBagi = Math.floor(nilai / 10);
                temp = terbilang(simpanNilaiBagi) + " Puluh" + terbilang(nilai % 10);
            } else if (nilai < 200) {
                temp = " Seratus" + terbilang(nilai - 100);
            } else if (nilai < 1000) {
                simpanNilaiBagi = Math.floor(nilai / 100);
                temp = terbilang(simpanNilaiBagi) + " Ratus" + terbilang(nilai % 100);
            } else if (nilai < 2000) {
                temp = " Seribu" + terbilang(nilai - 1000);
            } else if (nilai < 1000000) {
                simpanNilaiBagi = Math.floor(nilai / 1000);
                temp = terbilang(simpanNilaiBagi) + " Ribu" + terbilang(nilai % 1000);
            } else if (nilai < 1000000000) {
                simpanNilaiBagi = Math.floor(nilai / 1000000);
                temp = terbilang(simpanNilaiBagi) + " Juta" + terbilang(nilai % 1000000);
            }
            return temp;
        }

        // Helper untuk format tanggal teks (Contoh: Senin, 20 Mei 2025)
        function getDateText(dateStr) {
            // Asumsi format dd/mm/yyyy
            const parts = dateStr.split('/');
            if (parts.length !== 3) return { dayName: '...', fullDate: dateStr };

            const d = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

            const dayName = days[d.getDay()];
            return { dayName: dayName, fullDate: `${parts[0]} ${months[parseInt(parts[1]) - 1]} ${parts[2]}` };
        }

        function openPreview() {
            document.getElementById('previewModal').style.display = 'flex';
            updatePreview();
            lucide.createIcons();
        }

        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }

        function zoomPreview(val) {
            currentScale = val / 100;
            document.getElementById('paper').style.transform = `scale(${currentScale})`;
            document.getElementById('zoomLevel').innerText = `Scale: ${val}%`;
        }

        function changeLayout(layout) {
            currentLayout = layout;
            const paper = document.getElementById('paper');
            if (layout === 'landscape') {
                paper.className = 'paper a5-landscape';
            } else {
                paper.className = 'paper a4';
            }
            updatePreview();
        }

        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    logoBase64 = e.target.result;
                    updatePreview();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleStampUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    stampBase64 = e.target.result;
                    updatePreview();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function populateTemplates(response) {
            if (response.success && response.templates.length > 0) {
                availableTemplates = response.templates;
                const select = document.getElementById('driveTemplateSelect');
                availableTemplates.forEach(tpl => {
                    const opt = document.createElement('option');
                    opt.value = tpl.id;
                    opt.text = tpl.name;
                    select.appendChild(opt);
                });
            }
        }

        function handleDocTypeChange() {
            const docType = document.getElementById('docType').value;
            const select = document.getElementById('driveTemplateSelect');

            // Reset selection first
            select.value = "";
            cachedTemplateHtml = "";
            currentTemplateId = "";

            // Auto-select template based on keyword match
            let keyword = "";
            if (docType === 'pesanan') keyword = "pesanan";
            else if (docType === 'undangan') keyword = "undangan";
            else if (docType === 'berita_acara') keyword = "berita acara";

            if (keyword && availableTemplates.length > 0) {
                const match = availableTemplates.find(t => t.name.toLowerCase().includes(keyword));
                if (match) {
                    select.value = match.id;
                    handleTemplateChange(); // Trigger load
                    return;
                }
            }

            updatePreview();
        }

        function handleTemplateChange() {
            const templateId = document.getElementById('driveTemplateSelect').value;
            if (!templateId) {
                cachedTemplateHtml = "";
                currentTemplateId = "";
                updatePreview();
                return;
            }

            if (templateId === currentTemplateId && cachedTemplateHtml) {
                renderTemplate(cachedTemplateHtml);
            } else {
                loadDocFromDrive(templateId);
            }
        }

        function loadDocFromDrive(docId) {
            currentTemplateId = docId;
            document.getElementById('paperContent').innerHTML = '<div style="text-align:center; padding:50px; color: var(--text-muted);"><i data-lucide="loader-2" class="spin"></i><br>Mengambil Template dari Drive...</div>';
            lucide.createIcons();

            google.script.run.withSuccessHandler(res => {
                if (res.success) {
                    cachedTemplateHtml = res.html;
                    renderTemplate(res.html);
                } else {
                    alert("Gagal memuat Doc: " + res.error);
                    document.getElementById('driveTemplateSelect').value = "";
                    updatePreview();
                }
            }).getGoogleDocContent(docId);
        }

        function updatePreview() {
            // If a Drive template is selected, use it instead of hardcoded HTML
            const templateId = document.getElementById('driveTemplateSelect').value;
            if (templateId && cachedTemplateHtml) {
                renderTemplate(cachedTemplateHtml);
                return;
            }

            const docType = document.getElementById('docType').value;
            const vendorStyle = document.getElementById('vendorStyle').value;
            const vendorName = document.getElementById('custVendorName').value || "TOKO SUMBER JAYA";
            const vendorAddress = document.getElementById('custVendorAddress').value || "Jl. Raya KM 10, Kota Pendidikan";
            const uraian = document.getElementById('custUraian').value || "Belanja Barang Jasa";
            const jumlah = parseFloat(document.getElementById('custJumlah').value) || 0;
            const tanggal = document.getElementById('custTanggal').value || "01/01/2025";
            const nomorSurat = document.getElementById('custNomorSurat').value || "020/SD-BOS/2025";
            const tanggalPesan = document.getElementById('custTanggalPesan').value || tanggal;
            const tanggalKegiatan = document.getElementById('custTanggalKegiatan').value || tanggal;

            const terbilangText = terbilang(jumlah) + " Rupiah";
            const dateInfo = getDateText(tanggal);
            const datePesanInfo = getDateText(tanggalPesan);
            const dateKegiatanInfo = getDateText(tanggalKegiatan);

            // Versi Uraian Bersih (Hanya Nama Kegiatan) untuk Surat Pesanan & Undangan
            const cleanUraian = uraian.replace(/^(Belanja )?Konsumsi \(Makan & Snack\) /i, "");

            const schoolData = {
                name: document.getElementById('schoolName').value || "SD NEGERI 01 CONTOH",
                address: document.getElementById('schoolAddress').value || "Jl. Pendidikan No. 123",
                kecamatan: document.getElementById('kecamatan').value || "Cikalongwetan",
                npsn: document.getElementById('npsn').value || "12345678",
                principal: document.getElementById('principalName').value || "JAJANG SETIA P, S.Pd.SD.",
                principalNip: document.getElementById('principalNip').value || "197206271999031002",
                treasurer: document.getElementById('treasurerName').value || "NAMA BENDAHARA",
                treasurerNip: document.getElementById('treasurerNip').value || "19XXXXXXXX XXXXXX X XXX"
            };

            let html = '';

            // --- TEMPLATE KOP SURAT SEKOLAH ---
            const schoolKop = `
                <div style="text-align: center; border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 20px; font-family: 'Times New Roman', serif;">
                    <h3 style="margin:0; font-size: 16px; text-transform: uppercase;">PEMERINTAH KABUPATEN BANDUNG BARAT</h3>
                    <h3 style="margin:0; font-size: 16px; text-transform: uppercase;">DINAS PENDIDIKAN</h3>
                    <h2 style="margin:0; font-size: 18px; text-transform: uppercase; font-weight: bold;">${schoolData.name}</h2>
                    <h3 style="margin:0; font-size: 14px; text-transform: uppercase;">KECAMATAN ${schoolData.kecamatan}</h3>
                    <p style="margin:0; font-size: 11px; font-style: italic;">${schoolData.address} - Kabupaten Bandung Barat</p>
                </div>
            `;

            if (docType === 'nota') {
                if (vendorStyle === 'rm-family') {
                    // --- LAYOUT NOTA RM FAMILY (SESUAI GAMBAR) ---
                    html = `
                        <div style="font-family: Arial, sans-serif; color: #000; border: 1px solid #ccc; padding: 20px;">
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <h2 style="margin:0; font-size: 16px;">RUMAH MAKAN</h2>
                                    <h1 style="margin:0; font-size: 32px; font-family: 'Arial Black', sans-serif; letter-spacing: 2px;">" ${vendorName} "</h1>
                                    <p style="margin:5px 0 0 0; font-size: 12px; line-height: 1.2;">${vendorAddress}<br>HP. 087XXXXXXXXX</p>
                                </div>
                                <div style="width: 250px;">
                                    <table style="width: 100%; font-size: 12px;">
                                        <tr><td>Bapak/Ibu</td><td style="border-bottom: 1px dotted #000; width: 100%;">: ${schoolData.name}</td></tr>
                                        <tr><td>Tgl</td><td style="border-bottom: 1px dotted #000;">: ${tanggal}</td></tr>
                                    </table>
                                </div>
                            </div>

                            <div style="background: #000; color: #fff; text-align: center; padding: 5px; margin: 20px 0; font-weight: bold;">MENERIMA PESANAN</div>

                            <table style="width: 100%; border-collapse: collapse; border: 2px solid #000;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #000;">
                                        <th style="border-right: 2px solid #000; padding: 8px;">MAKANAN / MINUMAN</th>
                                        <th style="border-right: 2px solid #000; padding: 8px; width: 60px;">JML</th>
                                        <th style="border-right: 2px solid #000; padding: 8px; width: 100px;">H. SATUAN</th>
                                        <th style="padding: 8px; width: 120px;">SUB TOTAL</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Array(12).fill().map((_, i) => `
                                        <tr style="height: 25px; border-bottom: 1px solid #000;">
                                            <td style="border-right: 2px solid #000; padding: 0 8px;">${i === 0 ? uraian : ''}</td>
                                            <td style="border-right: 2px solid #000; text-align: center;">${i === 0 ? '1' : ''}</td>
                                            <td style="border-right: 2px solid #000; text-align: right; padding-right: 8px;">${i === 0 ? jumlah.toLocaleString('id-ID') : ''}</td>
                                            <td style="text-align: right; padding-right: 8px;">${i === 0 ? jumlah.toLocaleString('id-ID') : ''}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr style="border-top: 2px solid #000;">
                                        <td colspan="3" style="border-right: 2px solid #000; text-align: right; padding: 8px; font-weight: bold;">Total Rp.</td>
                                        <td style="text-align: right; padding: 8px; font-weight: bold;">${jumlah.toLocaleString('id-ID')}</td>
                                    </tr>
                                </tfoot>
                            </table>

                            <div style="display: flex; justify-content: space-between; margin-top: 20px; font-size: 13px;">
                                <div style="text-align: center; width: 150px;">
                                    <p>Tanda Terima,</p><br><br><br>
                                    <p>( ........................... )</p>
                                </div>
                                <div style="text-align: center; width: 150px;">
                                    <p>Hormat Kami,</p><br><br><br>
                                    <p style="font-weight: bold;">${vendorName}</p>
                                </div>
                            </div>
                            <p style="text-align: center; font-style: italic; margin-top: 30px; font-family: serif; font-size: 18px;">Terima Kasih Atas Kunjungan Anda</p>
                        </div>
                    `;
                } else if (vendorStyle === 'toko-prima') {
                    // --- LAYOUT TOKO PRIMA (MODERN GRID) ---
                    html = `
                        <div style="font-family: 'Outfit', sans-serif; padding: 20px; border: 1px solid #eee;">
                            <div style="display: flex; gap: 20px; align-items: flex-start; margin-bottom: 20px;">
                                ${logoBase64 ? `<img src="${logoBase64}" style="height: 70px;">` : `<div style="padding: 10px; background: #000; color: #fff; font-weight: bold; border-radius: 8px; font-size: 24px;">PRIMA</div>`}
                                <div style="font-size: 11px; line-height: 1.3;">
                                    <p style="margin:0;">Alat-alat Listrik - Elektronik - Sepeda - ATK - Photo Copy</p>
                                    <p style="margin:0;">Penjilidan - Laminating - Cetak Photo - Scan - dll</p>
                                    <p style="margin:0; font-weight: bold; margin-top: 4px;">MENERIMA PESANAN :</p>
                                    <p style="margin:0;">Perlengkapan Sekolah - Kartu Undangan - Kartu Nama - Kop Surat - Stempel - Banner dsb.</p>
                                </div>
                                <div style="flex-grow: 1; border: 2px solid #000; border-radius: 12px; padding: 10px; font-size: 12px; max-width: 200px;">
                                    <p style="margin:0;">Kepada Yth,</p>
                                    <p style="margin:5px 0; font-weight: bold;">${schoolData.name}</p>
                                    <hr style="border:0; border-top: 1px dotted #000;">
                                </div>
                            </div>
                            <h2 style="font-size: 14px; margin-bottom: 10px;">Nota No : ..............................</h2>
                            <table style="width: 100%; border-collapse: separate; border-spacing: 4px;">
                                <tr>
                                    <th style="background: #e2e8f0; border-radius: 8px; padding: 10px; width: 80px;">BANYAKNYA</th>
                                    <th style="background: #e2e8f0; border-radius: 8px; padding: 10px;">NAMA BARANG / JASA</th>
                                    <th style="background: #e2e8f0; border-radius: 8px; padding: 10px; width: 100px;">HARGA</th>
                                    <th style="background: #e2e8f0; border-radius: 8px; padding: 10px; width: 120px;">JUMLAH</th>
                                </tr>
                                ${Array(8).fill().map((_, i) => `
                                    <tr>
                                        <td style="border: 1px solid #cbd5e1; border-radius: 8px; height: 35px; text-align: center;">${i === 0 ? '1' : ''}</td>
                                        <td style="border: 1px solid #cbd5e1; border-radius: 8px; padding-left: 10px;">${i === 0 ? uraian : ''}</td>
                                        <td style="border: 1px solid #cbd5e1; border-radius: 8px; text-align: right; padding-right: 10px;">${i === 0 ? jumlah.toLocaleString('id-ID') : ''}</td>
                                        <td style="border: 1px solid #cbd5e1; border-radius: 8px; text-align: right; padding-right: 10px;">${i === 0 ? jumlah.toLocaleString('id-ID') : ''}</td>
                                    </tr>
                                `).join('')}
                            </table>
                            <div style="display: flex; justify-content: flex-end; margin-top: 10px; gap: 20px;">
                                <div style="text-align: center; width: 150px; margin-top: 40px;">
                                    <p>Tanda Terima</p><br><br><br>
                                    <hr style="border: 0; border-top: 1px solid #000; width: 100%;">
                                </div>
                                <div style="text-align: center; width: 150px; margin-top: 40px;">
                                    <p>Hormat Kami</p><br><br><br>
                                    <hr style="border: 0; border-top: 1px solid #000; width: 100%;">
                                </div>
                                <div style="width: 200px;">
                                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 8px; margin-bottom: 4px;">
                                        <span>Total Rp</span><span>${jumlah.toLocaleString('id-ID')}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 8px; background: #f8fafc; border-radius: 8px;">
                                        <span>Sisa Rp</span><span>0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else if (docType === 'pesanan') {
                // --- TEMPLATE SURAT PESANAN (FORMAL) ---
                html = `
                    <div style="font-family: 'Times New Roman', Times, serif; color: #000; padding: 10px 40px;">
                        ${schoolKop}
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                            <p>${schoolData.kecamatan}, ${datePesanInfo.fullDate}</p>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 20px 1fr; gap: 5px; margin-bottom: 30px;">
                            <div>Nomor</div><div>:</div><div>${nomorSurat}</div>
                            <div>Sifat</div><div>:</div><div>Biasa</div>
                            <div>Lampiran</div><div>:</div><div>-</div>
                            <div>Perihal</div><div>:</div><div style="font-weight: bold; text-decoration: underline;">Surat Pesanan</div>
                            
                            <div style="grid-column: 3; margin-top: 10px;">
                                <strong>Kepada Yth,</strong><br>
                                <strong>${vendorName}</strong><br>
                                di Tempat
                            </div>
                        </div>

                        <p>Assalamualaikum Wr, Wb.</p>
                        <p style="text-indent: 40px; text-align: justify; line-height: 1.5;">
                            Dengan Hormat, Bersamaan ini kami sampaikan bahwa sehubungan dengan akan dilaksanakannya kegiatan pada tanggal <b>${dateKegiatanInfo.fullDate}</b>, Kami bermaksud ingin memesan kebutuhan dengan rincian sebagai berikut:
                        </p>

                        <div style="margin: 20px auto; width: 90%;">
                            <table style="width: 100%; border-collapse: collapse; border: 1px solid #000;">
                                <tr style="background: #f0f0f0;">
                                    <th style="border: 1px solid #000; padding: 8px;">No</th>
                                    <th style="border: 1px solid #000; padding: 8px;">Uraian Barang/Kebutuhan</th>
                                    <th style="border: 1px solid #000; padding: 8px;">Jumlah</th>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">1</td>
                                    <td style="border: 1px solid #000; padding: 8px;">${cleanUraian}</td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">1 Paket</td>
                                </tr>
                            </table>
                        </div>

                        <p style="text-indent: 40px; margin-bottom: 40px;">Demikian surat pesanan ini kami sampaikan, Atas perhatiannya dan kerjasamanya kami ucapkan terimakasih.</p>

                        <div style="display: flex; justify-content: flex-end;">
                            <div style="text-align: center;">
                                <p>Mengetahui,</p>
                                <p style="font-weight: bold; margin-bottom: 80px;">Kepala Sekolah</p>
                                <p style="font-weight: bold; text-decoration: underline; margin:0;">${schoolData.principal}</p>
                                <p style="margin:0;">NIP. ${schoolData.principalNip}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (docType === 'berita_acara') {
                // --- TEMPLATE BERITA ACARA SERAH TERIMA ---
                html = `
                    <div style="font-family: 'Times New Roman', Times, serif; color: #000; padding: 10px 40px;">
                        ${schoolKop}
                        
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h3 style="text-decoration: underline; margin: 0; font-size: 16px;">BERITA ACARA SERAH TERIMA BARANG/JASA</h3>
                            <p style="margin: 5px 0 0 0;">Nomor: 021/BA-ST/BOS/2025</p>
                        </div>

                        <p style="text-align: justify; line-height: 1.6;">
                            Pada hari ini <strong>${dateInfo.dayName}</strong> tanggal <strong>${dateInfo.fullDate}</strong>, kami yang bertanda tangan di bawah ini:
                        </p>

                        <table style="width: 100%; margin-bottom: 20px;">
                            <tr>
                                <td style="width: 30px; vertical-align: top;">1.</td>
                                <td style="width: 100px; vertical-align: top;">Nama</td>
                                <td style="vertical-align: top;">: <strong>${vendorName}</strong></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td style="vertical-align: top;">Alamat</td>
                                <td style="vertical-align: top;">: ${vendorAddress}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td colspan="2" style="padding-top: 5px;">Selanjutnya disebut <strong>PIHAK PERTAMA</strong></td>
                            </tr>
                            <tr><td colspan="3" style="height: 15px;"></td></tr>
                            <tr>
                                <td style="width: 30px; vertical-align: top;">2.</td>
                                <td style="width: 100px; vertical-align: top;">Nama</td>
                                <td style="vertical-align: top;">: <strong>${schoolData.principal}</strong></td>
                            </tr>
                            <tr>
                                <td></td>
                                <td style="vertical-align: top;">NIP</td>
                                <td style="vertical-align: top;">: ${schoolData.principalNip}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td style="vertical-align: top;">Jabatan</td>
                                <td style="vertical-align: top;">: Kepala Sekolah ${schoolData.name}</td>
                            </tr>
                            <tr>
                                <td></td>
                                <td colspan="2" style="padding-top: 5px;">Selanjutnya disebut <strong>PIHAK KEDUA</strong></td>
                            </tr>
                        </table>

                        <p style="text-align: justify; line-height: 1.6;">
                            PIHAK PERTAMA menyerahkan barang/jasa kepada PIHAK KEDUA, dan PIHAK KEDUA menerima barang/jasa dari PIHAK PERTAMA berupa:
                        </p>

                        <div style="border: 1px solid #000; padding: 15px; margin: 10px 0;">
                            <table style="width: 100%;">
                                <tr>
                                    <td style="width: 120px; font-weight: bold;">Uraian Barang</td>
                                    <td>: ${uraian}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">Nilai Barang</td>
                                    <td>: Rp ${jumlah.toLocaleString('id-ID')}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">Terbilang</td>
                                    <td style="font-style: italic;">: ${terbilangText}</td>
                                </tr>
                            </table>
                        </div>

                        <p style="text-align: justify; line-height: 1.6; margin-bottom: 40px;">
                            Demikian Berita Acara Serah Terima ini dibuat dengan sebenarnya untuk dapat dipergunakan sebagaimana mestinya.
                        </p>

                        <div style="display: flex; justify-content: space-between; text-align: center;">
                            <div style="width: 200px;">
                                <p>PIHAK PERTAMA</p>
                                <br><br><br><br>
                                <p style="font-weight: bold; text-decoration: underline;">${vendorName}</p>
                            </div>
                            <div style="width: 200px;">
                                <p>PIHAK KEDUA</p>
                                <br><br><br><br>
                                <p style="font-weight: bold; text-decoration: underline;">${schoolData.principal}</p>
                                <p>NIP. ${schoolData.principalNip}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (docType === 'kwitansi') {
                // --- TEMPLATE KWITANSI BENDAHARA (SESUAI GAMBAR) ---
                html = `
                    <div style="border: 4px double #000; padding: 25px; font-family: Arial, sans-serif; color: #000; background: #fff;">
                        <h1 style="text-align: center; text-decoration: underline; margin-bottom: 20px; font-size: 24px; letter-spacing: 5px;">KUITANSI</h1>
                        
                        <div style="display: grid; grid-template-columns: 180px 20px 1fr; gap: 10px; line-height: 2;">
                            <div style="font-weight: bold;">Nomor</div><div>:</div><div style="border-bottom: 1px dashed #000;">KW/020/BOS/2025</div>
                            
                            <div>Sudah terima dari</div><div>:</div><div style="border-bottom: 1px dashed #000; font-weight: bold;">BENDAHARA BOS ${schoolData.name}</div>
                            
                            <div>Banyaknya uang</div><div>:</div><div style="background: #e2e8f0; padding: 0 10px; font-style: italic; font-weight: bold;">### ${terbilangText} ###</div>
                            
                            <div>Untuk pembayaran</div><div>:</div><div style="border-bottom: 1px dashed #000;">${uraian}</div>
                        </div>

                        <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                            <div style="text-align: center;">
                                <p style="margin-bottom: 5px;">Menyetujui</p>
                                <p style="font-weight: bold; margin-bottom: 60px;">Kepala Sekolah,</p>
                                <p style="font-weight: bold; text-decoration: underline; margin:0;">${schoolData.principal}</p>
                                <p style="margin:0;">NIP. ${schoolData.principalNip}</p>
                            </div>
                            <div style="text-align: center;">
                                <p style="margin-bottom: 5px;">&nbsp;</p>
                                <p style="font-weight: bold; margin-bottom: 60px;">Bendahara,</p>
                                <p style="font-weight: bold; text-decoration: underline; margin:0;">${schoolData.treasurer}</p>
                                <p style="margin:0;">NIP. ${schoolData.treasurerNip}</p>
                            </div>
                            <div style="text-align: center; border: 1px solid #000; padding: 20px; height: fit-content; align-self: center;">
                                <p style="margin:0; font-size: 14px;">Terbilang Rp.</p>
                                <p style="margin:0; font-size: 20px; font-weight: bold;">${jumlah.toLocaleString('id-ID')},-</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (docType === 'undangan') {
                // --- TEMPLATE UNDANGAN (SESUAI TEKS) ---
                html = `
                    <div style="font-family: 'Times New Roman', Times, serif; color: #000; padding: 10px 40px;">
                        ${schoolKop}
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                            <p>${schoolData.kecamatan}, 02 April 2025</p>
                        </div>
                        <div style="display: grid; grid-template-columns: 100px 20px 1fr; gap: 5px; margin-bottom: 30px;">
                            <div>Nomor</div><div>:</div><div>018/KKKS-GZM/IV/2025</div>
                            <div>Sifat</div><div>:</div><div>Biasa</div>
                            <div>Lampiran</div><div>:</div><div>-</div>
                            <div>Perihal</div><div>:</div><div style="font-weight: bold; text-decoration: underline;">Undangan Lomba FLS2N</div>
                            
                            <div style="grid-column: 3; margin-top: 10px;">
                                <strong>Kepada Yth,</strong><br>
                                <strong>Bapak/Ibu Kepala Sekolah Dasar Se-Gugus</strong><br>
                                di Tempat
                            </div>
                        </div>

                        <p>Assalamualaikum Wr, Wb.</p>
                        <p style="text-indent: 40px; text-align: justify; line-height: 1.5;">
                            Dengan Hormat, Bersamaan ini kami sampaikan bahwa pelaksanaan Lomba Bakat Minat Kreativitas Siswa (LBMKS) cabang lomba FLS2N tingkat Gugus KH. Zaenal Musthofa tahun 2025 akan dilaksanakan pada:
                        </p>

                        <div style="margin: 20px 40px; line-height: 2;">
                            <div style="display: grid; grid-template-columns: 100px 20px 1fr;">
                                <div>Hari</div><div>:</div><div>Rabu sd Kamis</div>
                                <div>Tanggal</div><div>:</div><div>16 sd 17 April 2025</div>
                                <div>Tempat</div><div>:</div><div>SD Negeri 1 Rajamandalawetan</div>
                                <div>Waktu</div><div>:</div><div>08.00 sd Selesai</div>
                            </div>
                        </div>

                        <p style="text-indent: 40px; margin-bottom: 40px;">Demikian kami sampaikan, Atas perhatiannya dan kehadirannya kami ucapkan terimakasih.</p>

                        <div style="display: flex; justify-content: flex-end;">
                            <div style="text-align: center;">
                                <p style="font-weight: bold; margin-bottom: 80px;">Ketua Gugus,</p>
                                <p style="font-weight: bold; text-decoration: underline; margin:0;">${schoolData.principal}</p>
                                <p style="margin:0;">NIP. ${schoolData.principalNip}</p>
                            </div>
                        </div>

                        <div style="margin-top: 40px; font-size: 11px;">
                            <p style="text-decoration: underline; margin:0;">Tembusan:</p>
                            <ol style="margin:0; padding-left: 20px;">
                                <li>Pengawas Bina Kecamatan ${schoolData.kecamatan}</li>
                                <li>K3S Kecamatan ${schoolData.kecamatan}</li>
                            </ol>
                        </div>
                    </div>
                `;
            }

            document.getElementById('paperContent').innerHTML = html;
        }

        function renderTemplate(htmlContent) {
            // Get Current Data
            const vendorName = document.getElementById('custVendorName').value || "-";
            const vendorAddress = document.getElementById('custVendorAddress').value || "-";
            const uraian = document.getElementById('custUraian').value || "-";
            const jumlah = parseFloat(document.getElementById('custJumlah').value) || 0;
            const docType = document.getElementById('docType').value;
            const tanggal = document.getElementById('custTanggal').value || "-";
            const nomorSurat = document.getElementById('custNomorSurat').value || "-";
            const tanggalPesan = document.getElementById('custTanggalPesan').value || tanggal;
            const tanggalKegiatan = document.getElementById('custTanggalKegiatan').value || tanggal;
            const terbilangText = terbilang(jumlah) + " Rupiah";

            const schoolData = {
                name: document.getElementById('schoolName').value || "",
                kecamatan: document.getElementById('kecamatan').value || "",
                principal: document.getElementById('principalName').value || "",
                principalNip: document.getElementById('principalNip').value || "",
                treasurer: document.getElementById('treasurerName').value || "",
                treasurerNip: document.getElementById('treasurerNip').value || ""
            };

            // Logika Uraian: Jika Surat Pesanan/Undangan, buang awalan "Konsumsi..."
            let uraianForTemplate = uraian;
            if (docType === 'pesanan' || docType === 'undangan') {
                uraianForTemplate = uraian.replace(/^(Belanja )?Konsumsi \(Makan & Snack\) /i, "");
            }

            // Replace Placeholders
            let filledHtml = htmlContent;
            filledHtml = filledHtml.replace(/{{NO_BUKTI}}/g, "AUTO"); // Bisa diambil dari tx.noBukti jika ada
            filledHtml = filledHtml.replace(/{{TANGGAL}}/g, tanggal);
            filledHtml = filledHtml.replace(/{{TANGGAL_PESAN}}/g, tanggalPesan);
            filledHtml = filledHtml.replace(/{{TANGGAL_KEGIATAN}}/g, tanggalKegiatan);
            filledHtml = filledHtml.replace(/{{NOMOR_SURAT}}/g, nomorSurat);
            filledHtml = filledHtml.replace(/{{URAIAN}}/g, uraianForTemplate);
            filledHtml = filledHtml.replace(/{{JUMLAH}}/g, "Rp " + jumlah.toLocaleString('id-ID'));
            filledHtml = filledHtml.replace(/{{TERBILANG}}/g, terbilangText);
            filledHtml = filledHtml.replace(/{{PENERIMA}}/g, vendorName);
            filledHtml = filledHtml.replace(/{{ALAMAT_TOKO}}/g, vendorAddress);
            filledHtml = filledHtml.replace(/{{NAMA_SEKOLAH}}/g, schoolData.name);
            filledHtml = filledHtml.replace(/{{KEPALA_SEKOLAH}}/g, schoolData.principal);
            filledHtml = filledHtml.replace(/{{NIP_KEPALA}}/g, schoolData.principalNip);
            filledHtml = filledHtml.replace(/{{KECAMATAN}}/g, schoolData.kecamatan);
            filledHtml = filledHtml.replace(/{{BENDAHARA}}/g, schoolData.treasurer);
            filledHtml = filledHtml.replace(/{{NIP_BENDAHARA}}/g, schoolData.treasurerNip);

            document.getElementById('paperContent').innerHTML = filledHtml;
        }

        // Action: Save School Data
        function saveData() {
            const formData = {
                schoolName: document.getElementById('schoolName').value,
                schoolAddress: document.getElementById('schoolAddress').value,
                npsn: document.getElementById('npsn').value,
                kecamatan: document.getElementById('kecamatan').value,
                principalName: document.getElementById('principalName').value,
                principalNip: document.getElementById('principalNip').value,
                treasurerName: document.getElementById('treasurerName').value,
                treasurerNip: document.getElementById('treasurerNip').value
            };

            const btn = document.querySelector('.btn-submit');
            const originalContent = btn.innerHTML;

            // Visual feedback
            btn.innerHTML = '<i data-lucide="loader-2" class="spin" size="18"></i> Menyiapkan...';
            lucide.createIcons();
            btn.disabled = true;

            google.script.run
                .withSuccessHandler((response) => {
                    alert(response);
                    btn.innerHTML = '<i data-lucide="check" size="18"></i> Berhasil!';
                    lucide.createIcons();
                    setTimeout(() => {
                        btn.innerHTML = originalContent;
                        lucide.createIcons();
                        btn.disabled = false;
                    }, 2000);
                })
                .withFailureHandler((err) => {
                    alert("Error: " + err);
                    btn.innerHTML = originalContent;
                    lucide.createIcons();
                    btn.disabled = false;
                })
                .saveSchoolData(formData);
        }

        let allTransactions = [];

        function renderTransactions(data) {
            allTransactions = data;
            const tbody = document.getElementById('transactionTbody');
            const container = document.getElementById('transactionTableContainer');
            const emptyState = document.getElementById('emptyState');

            if (data.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            emptyState.style.display = 'none';

            tbody.innerHTML = data.map(tx => `
                <tr class="hover-row" style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 16px; font-size: 14px;">${tx.tanggal}</td>
                    <td style="padding: 16px; font-size: 14px;"><span style="background: #eff6ff; color: #2563eb; padding: 4px 8px; border-radius: 4px; font-weight: 600;">${tx.noBukti}</span></td>
                    <td style="padding: 16px; font-size: 14px; max-width: 300px;">${tx.uraian}</td>
                    <td style="padding: 16px; font-size: 14px; font-weight: 600;">Rp ${tx.pengeluaran.toLocaleString('id-ID')}</td>
                    <td style="padding: 16px; display: flex; gap: 8px;">
                        <button class="btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="generateSpj('${tx.id}')" title="Cetak">
                            <i data-lucide="printer" size="14"></i>
                        </button>
                        <button class="btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="removeTransaction('${tx.id}')" title="Hapus">
                            <i data-lucide="trash-2" size="14"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        // --- Manual Transaction Logic ---
        function openAddModal() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('addDate').value = today;
            document.getElementById('addNoBukti').value = '';
            document.getElementById('addUraian').value = '';
            document.getElementById('addPenerima').value = '';
            document.getElementById('addJumlah').value = '';

            document.getElementById('addModal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }

        function saveManualTransaction() {
            const dateVal = document.getElementById('addDate').value;
            const noBukti = document.getElementById('addNoBukti').value;
            const uraian = document.getElementById('addUraian').value;
            const penerima = document.getElementById('addPenerima').value;
            const jumlah = parseFloat(document.getElementById('addJumlah').value);

            if (!dateVal || !noBukti || !uraian || !jumlah) {
                alert("Mohon lengkapi Tanggal, No Bukti, Uraian, dan Jumlah.");
                return;
            }

            // Format date dd/mm/yyyy
            const d = new Date(dateVal);
            const formattedDate = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;

            // Determine type automatically based on keywords (simple logic)
            let type = 'nota';
            let vendorStyle = 'standard';
            const uLow = uraian.toLowerCase();
            if (uLow.includes('honor') || uLow.includes('transport')) type = 'kwitansi';
            if (uLow.includes('makan') || uLow.includes('snack')) vendorStyle = 'rm-family';

            const newTx = {
                id: 'MANUAL_' + Date.now(),
                tanggal: formattedDate,
                noBukti: noBukti,
                uraian: uraian,
                pengeluaran: jumlah,
                penerima: penerima || uraian,
                type: type,
                vendorStyle: vendorStyle
            };

            allTransactions.push(newTx);
            renderTransactions(allTransactions);
            closeAddModal();

            // Show feedback
            document.getElementById('extractionInfo').innerText = `Total ${allTransactions.length} transaksi (Termasuk manual)`;
        }

        function removeTransaction(id) {
            if (confirm("Apakah Anda yakin ingin menghapus transaksi ini?")) {
                allTransactions = allTransactions.filter(tx => tx.id !== id);
                renderTransactions(allTransactions);
                document.getElementById('extractionInfo').innerText = `Total ${allTransactions.length} transaksi`;
            }
        }

        function generateSpj(txId) {
            const tx = allTransactions.find(t => t.id === txId);
            if (!tx) return;

            // Pre-fill the customizer
            document.getElementById('custVendorName').value = tx.penerima;
            document.getElementById('custVendorAddress').value = "Alamat " + tx.penerima;
            document.getElementById('custUraian').value = tx.uraian;
            document.getElementById('custJumlah').value = tx.pengeluaran;
            document.getElementById('custTanggal').value = tx.tanggal;
            document.getElementById('custTanggalPesan').value = tx.tanggal;
            document.getElementById('custTanggalKegiatan').value = tx.tanggal;
            document.getElementById('custNomorSurat').value = "020/SD-BOS/" + new Date().getFullYear();
            // document.getElementById('driveTemplateSelect').value = ""; // Don't reset if user wants to keep using template

            const docTypeSelect = document.getElementById('docType');
            if (tx.type === 'konsumsi') {
                docTypeSelect.value = 'nota';
                document.getElementById('vendorStyle').value = tx.vendorStyle || 'standard';
            } else if (tx.type === 'jasa') {
                docTypeSelect.value = 'nota';
                document.getElementById('vendorStyle').value = 'toko-prima';
            } else {
                docTypeSelect.value = 'kwitansi';
            }

            handleDocTypeChange(); // This will trigger openPreview and auto-select template
            document.getElementById('previewModal').style.display = 'flex'; // Ensure modal opens
        }

        // --- Drive Picker Logic ---
        function openDrivePicker() {
            document.getElementById('driveModal').style.display = 'flex';
            document.getElementById('driveFileList').innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <i data-lucide="loader-2" class="spin" size="32" style="margin-bottom: 10px;"></i>
                    <p>Mencari file di Drive Anda...</p>
                </div>
            `;
            lucide.createIcons();

            google.script.run
                .withSuccessHandler((response) => {
                    const listDiv = document.getElementById('driveFileList');
                    if (response.success && response.files && response.files.length > 0) {
                        listDiv.innerHTML = response.files.map(file => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: 0.2s;" 
                                 onclick="processDriveFile('${file.id}', '${file.name}')"
                                 onmouseover="this.style.borderColor='#2563eb'; this.style.background='#eff6ff'"
                                 onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='#f8fafc'">
                                <div>
                                    <div style="font-weight: 600; font-size: 14px;">${file.name}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">${file.date}</div>
                                </div>
                                <i data-lucide="chevron-right" size="18" color="#2563eb"></i>
                            </div>
                        `).join('');
                    } else {
                        listDiv.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i data-lucide="search-x" size="48" style="margin-bottom: 10px; opacity: 0.3;"></i>
                                <p>Tidak ditemukan file PDF dengan nama "BKU" di Drive Anda.</p>
                                <button class="btn-primary" style="margin: 20px auto; font-size: 12px;" onclick="closeDrivePicker()">Tutup</button>
                            </div>
                        `;
                    }
                    lucide.createIcons();
                })
                .getBkuFilesFromDrive();
        }

        function closeDrivePicker() {
            document.getElementById('driveModal').style.display = 'none';
        }

        function processDriveFile(fileId, fileName) {
            closeDrivePicker();

            // Visual feedback on the main button card
            const driveCard = document.querySelector('.upload-card');
            const originalContent = driveCard.innerHTML;
            driveCard.innerHTML = `
                <div class="upload-icon-wrapper" style="background: #22c55e; color: white; width: 80px; height: 80px;">
                    <i data-lucide="loader-2" class="spin" size="40"></i>
                </div>
                <h3 style="color: #166534;">Membaca File dari Drive...</h3>
                <p style="color: #166534;">${fileName}</p>
            `;
            lucide.createIcons();

            google.script.run
                .withSuccessHandler((response) => {
                    driveCard.innerHTML = originalContent;
                    lucide.createIcons();

                    if (response.success) {
                        renderTransactions(response.data);
                        document.getElementById('extractionInfo').innerText = `Ditemukan ${response.data.length} transaksi dari Excel: ${fileName}`;
                        showView('manage-view', document.querySelector('.nav-item[onclick*="manage-view"]'));
                    } else {
                        alert("Gagal memproses file Excel: " + response.error);
                    }
                })
                .processExcelByFileId(fileId);
        }
    </script>
    <style>
        .spin {
            animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</body>

</html>